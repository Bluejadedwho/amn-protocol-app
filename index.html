<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>The Protocol</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#000000">

  <link rel="icon" type="image/png" href="icon.png">
  <link rel="apple-touch-icon" href="icon.png">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* --- DESIGN SYSTEM (FROM v9) --- */
    :root {
      --bg-color: #000000;
      --card-bg: #1C1C1E;
      --text-primary: #FFFFFF;
      --text-secondary: #8E8E93;
      --accent-color: #30D158; /* Apple Health Green */
      --accent-blue: #0A84FF;
      --danger-red: #FF453A;
      --lab-purple: #BF5AF2;
      --font-family: 'Inter', sans-serif;
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-primary);
      font-family: var(--font-family);
      margin: 0;
      padding: 20px;
      padding-top: env(safe-area-inset-top, 20px);
      -webkit-font-smoothing: antialiased;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
      user-select: none;
    }

    #app-container {
      max-width: 480px;
      width: 100%;
      margin: 0 auto;
      flex-grow: 1;
      position: relative;
    }

    .hero-icon, .header-icon, .menu-icon { border-radius: 50%; object-fit: cover; }

    /* --- VIEW MANAGEMENT --- */
    .view { display: none; animation: fadeIn 0.4s ease; }
    .view.active { display: block; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* --- THE SPLASH CURTAIN --- */
    #splash-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #000000;
      z-index: 10010;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      transition: opacity 0.6s ease, visibility 0.6s;
      padding: 20px;
    }
    #splash-overlay.fade-out {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    @keyframes floatAndShimmer {
      0% { transform: translateY(0px); filter: brightness(100%) drop-shadow(0 0 10px rgba(48, 209, 88, 0.2)); }
      50% { transform: translateY(-15px); filter: brightness(130%) drop-shadow(0 0 25px rgba(48, 209, 88, 0.6)); }
      100% { transform: translateY(0px); filter: brightness(100%) drop-shadow(0 0 10px rgba(48, 209, 88, 0.2)); }
    }
    .hero-icon {
      height: 120px;
      width: 120px;
      margin-bottom: 30px;
      border: 2px solid var(--accent-color);
      animation: floatAndShimmer 4s ease-in-out infinite;
    }
    .enter-btn {
      background: var(--accent-color);
      color: black;
      border: none;
      padding: 16px 50px;
      border-radius: 30px;
      font-size: 1.1rem;
      font-weight: 800;
      margin-top: 40px;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: transform 0.2s;
      box-shadow: 0 0 20px rgba(48, 209, 88, 0.3);
    }
    .enter-btn:active { transform: scale(0.95); }

    header { margin-bottom: 20px; display: flex; align-items: center; }

    .back-btn {
      background: none;
      border: none;
      color: var(--accent-blue);
      font-size: 1.1rem;
      font-weight: 600;
      padding: 0;
      margin-right: 15px;
      cursor: pointer;
    }

    .header-icon { height: 40px; width: 40px; margin-right: 15px; border: 1px solid #333; }

    h1 {
      margin: 0;
      font-weight: 800;
      font-size: 1.4rem;
      letter-spacing: -0.5px;
      line-height: 1.25;
      text-transform: uppercase;
    }
    h2 { margin: 0; font-weight: 800; }

    .logo-area {
      text-align: center;
      margin-bottom: 30px;
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .menu-icon { height: 80px; width: 80px; margin-bottom: 20px; border: 1px solid #333; }

    .title-sub {
      color: var(--text-secondary);
      margin-top: 12px;
      font-size: 0.85rem;
      line-height: 1.4;
      max-width: 320px;
      margin-left: auto;
      margin-right: auto;
    }

    .profile-select { display: flex; flex-direction: column; gap: 15px; margin-bottom: 30px; }

    .card-btn {
      background: var(--card-bg);
      border: 1px solid #333;
      color: white;
      width: 100%;
      padding: 25px;
      border-radius: 16px;
      text-align: left;
      cursor: pointer;
      transition: transform 0.1s;
    }
    .card-btn:active { transform: scale(0.98); }
    .card-btn h2 { font-size: 1.2rem; margin-bottom: 4px; }
    .card-btn p { margin: 0; color: var(--text-secondary); font-size: 0.9rem; }

    details {
      background-color: var(--card-bg);
      border: 1px solid #333;
      border-radius: 16px;
      margin-top: 20px;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    details.lab-folder { border: 1px solid var(--lab-purple); }

    summary {
      padding: 18px 15px;
      cursor: pointer;
      font-weight: 700;
      color: var(--accent-color);
      display: flex;
      align-items: center;
      list-style: none;
      font-size: 0.9rem;
    }
    details.lab-folder summary { color: var(--lab-purple); }
    summary::-webkit-details-marker { display: none; }

    summary::before {
      content: "üìÅ";
      margin-right: 12px;
      font-size: 1.2rem;
      filter: grayscale(100%);
      flex-shrink: 0;
    }
    details.lab-folder summary::before { content: "ü©∏"; filter: none; }

    summary::after {
      content: "+";
      margin-left: 10px;
      font-size: 1.2rem;
      color: #555;
      font-weight: 400;
      flex-shrink: 0;
    }
    details[open] summary::after { content: "‚àí"; }

    .summary-text { flex: 1; text-align: center; line-height: 1.35; white-space: normal; }

    .folder-content { padding: 0 15px 20px 15px; background-color: #222; border-top: 1px solid #333; }

    .report-link {
      display: flex;
      align-items: center;
      background: #2C2C2E;
      padding: 15px;
      border-radius: 12px;
      margin-top: 12px;
      text-decoration: none;
      color: white;
      font-weight: 600;
      font-size: 0.9rem;
      transition: background 0.2s;
    }
    .report-link:active { background: #3A3A3C; }
    .report-icon { margin-right: 12px; font-size: 1.2rem; }
    .report-sub { font-size: 0.75rem; color: #8E8E93; font-weight: 400; margin-top: 2px; }

    .card {
      background-color: var(--card-bg);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
    }

    input[type="text"], input[type="number"], input[type="date"], textarea, select {
      background: #2C2C2E;
      border: none;
      border-radius: 8px;
      color: white;
      padding: 12px;
      width: 100%;
      font-size: 16px;
      box-sizing: border-box;
      outline: none;
      font-family: var(--font-family);
    }
    input:focus, textarea:focus, select:focus { border: 1px solid var(--accent-color); }

    .input-row { display: flex; gap: 15px; }
    .input-group { flex: 1; }
    .input-group label { display: block; font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 5px; }

    .checkbox-row {
      display: flex;
      justify-content: space-between;
      padding: 14px 0;
      border-bottom: 1px solid #333;
      align-items: center;
    }
    .checkbox-row:last-child { border-bottom: none; }
    .checkbox-row span { font-weight: 500; }

    input[type="checkbox"] { accent-color: var(--accent-color); width: 24px; height: 24px; cursor: pointer; }

    input[type="range"] { width: 100%; margin: 10px 0; accent-color: var(--accent-blue); cursor: pointer; }
    .slider-header { display: flex; justify-content: space-between; margin-top: 15px; font-size: 0.9rem; }
    .slider-val { font-weight: bold; color: var(--accent-blue); }

    .save-btn {
      background-color: var(--accent-color);
      color: black;
      font-weight: 800;
      width: 100%;
      padding: 18px;
      border: none;
      border-radius: 16px;
      font-size: 1.1rem;
      margin-bottom: 40px;
      cursor: pointer;
      box-shadow: 0 0 15px rgba(48, 209, 88, 0.3);
    }

    .streak-badge {
      background: #333;
      padding: 5px 12px;
      border-radius: 12px;
      font-size: 0.9rem;
      color: var(--accent-color);
      margin-left: auto;
    }

    .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider.round { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #3a3a3c; transition: .4s; border-radius: 34px; }
    .slider.round:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--danger-red); }
    input:checked + .slider:before { transform: translateX(22px); }

    .lab-save-btn { background-color: var(--lab-purple); color: white; font-weight: 700; width: 100%; padding: 12px; border: none; border-radius: 12px; margin-top: 20px; cursor: pointer; }
    .safety-save-btn { background-color: var(--danger-red); color: white; font-weight: 700; width: 100%; padding: 12px; border: none; border-radius: 12px; margin-top: 20px; cursor: pointer; }

    .hidden-box { display: none; margin-top: 15px; border-top: 1px solid #333; padding-top: 15px; }
    .visible-box { display: block; animation: slideDown 0.3s ease; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

    .history-list { margin-top: 20px; border-top: 1px solid #444; padding-top: 10px; }
    .history-item { background: #2C2C2E; margin-bottom: 8px; border-radius: 8px; overflow: hidden; }
    .history-summary { padding: 12px; display: flex; justify-content: space-between; font-size: 0.9rem; font-weight: 600; cursor: pointer; color: #E0E0E0; }
    .history-details { padding: 10px 12px; background: #1c1c1e; font-size: 0.85rem; color: #AAA; border-top: 1px solid #444; line-height: 1.6; display: none; }
    .history-item.open .history-details { display: block; }

    .pill-row { display:flex; gap:10px; margin-top:10px; }
    .pill-btn {
      background:#2C2C2E;
      border:1px solid #333;
      color:white;
      padding:10px 12px;
      border-radius:12px;
      font-weight:700;
      cursor:pointer;
      text-align:center;
      font-size:0.9rem;
    }
    .pill-btn.active { border-color: var(--accent-blue); }

    .mini-btn {
      background: rgba(10, 132, 255, 0.14);
      border: 1px solid rgba(10, 132, 255, 0.35);
      color: var(--accent-blue);
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 800;
      letter-spacing: 0.2px;
      width: 100%;
      cursor: pointer;
      margin-top: 12px;
    }
    .mini-btn:active { transform: scale(0.99); }

    .event-list { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
    .event-item { border: 1px solid #2f2f32; border-radius: 14px; padding: 12px; background: rgba(255,255,255,0.02); }
    .event-item .row { display: flex; gap: 10px; }
    .event-item .row .input-group { flex: 1; }
    .event-item .remove-btn {
      background: transparent;
      border: 1px solid #444;
      color: var(--text-secondary);
      border-radius: 10px;
      padding: 8px 10px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
    }

    /* Splash overview modal */
    .read-overview-btn {
      margin-top: 12px;
      background: transparent;
      color: rgba(255,255,255,0.85);
      border: 1px solid rgba(255,255,255,0.25);
      border-radius: 12px;
      padding: 10px 14px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      max-width: 320px;
    }
    .read-overview-btn:hover { border-color: rgba(255,255,255,0.45); }

    #overview-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.72);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 11000;
      padding: 18px;
    }
    #overview-modal .modal-card {
      width: 100%;
      max-width: 720px;
      background: rgba(16,16,16,0.95);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 16px;
      padding: 18px 18px 14px;
      max-height: 82vh;
      overflow: hidden;
      box-shadow: 0 12px 35px rgba(0,0,0,0.55);
    }
    #overview-modal .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }
    #overview-modal .modal-title { font-size: 1.05rem; font-weight: 800; letter-spacing: 0.02em; }
    #overview-modal .modal-close {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.18);
      color: rgba(255,255,255,0.85);
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
      font-weight: 700;
    }
    #overview-modal .modal-body {
      overflow: auto;
      max-height: calc(82vh - 64px);
      padding-right: 6px;
    }
    #overview-modal .modal-body p {
      color: rgba(255,255,255,0.82);
      line-height: 1.6;
      margin: 10px 0;
      font-size: 0.96rem;
    }

    /* Deterministic hidden */
    .hidden { display: none !important; }
    .view { display: block; }
    .view:not(.active) { display: none; }

    .build-badge {
      position: fixed;
      right: 10px;
      bottom: 10px;
      font-size: 12px;
      opacity: 0.6;
      z-index: 9999;
    }

    /* Export modal (range picker) */
    #export-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.72);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 12000;
      padding: 18px;
    }
    #export-modal .modal-card {
      width: 100%;
      max-width: 540px;
      background: rgba(16,16,16,0.95);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 12px 35px rgba(0,0,0,0.55);
    }
    #export-modal .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }
    #export-modal .modal-title {
      font-size: 1.05rem;
      font-weight: 800;
      letter-spacing: 0.02em;
    }
    #export-modal .modal-close {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.18);
      color: rgba(255,255,255,0.85);
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
      font-weight: 700;
    }
    #export-modal .modal-body {
      margin-top: 10px;
    }
    #export-modal .row2 {
      display: flex;
      gap: 12px;
      margin-top: 10px;
    }
    #export-modal .row2 .input-group { flex: 1; }
    #export-modal .helper {
      color: rgba(255,255,255,0.65);
      font-size: 0.85rem;
      line-height: 1.4;
      margin-top: 8px;
    }
    #export-run-btn { margin-top: 14px; }
  
#trends-charts-pane canvas{ width:100% !important; height:220px !important; display:block; }
</style>

  <script>
    function byId(id){ return document.getElementById(id); }
    function safeAdd(el, cls){ if(el && cls) el.classList.add(cls); }
    function safeRemove(el, cls){ if(el && cls) el.classList.remove(cls); }

    window.setActiveView = function(viewId) {
      ['selection-view','patrick-view','nieve-view','trends-view'].forEach(id => {
        const el = byId(id);
        if (!el) return;
        safeRemove(el, 'active');
        safeAdd(el, 'hidden');
      });
      const target = byId(viewId);
      if (target) {
        safeAdd(target, 'active');
        safeRemove(target, 'hidden');
      }
      window.scrollTo(0,0);
    };

    window.enterApp = function() {
      const splash = byId('splash-overlay');
      if (splash) {
        safeAdd(splash, 'fade-out');
        setTimeout(() => { splash.style.display = 'none'; }, 700);
      }
      window.setActiveView('selection-view');
    };

    window.selectProfile = function(profile) {
      window.ACTIVE_PROFILE = profile;
      if (profile === 'patrick') {
        window.setActiveView('patrick-view');
        const dateP = byId('date-display-p');
        if (dateP) dateP.innerText = new Date().toDateString();
      } else if (profile === 'nieve') {
        window.setActiveView('nieve-view');
      }
    };

    window.goBack = function() {
      const trends = byId('trends-view');
      if (trends && trends.classList.contains('active')) {
        window.setActiveView('patrick-view');
        return;
      }
      window.setActiveView('selection-view');
    };

    window.openTrends = function() {
      window.setActiveView('trends-view');
      if (typeof window.renderTrends === "function") window.renderTrends();
    };

    window.toggleOverview = function(show) {
      const m = byId('overview-modal');
      if(m) m.style.display = show ? 'flex' : 'none';
    };

    // ---------------------------
    // Export modal helpers (range picker)
    // ---------------------------
    function toISODate(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }

    // Normalize date input into YYYY-MM-DD (helps when browsers return MM/DD/YYYY for <input type="date">).
    function normalizeDateInput(val){
      if(!val) return '';
      const s = String(val).trim();
      if(!s) return '';
      // Already ISO
      if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
      // MM/DD/YYYY or DD/MM/YYYY (we assume MM/DD based on your UI)
      const m1 = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if(m1){
        const mm = String(m1[1]).padStart(2,'0');
        const dd = String(m1[2]).padStart(2,'0');
        const yyyy = m1[3];
        return `${yyyy}-${mm}-${dd}`;
      }
      // Try Date parsing as a fallback
      const d = new Date(s);
      if(!isNaN(d.getTime())) return toISODate(d);
      return '';
    }

    window.openExportModal = function(target){
      // target: { patientId: 'patrick'|'nieve', label: 'Pilot'|'Passenger' }
      window.__EXPORT_TARGET = target;
      const modal = byId('export-modal');
      const title = byId('export-title');
      const start = byId('export-start');
      const end = byId('export-end');
      const order = byId('export-order');

      if(title) title.textContent = `Export ${target?.label || 'History'} (PDF)`;
      const today = new Date();
      const startD = new Date();
      startD.setDate(today.getDate() - 29); // inclusive 30-day window
      // Always reset defaults on open so prior attempts don't leave stale dates.
      if(start) start.value = toISODate(startD);
      if(end) end.value = toISODate(today);
      if(order && !order.value) order.value = 'desc';

      if(modal) modal.style.display = 'flex';
    };

    window.closeExportModal = function(){
      const modal = byId('export-modal');
      if(modal) modal.style.display = 'none';
    };

    window.runExportFromModal = async function(){
      const target = window.__EXPORT_TARGET || { patientId: 'patrick', label: 'Pilot' };
      const startRaw = byId('export-start')?.value;
      const endRaw = byId('export-end')?.value;
      const dir = byId('export-order')?.value || 'desc';
      const start = normalizeDateInput(startRaw);
      const end = normalizeDateInput(endRaw);
      if(!start || !end){ alert('Please select a start and end date.'); return; }
      if(start > end){ alert('Start date must be on or before end date.'); return; }

      // Delegate to module-export function if available.
      if(typeof window.__EXPORT_RUN !== 'function'){
        alert('Export is not ready yet (export module not loaded).');
        return;
      }

      const btn = byId('export-run-btn');
      if(btn){ btn.disabled = true; btn.textContent = 'GENERATING...'; }
      try{
        await window.__EXPORT_RUN({ patientId: target.patientId, label: target.label, start, end, dir });
        window.closeExportModal();
      } catch(e){
        console.error(e);
        alert('Export failed. Check console for details.');
      } finally {
        if(btn){ btn.disabled = false; btn.textContent = 'Generate PDF'; }
      }
    };

    window.updateSlider = function(element) {
      try { element.previousElementSibling.querySelector('.slider-val').innerText = element.value; } catch(e) {}
      if (!element.max) return;
      var min = parseFloat(element.min || "0");
      var max = parseFloat(element.max || "100");
      var val = parseFloat(element.value || "0");
      var pct = ((val - min) / (max - min)) * 100;
      element.style.background = "linear-gradient(to right, var(--accent-blue) 0%, var(--accent-blue) " + pct + "%, #444 " + pct + "%, #444 100%)";
    };

    window.toggleSafetyBox = function() {
      const checkBox = byId("n-safety");
      const box = byId("n-safety-box");
      if (!checkBox || !box) return;
      if (checkBox.checked) {
        box.classList.add("visible-box");
        box.style.display = "block";
      } else {
        box.classList.remove("visible-box");
        box.style.display = "none";
      }
    };

    window.resetPilotForm = function() {
      const form = byId("patrick-form");
      if (!form) return;
      form.reset();
      const adv = document.getElementById('p-adverse-events'); if (adv) adv.innerHTML = '';
      const pos = document.getElementById('p-positive-events'); if (pos) pos.innerHTML = '';
      // refresh slider labels
      Array.from(form.querySelectorAll('input[type="range"]')).forEach(r => window.updateSlider(r));
      window.scrollTo(0,0);
    };
  </script>
</head>
<body>

  <div id="splash-overlay">
    <img src="icon.png" alt="Pioneer Icon" class="hero-icon">
    <h1>THE AMN DUAL-MECHANISM<br>SUPPORT PROTOCOL</h1>
    <p class="title-sub">A Structured Approach to Axonal Preservation<br>and Exploratory Myelin Support</p>

    <button class="enter-btn" onclick="window.enterApp()">Enter Protocol</button>
    <button id="read-overview-btn" class="read-overview-btn" type="button" onclick="window.toggleOverview(true)">Why this protocol exists</button>
  </div>

  <div id="overview-modal" role="dialog" aria-modal="true" aria-labelledby="overview-title">
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title" id="overview-title">What this protocol is</div>
        <button type="button" class="modal-close" id="overview-close" onclick="window.toggleOverview(false)">Close</button>
      </div>
      <div class="modal-body" id="overview-content">
        <p><strong>Purpose.</strong> This protocol is a structured way to test whether function in adrenomyeloneuropathy can be made more stable and reliable by reducing biological stress on vulnerable pathways.</p>
        <p><strong>What it is not.</strong> It does not claim a cure, reversal of established damage, or forced regeneration. The working target is <em>margin</em>: preserving what remains and reducing secondary injury.</p>
        <p><strong>Why this is different from typical symptom-only care.</strong> Many neurological treatments primarily reduce symptoms downstream (often via CNS suppression) without changing the underlying strain on the system. This approach focuses on environment optimization: oxidative load, metabolic reliability, inflammatory pressure, hydration and electrolytes, and other destabilizing factors that can narrow conduction safety margin.</p>
        <p><strong>How we know whether it helps.</strong> The app tracks repeatable functional tests and symptom domains over time, with confounder overlays (sleep, illness, missed doses, hydration/electrolytes, nutrition adequacy, stress). Trends matter more than single days.</p>
        <p><strong>What success looks like.</strong> Stability over time, fewer setbacks, preserved capacity, and modest but real functional gains. In neurology, stopping progression and achieving even mild functional improvement is a meaningful outcome.</p>
      </div>
    </div>
  </div>

  <!-- Export Modal (PDF Range Picker) -->
  <div id="export-modal" role="dialog" aria-modal="true" aria-labelledby="export-title">
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title" id="export-title">Export History (PDF)</div>
        <button type="button" class="modal-close" onclick="window.closeExportModal()">Close</button>
      </div>
      <div class="modal-body">
        <div class="row2">
          <div class="input-group">
            <label>Start date</label>
            <input type="date" id="export-start">
          </div>
          <div class="input-group">
            <label>End date</label>
            <input type="date" id="export-end">
          </div>
        </div>

        <div class="input-group" style="margin-top:10px;">
          <label>Sort order</label>
          <select id="export-order">
            <option value="desc" selected>Newest first</option>
            <option value="asc">Oldest first</option>
          </select>
        </div>

        <div class="helper">Defaults to the last 30 days. You can export any custom range.</div>

        <button type="button" class="lab-save-btn" id="export-run-btn" onclick="window.runExportFromModal()">Generate PDF</button>
      </div>
    </div>
  </div>

  <div id="app-container">

    <section id="selection-view" class="view active">
      <div class="logo-area">
        <img src="icon.png" alt="Pioneer Icon" class="menu-icon">
        <h1>THE AMN DUAL-MECHANISM<br>SUPPORT PROTOCOL</h1>
        <p class="title-sub">A Structured Approach to Axonal Preservation<br>and Exploratory Myelin Support</p>
      </div>

      <div class="card" id="auth-card" style="margin-top:10px; margin-bottom:20px;">
        <h3 style="margin-top:0;">Account</h3>
        <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
          <div style="font-size:0.9rem; color:var(--text-secondary); line-height:1.4;">
            <div id="auth-status" style="color:white; font-weight:700;">Not signed in</div>
            <div id="auth-email" style="margin-top:4px;"></div>
          </div>
          <div style="flex:1;"></div>
        </div>
        <button type="button" class="lab-save-btn" id="auth-signin-btn" onclick="window.beginSignIn()" style="margin-top:12px;">Sign in with Google</button>
        <button type="button" class="mini-btn" id="auth-signout-btn" onclick="window.beginSignOut()" style="margin-top:12px; display:none;">Sign out</button>
      </div>


      <div class="profile-select">
        <button class="card-btn" onclick="window.selectProfile('patrick')">
          <h2>The Pilot</h2>
          <p>Patrick ‚Ä¢ Safety & Margin Protocol</p>
        </button>
        <button class="card-btn" onclick="window.selectProfile('nieve')">
          <h2>The Passenger</h2>
          <p>Nieve ‚Ä¢ Prophylactic Protocol</p>
        </button>
      </div>

      <details>
        <summary>
          <div class="summary-text">Protocol Context<br>& References</div>
        </summary>
        <div class="folder-content">
          <a href="https://elastic-amn-protocol.netlify.app/docs/amn-family-overview.pdf" class="report-link" target="_blank" rel="noopener">
            <span class="report-icon">üßë‚Äçüë©‚Äçüëß‚Äçüë¶</span>
            <div>
              <div>AMN Protocol ‚Äì Family Overview</div>
              <div class="report-sub">Plain-language overview</div>
            </div>
          </a>
          <a href="https://elastic-amn-protocol.netlify.app/docs/amn-clinical-reference.pdf" class="report-link" target="_blank" rel="noopener">
            <span class="report-icon">ü©∫</span>
            <div>
              <div>AMN Protocol ‚Äì Clinical Reference</div>
              <div class="report-sub">Technical reference</div>
            </div>
          </a>
          <a href="https://elastic-amn-protocol.netlify.app/docs/functional-recovery-amn.pdf" class="report-link" target="_blank" rel="noopener">
            <span class="report-icon">üß†</span>
            <div>
              <div>A Phenotype-Specific Framework for Functional Change in AMN</div>
              <div class="report-sub">Case framework</div>
            </div>
          </a>
          <a href="https://elastic-amn-diagrams.netlify.app/" class="report-link" target="_blank" rel="noopener">
            <span class="report-icon">üîç</span>
            <div>
              <div>Functional Outcome Interpretation</div>
              <div class="report-sub">Interactive logic tool</div>
            </div>
          </a>
        </div>
      </details>
    </section>

    <!-- PILOT VIEW (FULL TRACKING RESTORED) -->
    <section id="patrick-view" class="view hidden">
      <header>
        <button class="back-btn" onclick="window.goBack()">‚Üê Back</button>
        <img src="icon.png" alt="Pioneer Icon" class="header-icon">
        <h2>The Pilot</h2>
      </header>

      <p style="color:var(--text-secondary); font-size:0.75rem; margin-top:4px; line-height:1.4;">
        Trends help with interpretation over time but do not prove causation or confirm underlying mechanisms.
      </p>

      <p style="color:var(--text-secondary); margin-bottom:20px; font-size:0.9rem;" id="date-display-p"></p>

      <form id="patrick-form">


        <details style="margin-bottom: 20px; margin-top: 0;">
          <summary>
            <div class="summary-text">
              Protocol Context<br>& References
            </div>
          </summary>
          <div class="folder-content">
            <a href="https://elastic-amn-protocol.netlify.app/docs/amn-family-overview.pdf" class="report-link" target="_blank" rel="noopener">
              <span class="report-icon">üßë‚Äçüë©‚Äçüëß‚Äçüë¶</span>
              <div>
                <div>AMN Protocol ‚Äì Family Overview</div>
                <div class="report-sub">Plain-language overview</div>
              </div>
            </a>
            <a href="https://elastic-amn-protocol.netlify.app/docs/amn-clinical-reference.pdf" class="report-link" target="_blank" rel="noopener">
              <span class="report-icon">ü©∫</span>
              <div>
                <div>AMN Protocol ‚Äì Clinical Reference</div>
                <div class="report-sub">Technical reference</div>
              </div>
            </a>
            <a href="https://elastic-amn-protocol.netlify.app/docs/functional-recovery-amn.pdf" class="report-link" target="_blank" rel="noopener">
              <span class="report-icon">üß†</span>
              <div>
                <div>A Phenotype-Specific Framework for Functional Change in AMN</div>
                <div class="report-sub">Case framework</div>
              </div>
            </a>
            <a href="https://elastic-amn-diagrams.netlify.app/" class="report-link" target="_blank" rel="noopener">
              <span class="report-icon">üîç</span>
              <div>
                <div>Functional Outcome Interpretation</div>
                <div class="report-sub">Interactive logic tool</div>
              </div>
            </a>
          </div>
        </details>

        <!-- Labs folder (kept) -->
        <details class="lab-folder" style="margin-bottom: 20px; margin-top: 0;">
          <summary>
            <div class="summary-text" style="color:#BF5AF2;">
              Periodic Lab Results<br>(VLCFA & Liver)
            </div>
          </summary>
          <div class="folder-content">
            <div class="input-group" style="margin-bottom:15px;">
              <label>Date of Test</label>
              <input type="date" id="lab-date">
            </div>
            <div class="input-row">
              <div class="input-group">
                <label>VLCFA (C26:0)</label>
                <input type="text" id="lab-vlcfa" placeholder="e.g. 1.25">
              </div>
              <div class="input-group">
                <label>Liver (ALT/AST)</label>
                <input type="text" id="lab-liver" placeholder="e.g. 25 / 30">
              </div>
            </div>
            <div class="input-group" style="margin-top:15px;">
              <label>Notes</label>
              <textarea id="lab-notes" rows="2" placeholder="Specific details..."></textarea>
            </div>
            <button type="button" class="lab-save-btn" id="lab-save-results-btn" onclick="window.handleLabSave()">SAVE LAB RESULTS ONLY</button>
            <div id="lab-history-list" class="history-list"></div>
          </div>
        </details>

        <div class="card">
          <h3>Morning Vitals</h3>
          <div class="input-row">
            <div class="input-group">
              <label>BP (Sys/Dia)</label>
              <input type="text" id="p-morning-bp" placeholder="120/80">
            </div>
            <div class="input-group">
              <label>HR (bpm)</label>
              <input type="number" id="p-morning-hr" placeholder="60">
            </div>
          </div>
        </div>

        <div class="card">
          <h3>Daily Protocol</h3>
          <label class="checkbox-row"><span>Nervonic Acid (1g)</span><input type="checkbox" id="p-nervonic" checked></label>
          <label class="checkbox-row"><span>Missed NA dose today</span><input type="checkbox" id="p-na-missed"></label>
          <label class="checkbox-row"><span>NAC (2.4g)</span><input type="checkbox" id="p-nac"></label>
          <label class="checkbox-row"><span>R-ALA (425mg)</span><input type="checkbox" id="p-ala"></label>
          <label class="checkbox-row"><span>Vit E (Mixed - 400IU)</span><input type="checkbox" id="p-vite"></label>
        </div>

        <div class="card">
          <h3>Energy / Capacity</h3>
          <div class="slider-header"><label>Usable energy / capacity (10 = best)</label><span class="slider-val">5</span></div>
          <input type="range" id="p-energy-capacity" min="0" max="10" value="5" oninput="window.updateSlider(this)">
          <div class="input-group" style="margin-top:12px;">
            <label>Confidence</label>
            <select id="p-energy-confidence">
              <option value="">Select</option>
              <option value="low">Low</option>
              <option value="medium">Medium</option>
              <option value="high">High</option>
            </select>
          </div>
        </div>

        <div class="card">
          <h3>Global Baseline Rating</h3>
          <div class="input-row">
            <div class="input-group">
              <label>Compared to my usual baseline, today was</label>
              <select id="p-global-rating">
                <option value="">Select</option>
                <option value="much_worse">Much worse</option>
                <option value="worse">Worse</option>
                <option value="same">About the same</option>
                <option value="better">Better</option>
                <option value="much_better">Much better</option>
              </select>
            </div>
            <div class="input-group">
              <label>Confidence</label>
              <select id="p-global-confidence">
                <option value="">Select</option>
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
              </select>
            </div>
          </div>
        </div>


        <div class="card">
          <h3>Fast Markers</h3>
          <label class="checkbox-row"><span>Near-fall or balance scare</span><input type="checkbox" id="p-fast-nearfall"></label>
          <label class="checkbox-row"><span>Leg locking episode</span><input type="checkbox" id="p-fast-locking"></label>
          <label class="checkbox-row"><span>Spasm or clonus episode</span><input type="checkbox" id="p-fast-spasm"></label>
          <label class="checkbox-row"><span>Night pain woke me</span><input type="checkbox" id="p-fast-nightpain"></label>
          <label class="checkbox-row"><span>Restless legs at night</span><input type="checkbox" id="p-fast-restless"></label>
        </div>

        <div class="card">
          <h3>Pain Impact</h3>
          <div class="slider-header"><label>Pain impact (10 = Dominated the day)</label><span class="slider-val">0</span></div>
          <input type="range" id="p-painimpact" min="0" max="10" value="0" oninput="window.updateSlider(this)">
          <div style="margin-top:10px; font-size:0.85rem; color:var(--text-secondary);">Interference</div>
          <label class="checkbox-row"><span>Interfered with sleep</span><input type="checkbox" id="p-pain-sleep"></label>
          <label class="checkbox-row"><span>Limited walking</span><input type="checkbox" id="p-pain-walk"></label>
          <label class="checkbox-row"><span>Forced extra rest breaks</span><input type="checkbox" id="p-pain-rest"></label>
          <label class="checkbox-row"><span>Required additional meds or rescue</span><input type="checkbox" id="p-pain-meds"></label>
          <label class="checkbox-row"><span>Changed gait mechanics</span><input type="checkbox" id="p-pain-gait"></label>
          <div class="input-group" style="margin-top:15px;">
            <label>Primary pain driver today</label>
            <select id="p-pain-location">
              <option value="">Select</option>
              <option value="piriformis_glute">Piriformis or glute</option>
              <option value="low_back">Low back</option>
              <option value="hip">Hip</option>
              <option value="thigh">Thigh</option>
              <option value="calf">Calf</option>
              <option value="foot">Foot</option>
              <option value="other">Other</option>
            </select>
          </div>
        </div>

        <div class="card">
          <h3>Context: What changed today?</h3>
          <label class="checkbox-row"><span>Poor sleep last night</span><input type="checkbox" id="p-conf-sleep"></label>
          <label class="checkbox-row"><span>Unusual physical exertion</span><input type="checkbox" id="p-conf-exertion"></label>
          <label class="checkbox-row"><span>Medication timing change</span><input type="checkbox" id="p-conf-medtiming"></label>
          <label class="checkbox-row"><span>Dose change</span><input type="checkbox" id="p-conf-dosechange"></label>
          <label class="checkbox-row"><span>Missed dose</span><input type="checkbox" id="p-conf-misseddose"></label>
          <label class="checkbox-row"><span>New supplement / med</span><input type="checkbox" id="p-conf-newsupp"></label>
          <label class="checkbox-row"><span>Travel or disrupted schedule</span><input type="checkbox" id="p-conf-travel"></label>
          <div class="input-group" style="padding:14px 0; border-bottom:1px solid #333;">
            <label>High stress (0‚Äì3)</label>
            <input type="number" id="p-conf-stress" min="0" max="3" placeholder="0 to 3">
          </div>
          <label class="checkbox-row"><span>Infection symptoms</span><input type="checkbox" id="p-conf-infection"></label>
          <label class="checkbox-row"><span>GI upset or dehydration risk</span><input type="checkbox" id="p-conf-gi"></label>
          <label class="checkbox-row"><span>Nothing unusual</span><input type="checkbox" id="p-conf-none"></label>
        </div>

        <div class="card">
          <h3>Wins today</h3>
          <textarea id="p-wins" rows="2" placeholder="Example: Less stiffness on first stand. Walk felt smoother. Only up once overnight."></textarea>
        </div>


        <div class="card">
          <h3>Positive events (optional)</h3>
          <p style="color:var(--text-secondary); margin-top:8px; font-size:0.9rem; line-height:1.5;">
            Use this if something clearly improved during a specific window. Mirrors adverse events for later analysis.
          </p>
          <div id="p-positive-events" class="event-list"></div>
          <button type="button" class="mini-btn" id="p-add-positive-event" onclick="window.addPositiveEvent()">+ Add positive event</button>
        </div>

        <details style="margin-bottom: 20px; margin-top: 0;">
          <summary>
            <div class="summary-text">
              Functional Tests<br>(Weekly or Monthly Anchors)
            </div>
          </summary>
          <div class="folder-content">
            <p style="color:#9a9a9f; font-size:0.85rem; line-height:1.45; margin: 0 0 14px 0;">
              Optional objective anchors. Use the same setup each time for comparability.
            </p>

            <details style="margin-top: 0;">
              <summary>
                <div class="summary-text" style="color: var(--text-secondary); font-weight:700;">
                  Protocol Reminders
                </div>
              </summary>
              <div class="folder-content">
                <p style="margin:0; color:#9a9a9f; font-size:0.85rem; line-height:1.5;">
                  <strong>6-Minute Walk Test</strong><br>
                  Same route and course length each time. Same assistive device and shoes if possible. Similar time of day.
                  Stop if unsafe. Record rest breaks honestly.<br><br>
                  <strong>5x Sit-to-Stand</strong><br>
                  Same chair and chair height. Decide once whether arms are allowed and keep it consistent. Same footwear.
                  Fully stand and fully sit each repetition.
                </p>
              </div>
            </details>

            <div class="input-group" style="margin-top:15px;">
              <label>Test Date</label>
              <input type="date" id="ft-date">
            </div>

            <div class="card" style="margin-top: 15px;">
              <h3>6-Minute Walk Test</h3>
              <div class="input-row">
                <div class="input-group">
                  <label>Distance (meters)</label>
                  <input type="number" id="ft-6m-distance" placeholder="e.g. 220">
                </div>
                <div class="input-group">
                  <label>Rest breaks (count)</label>
                  <input type="number" id="ft-6m-restbreaks" placeholder="e.g. 1">
                </div>
              </div>
              <div class="input-row" style="margin-top:12px;">
                <div class="input-group">
                  <label>Assistive device</label>
                  <select id="ft-6m-device">
                    <option value="">Select</option>
                    <option value="none">None</option>
                    <option value="cane">Cane</option>
                    <option value="walker">Walker</option>
                    <option value="crutches">Crutches</option>
                    <option value="other">Other</option>
                  </select>
                </div>
                <div class="input-group">
                  <label>Course length (meters)</label>
                  <input type="number" id="ft-6m-course" placeholder="e.g. 20">
                </div>
              </div>
              <div class="input-group" style="margin-top:12px;">
                <label>Perceived exertion (0-10)</label>
                <input type="number" id="ft-6m-rpe" min="0" max="10" placeholder="0 to 10">
              </div>
            </div>

            <div class="card">
              <h3>5x Sit-to-Stand</h3>
              <div class="input-row">
                <div class="input-group">
                  <label>Time (seconds)</label>
                  <input type="number" id="ft-5x-time" step="0.1" placeholder="e.g. 18.4">
                </div>
                <div class="input-group">
                  <label>Used arms?</label>
                  <select id="ft-5x-arms">
                    <option value="">Select</option>
                    <option value="no">No</option>
                    <option value="yes">Yes</option>
                  </select>
                </div>
              </div>
              <div class="input-group" style="margin-top:12px;">
                <label>Chair height (cm, optional)</label>
                <input type="number" id="ft-5x-chair" placeholder="e.g. 45">
              </div>
            </div>

            <div class="input-group" style="margin-top:12px;">
              <label>Notes</label>
              <textarea id="ft-notes" rows="2" placeholder="Anything notable about setup, pain, fatigue, or conditions"></textarea>
            </div>

            <button type="button" class="lab-save-btn" style="margin-top:14px;" onclick="window.saveFunctionalTest()">SAVE FUNCTIONAL TEST</button>
            <div id="ft-history-list" class="history-list"></div>
          </div>
        </details>


        <div class="card">
          <h3>Symptom Drift (0-10)</h3>
          <div class="slider-header"><label>Brain Fog (10 = Worst)</label><span class="slider-val">0</span></div>
          <input type="range" id="p-fog" min="0" max="10" value="0" oninput="window.updateSlider(this)">

          <div class="slider-header"><label>Gait Effort (10 = Hardest)</label><span class="slider-val">0</span></div>
          <input type="range" id="p-gait" min="0" max="10" value="0" oninput="window.updateSlider(this)">

          <div class="slider-header"><label>Gait initiation effort (10 = Hardest)</label><span class="slider-val">0</span></div>
          <input type="range" id="p-gait-init" min="0" max="10" value="0" oninput="window.updateSlider(this)">

          <div class="slider-header"><label>Sustained walking effort (10 = Hardest)</label><span class="slider-val">0</span></div>
          <input type="range" id="p-gait-sustain" min="0" max="10" value="0" oninput="window.updateSlider(this)">

          <div class="slider-header"><label>Neurologic fatigue (10 = Wiped out)</label><span class="slider-val">0</span></div>
          <input type="range" id="p-fatigue" min="0" max="10" value="0" oninput="window.updateSlider(this)">

          <div class="slider-header"><label>Sleep Quality (10 = Best)</label><span class="slider-val">5</span></div>
          <input type="range" id="p-sleep" min="0" max="10" value="5" oninput="window.updateSlider(this)">

          <div class="slider-header"><label>Leg Stiffness (10 = Rigid)</label><span class="slider-val">0</span></div>
          <input type="range" id="p-stiff" min="0" max="10" value="0" oninput="window.updateSlider(this)">

          <div class="slider-header"><label>Post-rest stiffness (10 = Severe)</label><span class="slider-val">0</span></div>
          <input type="range" id="p-postrest" min="0" max="10" value="0" oninput="window.updateSlider(this)">

          <div class="slider-header"><label>Symptom volatility (10 = Very up and down)</label><span class="slider-val">0</span></div>
          <input type="range" id="p-volatility" min="0" max="10" value="0" oninput="window.updateSlider(this)">
        </div>

        <div class="card">
          <h3>Evening Vitals</h3>
          <div class="input-row">
            <div class="input-group">
              <label>BP (Sys/Dia)</label>
              <input type="text" id="p-evening-bp" placeholder="120/80">
            </div>
            <div class="input-group">
              <label>HR (bpm)</label>
              <input type="number" id="p-evening-hr" placeholder="60">
            </div>
          </div>
        </div>

        <div class="card">
          <h3>Food (optional)</h3>
          <textarea id="p-food-notes" class="notes" placeholder="Brief notes..."></textarea>
        </div>

        <div class="card">
          <h3>Adverse events / notes</h3>
          <div id="p-adverse-events" class="event-list"></div>
          <button type="button" class="mini-btn" id="p-add-adverse-event" onclick="window.addAdverseEvent()">+ Add adverse event</button>
          <div class="input-group" style="margin-top:14px;">
            <label>Notes (optional)</label>
            <textarea id="p-notes" rows="3" placeholder="General notes..."></textarea>
          </div>
        </div>

        <button type="button" class="mini-btn" onclick="window.openTrends()" style="margin-bottom:20px;">VIEW TRENDS & EXPORT PDF</button>

        <button type="button" class="back-btn" style="width:100%; text-align:center; margin: 0 0 14px 0;" onclick="window.resetPilotForm()">Reset today's form</button>
        <button type="button" class="save-btn" id="p-save-log" onclick="window.handlePilotSave()">SAVE DAILY LOG</button>
      </form>
    </section>

    <section id="trends-view" class="view hidden">
      <header>
        <button class="back-btn" onclick="window.goBack()">‚Üê Back</button>
        <img src="icon.png" alt="Pioneer Icon" class="header-icon">
        <h2>Trends</h2>
      </header>

      <div class="card">
        <h3>Trends Mode</h3>
        <div class="pill-row">
          <div class="pill-btn active" id="tab-summary" onclick="window.showTrendsTab('summary')">Summary</div>
          <div class="pill-btn" id="tab-charts" onclick="window.showTrendsTab('charts')">Charts</div>
          <div class="pill-btn" id="tab-details" onclick="window.showTrendsTab('details')">Details</div>
        </div>
      </div>

      <div id="trends-summary-pane">
        <div class="card">
          <h3>Change Detection Summary</h3>
          <button type="button" class="lab-save-btn" id="clinician-export-btn" style="margin-top:12px;" onclick="window.openExportModal({patientId:'patrick', label:'Pilot'})">DOWNLOAD PILOT HISTORY (PDF)</button>
          <div id="change-summary" style="margin-top:12px; font-size:0.9rem; line-height:1.7; color:#E0E0E0;"></div>
        </div>
      </div>

            <div id="trends-charts-pane" style="display:none;">
        <div class="card">
          <h3>Global Baseline Rating</h3>
          <canvas id="chart-global" height="180"></canvas>
        </div>

        <div class="card">
          <h3>Energy / Capacity (0‚Äì10)</h3>
          <canvas id="chart-energy" height="180"></canvas>
        </div>

        <div class="card">
          <h3>Pain Impact (0‚Äì10)</h3>
          <canvas id="chart-pain" height="180"></canvas>
        </div>

        <div class="card">
          <h3>Sleep Quality (0‚Äì10)</h3>
          <canvas id="chart-sleep" height="180"></canvas>
        </div>

        <div class="card">
          <h3>Gait Effort (0‚Äì10)</h3>
          <canvas id="chart-gait-effort" height="180"></canvas>
        </div>

        <div class="card">
          <h3>Leg Stiffness (0‚Äì10)</h3>
          <canvas id="chart-leg-stiffness" height="180"></canvas>
        </div>

        <div class="card">
          <h3>Brain Fog (0‚Äì10)</h3>
          <canvas id="chart-brain-fog" height="180"></canvas>
        </div>

        <div class="card">
          <h3>Neurologic Fatigue (0‚Äì10)</h3>
          <canvas id="chart-neuro-fatigue" height="180"></canvas>
        </div>
      </div>
<div id="trends-details-pane" style="display:none;">
        <div class="card">
          <div class="h2">Tracked Metrics (Details)</div>
          <div class="muted" style="margin-top:8px;">N = number of days with a recorded value for a given metric (non-empty).</div>
          <div id="trends-details-content" style="margin-top:12px;"></div>
        </div>
      </div>

    </section>

    <section id="nieve-view" class="view hidden">
      <header>
        <button class="back-btn" onclick="window.goBack()">‚Üê Back</button>
        <img src="icon.png" alt="Pioneer Icon" class="header-icon">
        <h2>The Passenger</h2>
        <div class="streak-badge"><span id="streak-count">0</span> Day Streak</div>
      </header>

      <form id="nieve-form">
        <div class="card">
          <h3>Daily Protocol</h3>
          <label class="checkbox-row"><span>Nervonic Acid (500mg)</span><input type="checkbox" id="n-nervonic"></label>
          <label class="checkbox-row"><span>NAC (600mg)</span><input type="checkbox" id="n-nac"></label>
          <label class="checkbox-row"><span>ALA (200mg)</span><input type="checkbox" id="n-ala"></label>
          <label class="checkbox-row"><span>Vit E (200IU)</span><input type="checkbox" id="n-vite"></label>
        </div>

        <div class="card">
          <h3>Safety Check</h3>
          <div class="toggle-row" style="display:flex; justify-content:space-between; align-items:center; padding:12px 0;">
            <span>Do you feel different today?</span>
            <label class="switch">
              <input type="checkbox" id="n-safety" onchange="window.toggleSafetyBox()">
              <span class="slider round"></span>
            </label>
          </div>

          <div id="n-safety-box" class="hidden-box">
            <div class="input-group">
              <label style="color:var(--danger-red);">Describe Symptoms</label>
              <textarea id="n-safety-notes" rows="3" placeholder="What feels different?"></textarea>
            </div>
            <button type="button" class="safety-save-btn" onclick="window.handlePassengerSafety()">SUBMIT SAFETY REPORT</button>
          </div>
        </div>

        <div class="card">
          <h3>Notes (optional)</h3>
          <textarea id="n-notes" class="notes" placeholder="Optional notes..."></textarea>
        </div>

        <button type="button" class="mini-btn" id="passenger-export-btn" style="margin-bottom:20px;" onclick="window.openExportModal({patientId:'nieve', label:'Passenger'})">DOWNLOAD HISTORY (PDF)</button>
        <button type="button" class="save-btn" id="n-save-log" onclick="window.handlePassengerSave()">SAVE DAILY LOG</button>
      </form>
    </section>

  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import {
      getFirestore, doc, setDoc, serverTimestamp, enableIndexedDbPersistence,
      collection, query, where, orderBy, limit, getDocs
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult,
      onAuthStateChanged, signOut, setPersistence, browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";


    const firebaseConfig = {
      apiKey: "AIzaSyAtORnHiL5tdDQ1OkRdQhj2PsaW6GzQ3yE",
      authDomain: "pioneer-program.firebaseapp.com",
      projectId: "pioneer-program",
      storageBucket: "pioneer-program.firebasestorage.app",
      messagingSenderId: "773361494367",
      appId: "1:773361494367:web:15aee1471b181413d1eeea"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    enableIndexedDbPersistence(db).catch((err) => {
      console.warn("Firestore persistence not enabled:", err?.code || err);
    });

    
    // ---------------------------
    // AUTH (Google Sign-In)
    // ---------------------------
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // Keep sign-in between sessions if possible.
    setPersistence(auth, browserLocalPersistence).catch(() => {});

    // Global-ish auth state for the rest of the module.
    let AUTH_UID = null;
    let AUTH_EMAIL = null;

    function setAuthUI(signedIn) {
      const badge = document.getElementById("auth-status");
      const emailEl = document.getElementById("auth-email");
      const inBtn = document.getElementById("auth-signin-btn");
      const outBtn = document.getElementById("auth-signout-btn");
      if (badge) badge.textContent = signedIn ? "Signed in" : "Not signed in";
      if (emailEl) emailEl.textContent = signedIn ? (AUTH_EMAIL || "") : "";
      if (inBtn) inBtn.style.display = signedIn ? "none" : "block";
      if (outBtn) outBtn.style.display = signedIn ? "block" : "none";
    }

    async function beginSignIn() {
      // iOS Safari and "Add to Home Screen" PWAs are unreliable with popups.
      // Use redirect there; use popup elsewhere for better UX.
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      const isStandalone = (window.matchMedia && window.matchMedia("(display-mode: standalone)").matches) || window.navigator.standalone === true;

      if (isIOS || isStandalone) {
        await signInWithRedirect(auth, provider);
        return;
      }

      try {
        await signInWithPopup(auth, provider);
      } catch (e) {
        console.warn("Popup sign-in failed; trying redirect.", e?.code || e);
        await signInWithRedirect(auth, provider);
      }
    }

    async function beginSignOut() {
      await signOut(auth);
    }

    // Handle redirect completion (if we used signInWithRedirect).
    getRedirectResult(auth).catch(() => {});

    window.beginSignIn = beginSignIn;
    window.beginSignOut = beginSignOut;

    // Firestore path helpers: everything lives under users/{uid}/{profile}/...
    function requireAuthUid() {
      if (!AUTH_UID) throw new Error("Not signed in.");
      return AUTH_UID;
    }
    function userProfilePath(profile, ...rest) {
      const uid = requireAuthUid();
      return ["users", uid, profile, ...rest];
    }

    onAuthStateChanged(auth, (user) => {
      if (user) {
        AUTH_UID = user.uid;
        AUTH_EMAIL = user.email || null;
        setAuthUI(true);
      } else {
        AUTH_UID = null;
        AUTH_EMAIL = null;
        setAuthUI(false);
      }
    });

// ---------------------------
    // Helpers
    // ---------------------------
    function localDateStr(d = new Date()) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }
    function el(id) { return document.getElementById(id); }
    function val(id) { return el(id)?.value ?? ""; }
    function checked(id) { return !!el(id)?.checked; }
    function asNumber(v) {
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    }
    function trimText(s) { return String(s ?? "").replace(/\s+/g, " ").trim(); }
    function mustEnum(value, allowed, fallback = null) { return allowed.includes(value) ? value : fallback; }
    function parseBP(bpText) {
      const t = trimText(bpText);
      const m = t.match(/(\d{2,3})\s*\/\s*(\d{2,3})/);
      if (!m) return { bp_sys: null, bp_dia: null };
      return { bp_sys: asNumber(m[1]), bp_dia: asNumber(m[2]) };
    }

    // ---------------------------
    // Event list UI (Pilot)
    // ---------------------------
    function newEventItem() {
      const wrap = document.createElement("div");
      wrap.className = "event-item";
      wrap.innerHTML = `
        <div class="input-group">
          <label>Description</label>
          <input type="text" class="evt-desc" placeholder="Short description">
        </div>
        <div class="row">
          <div class="input-group">
            <label>Time of day</label>
            <select class="evt-tod">
              <option value="">Select</option>
              <option value="morning">Morning</option>
              <option value="daytime">Daytime</option>
              <option value="evening_night">Evening / Night</option>
            </select>
          </div>
          <div class="input-group">
            <label>Duration (min)</label>
            <input type="number" min="0" step="1" class="evt-dur" placeholder="e.g. 30">
          </div>
        </div>
        <div class="input-group">
          <label>Suspected driver (optional)</label>
          <input type="text" class="evt-driver" placeholder="Sleep, exertion, dose timing, electrolyte shift...">
        </div>
        <button type="button" class="remove-btn">Remove</button>
      `;
      wrap.querySelector(".remove-btn").addEventListener("click", () => wrap.remove());
      return wrap;
    }

    window.addAdverseEvent = function() {
      const container = el("p-adverse-events");
      if (!container) return;
      container.appendChild(newEventItem());
    };

    function readAdverseEvents() {
      const container = el("p-adverse-events");
      if (!container) return [];
      const items = Array.from(container.querySelectorAll(".event-item"));
      return items.map((it) => {
        const desc = trimText(it.querySelector(".evt-desc")?.value ?? "");
        const tod = mustEnum(it.querySelector(".evt-tod")?.value ?? "", ["morning","daytime","evening_night"], null);
        const dur = asNumber(it.querySelector(".evt-dur")?.value ?? "");
        const driver = trimText(it.querySelector(".evt-driver")?.value ?? "");
        if (!desc && !tod && !dur && !driver) return null;
        return {
          description: desc || null,
          time_of_day: tod,
          duration_minutes: (dur === null ? null : dur),
          suspected_driver: (driver ? driver : null)
        };
      }).filter(Boolean);
    }


    window.addPositiveEvent = function() {
      const container = el("p-positive-events");
      if (!container) return;
      container.appendChild(newEventItem());
    };

    function readPositiveEvents() {
      const container = el("p-positive-events");
      if (!container) return [];
      const items = Array.from(container.querySelectorAll(".event-item"));
      return items.map((it) => {
        const desc = trimText(it.querySelector(".evt-desc")?.value ?? "");
        const tod = mustEnum(it.querySelector(".evt-tod")?.value ?? "", ["morning","daytime","evening_night"], null);
        const dur = asNumber(it.querySelector(".evt-dur")?.value ?? "");
        const driver = trimText(it.querySelector(".evt-driver")?.value ?? "");
        if (!desc && !tod && dur === null && !driver) return null;
        return {
          description: desc || null,
          time_of_day: tod,
          duration_minutes: (dur === null ? null : dur),
          suspected_driver: (driver ? driver : null)
        };
      }).filter(Boolean);
    }

    // ---------------------------
    // Payload collection
    // ---------------------------
    function collectPilotPayload() {
      const date = localDateStr();
      const morningBP = parseBP(val("p-morning-bp"));
      const eveningBP = parseBP(val("p-evening-bp"));

      return {
        date,
        baseline_rating: mustEnum(val("p-global-rating"), ["much_worse","worse","same","better","much_better"], null),
        baseline_confidence: mustEnum(val("p-global-confidence"), ["low","medium","high"], null),

        energy_capacity: asNumber(val("p-energy-capacity")),
        energy_confidence: mustEnum(val("p-energy-confidence"), ["low","medium","high"], null),

        symptom_drift: {
          brain_fog: asNumber(val("p-fog")),
          gait_effort: asNumber(val("p-gait")),
          gait_initiation: asNumber(val("p-gait-init")),
          sustained_walking: asNumber(val("p-gait-sustain")),
          neurologic_fatigue: asNumber(val("p-fatigue")),
          sleep_quality: asNumber(val("p-sleep")),
          leg_stiffness: asNumber(val("p-stiff")),
          post_rest_stiffness: asNumber(val("p-postrest")),
          symptom_volatility: asNumber(val("p-volatility"))
        },

        pain_impact: {
          severity: asNumber(val("p-painimpact")),
          interfered_with_sleep: checked("p-pain-sleep"),
          limited_walking: checked("p-pain-walk"),
          forced_extra_rest: checked("p-pain-rest"),
          required_rescue_meds: checked("p-pain-meds"),
          changed_gait_mechanics: checked("p-pain-gait"),
          primary_driver: mustEnum(val("p-pain-location"), ["piriformis_glute","low_back","hip","thigh","calf","foot","other"], null)
        },

        context_changes: {
          poor_sleep: checked("p-conf-sleep"),
          unusual_exertion: checked("p-conf-exertion"),
          medication_timing_change: checked("p-conf-medtiming"),
          dose_change: checked("p-conf-dosechange"),
          missed_dose: checked("p-conf-misseddose"),
          new_supplement: checked("p-conf-newsupp"),
          travel_or_schedule_change: checked("p-conf-travel"),
          high_stress: (asNumber(val("p-conf-stress")) ?? 0),
          infection_symptoms: checked("p-conf-infection"),
          gi_or_dehydration: checked("p-conf-gi"),
          nothing_unusual: checked("p-conf-none")
        },

        vitals: {
          morning: { ...morningBP, hr: asNumber(val("p-morning-hr")) },
          evening: { ...eveningBP, hr: asNumber(val("p-evening-hr")) }
        },

        protocol_adherence: {
          nervonic_acid_taken: checked("p-nervonic"),
          nervonic_acid_missed: checked("p-na-missed"),
          nac_taken: checked("p-nac"),
          r_ala_taken: checked("p-ala"),
          vitamin_e_taken: checked("p-vite")
        },

        fast_markers: {
          near_fall: checked("p-fast-nearfall"),
          leg_locking: checked("p-fast-locking"),
          spasm_or_clonus: checked("p-fast-spasm"),
          night_pain_woke_me: checked("p-fast-nightpain"),
          restless_legs: checked("p-fast-restless")
        },

        positive_events: readPositiveEvents(),
        wins_today: trimText(val("p-wins")) || null,
        adverse_events: readAdverseEvents(),
        notes: trimText(val("p-notes")) || null,
        food_notes: trimText(val("p-food-notes")) || null
      };
    }

    function collectPassengerPayload() {
      return {
        date: localDateStr(),
        notes: trimText(val("n-notes")) || null,
        safety: { feels_different: checked("n-safety"), details: trimText(val("n-safety-notes")) || null },
        protocol_adherence: {
          nervonic_acid_taken: checked("n-nervonic"),
          nac_taken: checked("n-nac"),
          r_ala_taken: checked("n-ala"),
          vitamin_e_taken: checked("n-vite")
        }
      };
    }

    function collectLabPayload() {
      const date = trimText(val("lab-date"));
      return {
        date: date || localDateStr(),
        lab: {
          test_date: date || null,
          vlcfa_c26: trimText(val("lab-vlcfa")) || null,
          liver_alt_ast: trimText(val("lab-liver")) || null,
          notes: trimText(val("lab-notes")) || null
        }
      };
    }

    async function saveUserLog(profile, data) {
      const ref = doc(db, ...userProfilePath(profile, "logs", data.date));const payload = {
        ...data,
        updatedAt: serverTimestamp(),
        clientUpdatedAt: new Date().toISOString()
      };
      await setDoc(ref, payload, { merge: true });
    }

    // --- PDF EXPORT (range + dense table + notes appendix) ---
    
    // Convenience: fetch last N days of logs for a patient (used by Trends + export helpers)
    async function fetchPatientLogs(patientId, days = 30) {
      try {
        const db = getFirestore();
        const end = new Date();
        const start = new Date();
        start.setDate(end.getDate() - (Number(days) || 30));

        const startKey = start.toISOString().slice(0, 10);
        const endKey = end.toISOString().slice(0, 10);

        const logsRef = collection(db, userProfilePath(patientId, "logs"));
        const q = query(
          logsRef,
          where("date", ">=", startKey),
          where("date", "<=", endKey),
          orderBy("date", "desc")
        );

        const snap = await getDocs(q);
        const out = [];
        snap.forEach((docSnap) => out.push({ id: docSnap.id, ...docSnap.data() }));
        return out;
      } catch (err) {
        console.error("fetchPatientLogs error:", err);
        return [];
      }
    }

async function fetchPatientLogsInRange(patientId, startDate, endDate, dir = "desc") {
      const logsRef = collection(db, ...userProfilePath(patientId, "logs"));
      const q = query(
        logsRef,
        where("date", ">=", startDate),
        where("date", "<=", endDate),
        orderBy("date", dir)
      );
      const snapshot = await getDocs(q);
      return snapshot.docs.map(d => d.data());
    }

    function _safeTxt(v) {
      const s = String(v ?? "");
      return s.replace(/\s+/g, " ").trim();
    }

    function _abbrBaseline(v) {
      switch (v) {
        case "much_worse": return "MW";
        case "worse": return "W";
        case "same": return "S";
        case "better": return "B";
        case "much_better": return "MB";
        default: return "-";
      }
    }

    function _ctxCodes(ctx) {
      if (!ctx) return "";
      const parts = [];
      if (ctx.poor_sleep) parts.push("SLP");
      if (ctx.unusual_exertion) parts.push("EX");
      if (ctx.medication_timing_change) parts.push("MEDT");
      if (ctx.dose_change) parts.push("DOSE");
      if (ctx.missed_dose) parts.push("MISS");
      if (ctx.new_supplement) parts.push("NEW");
      if (ctx.travel_or_schedule_change) parts.push("TRV");
      if ((ctx.high_stress ?? 0) > 0) parts.push(`STR${ctx.high_stress}`);
      if (ctx.infection_symptoms) parts.push("INF");
      if (ctx.gi_or_dehydration) parts.push("GI");
      if (ctx.nothing_unusual) parts.push("NONE");
      return parts.join(" ");
    }

    function _protoPilot(p) {
      if (!p) return "";
      const yn = (b) => (b ? "Y" : "N");
      return `NA:${yn(p.nervonic_acid_taken)}${p.nervonic_acid_missed ? "(miss)" : ""}  NAC:${yn(p.nac_taken)}  ALA:${yn(p.r_ala_taken)}  E:${yn(p.vitamin_e_taken)}`;
    }

    function _protoPassenger(p) {
      if (!p) return "";
      const yn = (b) => (b ? "Y" : "N");
      return `NA:${yn(p.nervonic_acid_taken)}  NAC:${yn(p.nac_taken)}  ALA:${yn(p.r_ala_taken)}  E:${yn(p.vitamin_e_taken)}`;
    }

    function _vitalsLine(v) {
      const fmtBP = (o) => {
        if (!o) return "-";
        const s = o.bp_sys ?? null;
        const d = o.bp_dia ?? null;
        return (s && d) ? `${s}/${d}` : "-";
      };
      const fmtHR = (o) => {
        if (!o) return "-";
        return (o.hr || o.hr === 0) ? String(o.hr) : "-";
      };
      const am = v?.morning;
      const pm = v?.evening;
      return `AM ${fmtBP(am)} HR ${fmtHR(am)}   PM ${fmtBP(pm)} HR ${fmtHR(pm)}`;
    }

    function _appendWrapped(pdf, text, x, y, maxWidth, lineH) {
      const lines = pdf.splitTextToSize(text, maxWidth);
      for (const ln of lines) {
        pdf.text(ln, x, y);
        y += lineH;
      }
      return y;
    }

    async function generatePilotPDF(logs, label, startDate, endDate, dir) {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ unit: "pt", format: "letter" });

      const pageW = pdf.internal.pageSize.getWidth();
      const margin = 36;
      const maxW = pageW - margin * 2;

      // Normalize order for reporting table
      const ordered = [...logs].sort((a,b) => String(a.date||"").localeCompare(String(b.date||"")));
      if (dir === "desc") ordered.reverse();

      // Header
      pdf.setFont("helvetica", "bold");
      pdf.setFontSize(15);
      pdf.text(`AMN Protocol: ${label}`, margin, 48);
      pdf.setFont("helvetica", "normal");
      pdf.setFontSize(10);
      pdf.text(`Range: ${startDate} to ${endDate}   |   Logs: ${ordered.length}   |   Generated: ${new Date().toLocaleDateString()}`, margin, 64);

      let y = 92;

      // Dense daily matrix header
      pdf.setFont("helvetica", "bold");
      pdf.setFontSize(9);
      pdf.text("DATE", margin, y);
      pdf.text("BL", margin + 70, y);
      pdf.text("E", margin + 96, y);
      pdf.text("P", margin + 116, y);
      pdf.text("SL", margin + 136, y);
      pdf.text("G", margin + 164, y);
      pdf.text("ST", margin + 184, y);
      pdf.text("FG", margin + 212, y);
      pdf.text("FT", margin + 240, y);
      pdf.text("CTX", margin + 270, y);
      pdf.text("EVT", margin + 420, y);
      pdf.line(margin, y + 4, margin + maxW, y + 4);
      y += 18;

      pdf.setFont("helvetica", "normal");
      pdf.setFontSize(9);

      const appendix = [];

      for (const log of ordered) {
        if (y > 720) { pdf.addPage(); y = 54; }

        const sd = log.symptom_drift || {};
        const pi = log.pain_impact || {};
        const ctx = log.context_changes || {};

        const date = _safeTxt(log.date) || "-";
        const bl = _abbrBaseline(log.baseline_rating);
        const E = (log.energy_capacity ?? "-");
        const P = (pi.severity ?? "-");
        const SL = (sd.sleep_quality ?? "-");
        const G = (sd.gait_effort ?? "-");
        const ST = (sd.leg_stiffness ?? "-");
        const FG = (sd.brain_fog ?? "-");
        const FT = (sd.neurologic_fatigue ?? "-");
        const CTX = _ctxCodes(ctx);
        const EVT = Array.isArray(log.adverse_events) ? String(log.adverse_events.length) : "0";

        pdf.text(date, margin, y);
        pdf.text(String(bl), margin + 70, y);
        pdf.text(String(E), margin + 96, y);
        pdf.text(String(P), margin + 116, y);
        pdf.text(String(SL), margin + 136, y);
        pdf.text(String(G), margin + 164, y);
        pdf.text(String(ST), margin + 184, y);
        pdf.text(String(FG), margin + 212, y);
        pdf.text(String(FT), margin + 240, y);
        pdf.text(_safeTxt(CTX).slice(0, 30), margin + 270, y);
        pdf.text(EVT, margin + 430, y);

        y += 14;

        // Appendix entry (full details)
        appendix.push({
          date,
          protocol: _protoPilot(log.protocol_adherence),
          vitals: _vitalsLine(log.vitals),
          baseline_rating: log.baseline_rating || null,
          baseline_confidence: log.baseline_confidence || null,
          energy_capacity: log.energy_capacity ?? null,
          energy_confidence: log.energy_confidence || null,
          symptom_drift: log.symptom_drift || null,
          pain_impact: log.pain_impact || null,
          context_changes: log.context_changes || null,
          wins_today: log.wins_today || null,
          food_notes: log.food_notes || null,
          notes: log.notes || null,
          adverse_events: log.adverse_events || null,
          positive_events: log.positive_events || null,
          lab: (log.lab_date || log.lab_vlcfa || log.lab_liver || log.lab_notes) ? {
            lab_date: log.lab_date || null,
            vlcfa_c26_0: log.lab_vlcfa || null,
            liver_alt_ast: log.lab_liver || null,
            notes: log.lab_notes || null
          } : null
        });
      }

      // Appendix
      pdf.addPage();
      pdf.setFont("helvetica", "bold");
      pdf.setFontSize(13);
      pdf.text("Notes Appendix (Full Details)", margin, 54);
      pdf.setFont("helvetica", "normal");
      pdf.setFontSize(9);
      y = 78;

      for (const a of appendix) {
        if (y > 720) { pdf.addPage(); y = 54; }
        pdf.setFont("helvetica", "bold");
        pdf.text(a.date, margin, y);
        pdf.setFont("helvetica", "normal");
        y += 14;

        const blocks = [];
        if (a.protocol) blocks.push(`Protocol: ${a.protocol}`);
        if (a.vitals) blocks.push(`Vitals: ${a.vitals}`);
        if (a.baseline_rating || a.baseline_confidence) blocks.push(`Baseline: ${_safeTxt(a.baseline_rating)}  (conf: ${_safeTxt(a.baseline_confidence) || "-"})`);
        if (a.energy_capacity !== null || a.energy_confidence) blocks.push(`Energy: ${a.energy_capacity ?? "-"}/10  (conf: ${_safeTxt(a.energy_confidence) || "-"})`);
        if (a.symptom_drift) blocks.push(`Symptom drift: ${_safeTxt(JSON.stringify(a.symptom_drift))}`);
        if (a.pain_impact) blocks.push(`Pain impact: ${_safeTxt(JSON.stringify(a.pain_impact))}`);
        if (a.context_changes) blocks.push(`Context: ${_safeTxt(JSON.stringify(a.context_changes))}`);
        if (a.wins_today) blocks.push(`Wins: ${_safeTxt(a.wins_today)}`);
        if (a.food_notes) blocks.push(`Food: ${_safeTxt(a.food_notes)}`);
        if (a.notes) blocks.push(`Notes: ${_safeTxt(a.notes)}`);
        if (a.lab) blocks.push(`Lab: ${_safeTxt(JSON.stringify(a.lab))}`);

        // Events
        if (Array.isArray(a.adverse_events) && a.adverse_events.length) {
          const ev = a.adverse_events.map(e => `- ${_safeTxt(e?.description || "")} (${_safeTxt(e?.time_of_day || "")}${e?.duration_minutes ? `, ${e.duration_minutes}m` : ""}${e?.suspected_driver ? `, driver: ${_safeTxt(e.suspected_driver)}` : ""})`).join(" | ");
          blocks.push(`Adverse events: ${ev}`);
        }
        if (Array.isArray(a.positive_events) && a.positive_events.length) {
          const ev = a.positive_events.map(e => `- ${_safeTxt(e?.description || "")} (${_safeTxt(e?.time_of_day || "")}${e?.duration_minutes ? `, ${e.duration_minutes}m` : ""}${e?.suspected_driver ? `, driver: ${_safeTxt(e.suspected_driver)}` : ""})`).join(" | ");
          blocks.push(`Positive events: ${ev}`);
        }

        for (const b of blocks) {
          if (y > 720) { pdf.addPage(); y = 54; }
          y = _appendWrapped(pdf, b, margin, y, maxW, 12);
        }
        y += 10;
        pdf.setDrawColor(200);
        pdf.line(margin, y, margin + maxW, y);
        y += 14;
      }

      pdf.save(`Pilot_${startDate}_to_${endDate}.pdf`);
    }

    async function generatePassengerPDF(logs, label, startDate, endDate, dir) {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ unit: "pt", format: "letter" });

      const pageW = pdf.internal.pageSize.getWidth();
      const margin = 36;
      const maxW = pageW - margin * 2;

      const ordered = [...logs].sort((a,b) => String(a.date||"").localeCompare(String(b.date||"")));
      if (dir === "desc") ordered.reverse();

      pdf.setFont("helvetica", "bold");
      pdf.setFontSize(15);
      pdf.text(`AMN Protocol: ${label}`, margin, 48);
      pdf.setFont("helvetica", "normal");
      pdf.setFontSize(10);
      pdf.text(`Range: ${startDate} to ${endDate}   |   Logs: ${ordered.length}   |   Generated: ${new Date().toLocaleDateString()}`, margin, 64);

      let y = 92;
      pdf.setFont("helvetica", "bold");
      pdf.setFontSize(9);
      pdf.text("DATE", margin, y);
      pdf.text("PROTO", margin + 90, y);
      pdf.text("SAFETY", margin + 270, y);
      pdf.line(margin, y + 4, margin + maxW, y + 4);
      y += 18;

      pdf.setFont("helvetica", "normal");
      pdf.setFontSize(9);

      const appendix = [];

      for (const log of ordered) {
        if (y > 720) { pdf.addPage(); y = 54; }
        const date = _safeTxt(log.date) || "-";
        const proto = _protoPassenger(log.protocol_adherence);
        const safety = log.safety?.feels_different ? "FEELS DIFFERENT" : "Normal";
        pdf.text(date, margin, y);
        pdf.text(_safeTxt(proto).slice(0, 28), margin + 90, y);
        pdf.text(safety, margin + 270, y);
        y += 14;

        appendix.push({
          date,
          protocol: proto,
          safety: log.safety || null,
          notes: log.notes || null
        });
      }

      // Appendix
      pdf.addPage();
      pdf.setFont("helvetica", "bold");
      pdf.setFontSize(13);
      pdf.text("Notes Appendix (Full Details)", margin, 54);
      pdf.setFont("helvetica", "normal");
      pdf.setFontSize(9);
      y = 78;

      for (const a of appendix) {
        if (y > 720) { pdf.addPage(); y = 54; }
        pdf.setFont("helvetica", "bold");
        pdf.text(a.date, margin, y);
        pdf.setFont("helvetica", "normal");
        y += 14;
        if (a.protocol) y = _appendWrapped(pdf, `Protocol: ${a.protocol}`, margin, y, maxW, 12);
        if (a.safety) y = _appendWrapped(pdf, `Safety: ${_safeTxt(JSON.stringify(a.safety))}`, margin, y, maxW, 12);
        if (a.notes) y = _appendWrapped(pdf, `Notes: ${_safeTxt(a.notes)}`, margin, y, maxW, 12);
        y += 10;
        pdf.setDrawColor(200);
        pdf.line(margin, y, margin + maxW, y);
        y += 14;
      }

      pdf.save(`Passenger_${startDate}_to_${endDate}.pdf`);
    }

    // Expose a single export runner to the non-module modal UI
    window.__EXPORT_RUN = async function({ patientId, label, start, end, dir }) {
      const logs = await fetchPatientLogsInRange(patientId, start, end, dir);
      if (patientId === "patrick") {
        await generatePilotPDF(logs, label || "Pilot", start, end, dir);
      } else {
        await generatePassengerPDF(logs, label || "Passenger", start, end, dir);
      }
    };

    function setBtn(btnId, busy, text) {
      const b = el(btnId);
      if (!b) return;
      b.disabled = !!busy;
      if (text) b.textContent = text;
    }

    // Inline onclick targets
    window.handlePilotSave = async function() {
      setBtn("p-save-log", true, "SAVING...");
      try {
        await saveUserLog("patrick", collectPilotPayload());
        setBtn("p-save-log", false, "SAVED ‚úì");
        setTimeout(() => setBtn("p-save-log", false, "SAVE DAILY LOG"), 1200);
      } catch(e) {
        console.error(e);
        setBtn("p-save-log", false, "SAVE FAILED");
        alert("Save failed. Check connection.");
      }
    };

    function collectFunctionalTestPayload() {
      const testDate = trimText(val("ft-date")) || localDateStr();
      return {
        test_date: testDate,
        six_minute_walk: {
          distance_m: asNumber(val("ft-6m-distance")),
          rest_breaks_count: asNumber(val("ft-6m-restbreaks")),
          assistive_device: trimText(val("ft-6m-device")) || null,
          course_length_m: asNumber(val("ft-6m-course")),
          perceived_exertion: asNumber(val("ft-6m-rpe"))
        },
        sit_to_stand_5x: {
          time_seconds: asNumber(val("ft-5x-time")),
          used_arms: mustEnum(val("ft-5x-arms"), ["yes","no"], null),
          chair_height_cm: asNumber(val("ft-5x-chair"))
        },
        notes: trimText(val("ft-notes")) || null
      };
    }

    window.saveFunctionalTest = async function() {
      const btns = document.querySelectorAll('[onclick="window.saveFunctionalTest()"]');
      btns.forEach(b => { try { b.disabled = true; b.textContent = "SAVING..."; } catch(e){} });

      try {
        const payload = collectFunctionalTestPayload();
        const id = `${payload.test_date}_${Date.now()}`;
        const ref = doc(db, ...userProfilePath("patrick", "tests", id));
        await setDoc(ref, { ...payload, createdAt: serverTimestamp(), clientCreatedAt: new Date().toISOString() }, { merge: true });
        btns.forEach(b => { try { b.textContent = "SAVED ‚úì"; } catch(e){} });
        setTimeout(() => btns.forEach(b => { try { b.disabled = false; b.textContent = "SAVE FUNCTIONAL TEST"; } catch(e){} }), 1400);
      } catch (e) {
        console.error(e);
        btns.forEach(b => { try { b.disabled = false; b.textContent = "SAVE FUNCTIONAL TEST"; } catch(e){} });
        alert("Functional test save failed. Check connection.");
      }
    };



    window.handlePassengerSave = async function() {
      setBtn("n-save-log", true, "SAVING...");
      try {
        await saveUserLog("nieve", collectPassengerPayload());
        setBtn("n-save-log", false, "SAVED ‚úì");
        setTimeout(() => setBtn("n-save-log", false, "SAVE DAILY LOG"), 1200);
      } catch(e) {
        console.error(e);
        setBtn("n-save-log", false, "SAVE FAILED");
        alert("Save failed. Check connection.");
      }
    };

    window.handlePassengerSafety = async function() {
      // Save safety report as part of the daily log (same doc)
      await window.handlePassengerSave();
    };

    window.handlePilotExport = async function() {
      // Backwards compatibility: route to range modal
      window.openExportModal({ patientId: 'patrick', label: 'Pilot' });
    };

    window.handlePassengerExport = async function() {
      // Backwards compatibility: route to range modal
      window.openExportModal({ patientId: 'nieve', label: 'Passenger' });
    };

    window.handleLabSave = async function() {
      setBtn("lab-save-results-btn", true, "SAVING...");
      try {
        await saveUserLog("patrick", collectLabPayload());
        setBtn("lab-save-results-btn", false, "SAVED ‚úì");
        setTimeout(() => setBtn("lab-save-results-btn", false, "SAVE LAB RESULTS ONLY"), 1600);
      } catch(e) {
        console.error(e);
        setBtn("lab-save-results-btn", false, "SAVE LAB RESULTS ONLY");
        alert("Lab save failed.");
      }
    };

    window.showTrendsTab = function(which) {
      const sum = el("trends-summary-pane");
      const charts = el("trends-charts-pane");
      const details = el("trends-details-pane");

      const t1 = el("tab-summary");
      const t2 = el("tab-charts");
      const t3 = el("tab-details");

      if (!sum || !charts || !t1 || !t2) return;

      const hasDetails = !!details && !!t3;

      // hide panes
      sum.style.display = "none";
      charts.style.display = "none";
      if (hasDetails) details.style.display = "none";

      // reset active tabs
      t1.classList.remove("active");
      t2.classList.remove("active");
      if (hasDetails) t3.classList.remove("active");

      if (which === "charts") {
        charts.style.display = "block";
        t2.classList.add("active");
        if (typeof window.renderTrendsCharts === "function") window.renderTrendsCharts();
        return;
      }

      if (which === "details" && hasDetails) {
        details.style.display = "block";
        t3.classList.add("active");
        if (typeof window.renderTrendsDetails === "function") window.renderTrendsDetails();
        return;
      }

      // summary default
      sum.style.display = "block";
      t1.classList.add("active");
    };

    // Basic trends rendering (safe/no-crash)
    let _globalChart = null;

    window.renderTrends = async function() {
      // lightweight summary text only (avoid blocking UI)
      try {
        const logs = await fetchPatientLogs("patrick", 30);
        const elSum = el("change-summary");
        if (!elSum) return;

        const withRating = logs.filter(l => !!l.baseline_rating);
        const total = logs.length;
        const rated = withRating.length;

        // simple counts
        const counts = { much_worse:0, worse:0, same:0, better:0, much_better:0 };
        withRating.forEach(l => { if (counts[l.baseline_rating] !== undefined) counts[l.baseline_rating]++; });

        elSum.innerHTML = `
          <div>Last 30 days: <strong>${total}</strong> logs found. Baseline rating recorded on <strong>${rated}</strong> days.</div>
          <div style="margin-top:10px;">
            much better: ${counts.much_better} ‚Ä¢ better: ${counts.better} ‚Ä¢ same: ${counts.same} ‚Ä¢ worse: ${counts.worse} ‚Ä¢ much worse: ${counts.much_worse}
          </div>
          <div style="margin-top:10px; color: var(--text-secondary); font-size: 0.85rem;">
            Note: This is descriptive only. It does not adjust for confounders or missing data.
          </div>
        `;
      } catch(e) {
        console.error(e);
      }
    };

    window._trendCharts = window._trendCharts || {};

    function _destroyTrendChart(key){
      try{
        if(window._trendCharts[key]){
          window._trendCharts[key].destroy();
          delete window._trendCharts[key];
        }
      }catch(e){}
    }

    function _buildLineChart(canvasId, labels, data, yMin, yMax, seriesLabel){
      const canvas = document.getElementById(canvasId);
      if(!canvas) return;
      const ctx = canvas.getContext("2d");
      _destroyTrendChart(canvasId);

      // If there is no data at all, show an empty chart frame (Chart.js handles nulls)
      window._trendCharts[canvasId] = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: seriesLabel,
            data,
            tension: 0.25,
            spanGaps: false,
            pointRadius: 3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: true } },
          scales: {
            y: {
              min: yMin,
              max: yMax,
              ticks: { stepSize: 1 }
            },
            x: {
              ticks: { maxRotation: 0, autoSkip: true }
            }
          }
        }
      });
    }

    function _mapBaselineTo15(v){
      if(v == null) return null;
      if(typeof v === "number") return v; // already 1‚Äì5
      const s = String(v).toLowerCase();
      if(s === "much_worse") return 1;
      if(s === "worse") return 2;
      if(s === "same") return 3;
      if(s === "better") return 4;
      if(s === "much_better") return 5;
      // fallback for earlier variants
      if(s.includes("much") && s.includes("worse")) return 1;
      if(s.includes("worse")) return 2;
      if(s.includes("same")) return 3;
      if(s.includes("better") && s.includes("much")) return 5;
      if(s.includes("better")) return 4;
      return null;
    }

    function _num(v){
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    }

    function _getPainSeverity(log){
      // supports either pain_impact: {severity: ...} or painImpactSeverity or pain_severity
      if(log && log.pain_impact && log.pain_impact.severity != null) return _num(log.pain_impact.severity);
      if(log && log.painImpactSeverity != null) return _num(log.painImpactSeverity);
      if(log && log.pain_severity != null) return _num(log.pain_severity);
      return null;
    }

    function _getSymptom(log, key){
      // symptom_drift: {brain_fog:..., leg_stiffness:...} OR flat keys
      if(log && log.symptom_drift && log.symptom_drift[key] != null) return _num(log.symptom_drift[key]);
      if(log && log[key] != null) return _num(log[key]);
      return null;
    }

    window.renderTrendsCharts = async function() {
      try {
        const logs = await fetchPatientLogs("patrick", 30);
        const ordered = [...logs].sort((a,b) => String(a.date||"").localeCompare(String(b.date||"")));
        const labels = ordered.map(l => l.date || "");

        // Build datasets (use null for missing values so lines break rather than lie)
        const global = ordered.map(l => _mapBaselineTo15(l.baseline_rating));
        const energy = ordered.map(l => _num(l.energy_capacity));
        const pain = ordered.map(l => _getPainSeverity(l));
        const sleep = ordered.map(l => _num((l.symptom_drift || {}).sleep_quality));
        const gaitEffort = ordered.map(l => _getSymptom(l, "gait_effort"));
        const legStiffness = ordered.map(l => _getSymptom(l, "leg_stiffness"));
        const brainFog = ordered.map(l => _getSymptom(l, "brain_fog"));
        const neuroFatigue = ordered.map(l => _getSymptom(l, "neuro_fatigue"));

        // Charts
        _buildLineChart("chart-global", labels, global, 1, 5, "Global baseline (1‚Äì5)");
        _buildLineChart("chart-energy", labels, energy, 0, 10, "Energy / Capacity (0‚Äì10)");
        _buildLineChart("chart-pain", labels, pain, 0, 10, "Pain impact (0‚Äì10)");
        _buildLineChart("chart-sleep", labels, sleep, 0, 10, "Sleep quality (0‚Äì10)");
        _buildLineChart("chart-gait-effort", labels, gaitEffort, 0, 10, "Gait effort (0‚Äì10)");
        _buildLineChart("chart-leg-stiffness", labels, legStiffness, 0, 10, "Leg stiffness (0‚Äì10)");
        _buildLineChart("chart-brain-fog", labels, brainFog, 0, 10, "Brain fog (0‚Äì10)");
        _buildLineChart("chart-neuro-fatigue", labels, neuroFatigue, 0, 10, "Neurologic fatigue (0‚Äì10)");

        // If the tab was opened while hidden, force a resize after layout settles.
        setTimeout(() => {
          Object.values(window._trendCharts).forEach(ch => { try{ ch.resize(); }catch(e){} });
        }, 50);
      } catch (err) {
        console.warn("renderTrendsCharts failed:", err);
      }
    };

window.renderTrendsDetails = async function() {
      const host = el("trends-details-content");
      if (!host) return;

      const logs = await window.fetchPatientLogs("patrick"); // pilot history (same collection used in Trends)
      const rows = [];

      function pushMetric(key, label, getter) {
        const vals = [];
        for (const l of logs) {
          const v = getter(l);
          if (v === null || v === undefined || v === "") continue;
          const n = Number(v);
          if (!Number.isFinite(n)) continue;
          vals.push({ date: l.date, v: n });
        }
        if (vals.length === 0) return;
        vals.sort((a,b)=> String(a.date).localeCompare(String(b.date)));
        const ns = vals.map(x=>x.v);
        const sum = ns.reduce((a,b)=>a+b,0);
        const mean = sum / ns.length;
        const min = Math.min(...ns);
        const max = Math.max(...ns);
        const last = vals[vals.length-1];
        rows.push({ key, label, n: ns.length, mean, min, max, lastDate: last.date, last: last.v });
      }

      // These keys match the saved pilot log schema in this build (snake_case).
      pushMetric("baseline_rating", "Global Baseline Rating (1‚Äì5)", l => l.baseline_rating);
      pushMetric("energy_capacity", "Energy / Capacity (0‚Äì10)", l => l.energy_capacity);
      pushMetric("pain_impact", "Pain Impact (0‚Äì10)", l => l.pain_impact);
      pushMetric("sleep_quality", "Sleep Quality (0‚Äì10)", l => l.sleep_quality);

      // Symptom Drift sliders
      pushMetric("brain_fog", "Brain Fog (0‚Äì10)", l => l.brain_fog);
      pushMetric("gait_effort", "Gait Effort (0‚Äì10)", l => l.gait_effort);
      pushMetric("gait_initiation", "Gait initiation effort (0‚Äì10)", l => l.gait_initiation);
      pushMetric("sustained_walking", "Sustained walking effort (0‚Äì10)", l => l.sustained_walking);
      pushMetric("neurologic_fatigue", "Neurologic fatigue (0‚Äì10)", l => l.neurologic_fatigue);
      pushMetric("leg_stiffness", "Leg Stiffness (0‚Äì10)", l => l.leg_stiffness);
      pushMetric("post_rest_stiffness", "Post-rest stiffness (0‚Äì10)", l => l.post_rest_stiffness);
      pushMetric("symptom_volatility", "Symptom volatility (0‚Äì10)", l => l.symptom_volatility);

      if (rows.length === 0) {
        host.innerHTML = '<div class="muted">No numeric trend data found yet. Add a few daily logs first.</div>';
        return;
      }

      const html = rows.map(r => {
        const mean = (Math.round(r.mean*10)/10).toFixed(1);
        return `
          <div class="row" style="padding:10px 0; border-bottom:1px solid rgba(255,255,255,.08);">
            <div style="font-weight:700;">${r.label}</div>
            <div class="muted" style="margin-top:6px;">
              N=${r.n} ‚Ä¢ mean ${mean} ‚Ä¢ min ${r.min} ‚Ä¢ max ${r.max} ‚Ä¢ last ${r.last} (${r.lastDate})
            </div>
          </div>`;
      }).join("");

      host.innerHTML = `<div>${html}</div>`;
    };


    document.addEventListener("DOMContentLoaded", () => {
      // prime slider visuals
      Array.from(document.querySelectorAll('input[type="range"]')).forEach(r => window.updateSlider(r));
    });
  </script>

  <div id="build-badge" class="build-badge">Build v15-2026-02-10</div>
</body>
</html>
