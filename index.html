<!DOCTYPE html>
<html lang="en">
<head>
  
  <script>window.__AUTH_MODULE_LOADED__ = false;</script>
<meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>The Protocol</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#000000">

  <link rel="icon" type="image/png" href="icon.png">
  <link rel="apple-touch-icon" href="icon.png">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root {
      --bg-color: #000000;
      --card-bg: #1C1C1E;
      --text-primary: #FFFFFF;
      --text-secondary: #8E8E93;
      --accent-color: #30D158; /* Apple Health Green */
      --accent-blue: #0A84FF;
      --danger-red: #FF453A;
      --lab-purple: #BF5AF2;
      --font-family: 'Inter', sans-serif;
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-primary);
      font-family: var(--font-family);
      margin: 0;
      padding: 20px;
      padding-top: env(safe-area-inset-top, 20px);
      -webkit-font-smoothing: antialiased;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
      user-select: none;
    }

    #app-container {
      max-width: 480px;
      width: 100%;
      margin: 0 auto;
      flex-grow: 1;
      position: relative;
    }

    .hero-icon, .header-icon, .menu-icon { border-radius: 50%; object-fit: cover; }

    /* --- VIEW MANAGEMENT --- */
    .view { display: none; animation: fadeIn 0.4s ease; }
    .view.active { display: block; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* --- THE SPLASH CURTAIN --- */
    #splash-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #000000;
      z-index: 10010;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      transition: opacity 0.6s ease, visibility 0.6s;
      padding: 20px;
    }
    #splash-overlay.fade-out {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    @keyframes floatAndShimmer {
      0% { transform: translateY(0px); filter: brightness(100%) drop-shadow(0 0 10px rgba(48, 209, 88, 0.2)); }
      50% { transform: translateY(-15px); filter: brightness(130%) drop-shadow(0 0 25px rgba(48, 209, 88, 0.6)); }
      100% { transform: translateY(0px); filter: brightness(100%) drop-shadow(0 0 10px rgba(48, 209, 88, 0.2)); }
    }
    .hero-icon {
      height: 120px;
      width: 120px;
      margin-bottom: 30px;
      border: 2px solid var(--accent-color);
      animation: floatAndShimmer 4s ease-in-out infinite;
    }
    .enter-btn {
      background: var(--accent-color);
      color: black;
      border: none;
      padding: 16px 50px;
      border-radius: 30px;
      font-size: 1.1rem;
      font-weight: 800;
      margin-top: 40px;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: transform 0.2s;
      box-shadow: 0 0 20px rgba(48, 209, 88, 0.3);
    }
    .enter-btn:active { transform: scale(0.95); }

    /* New Black Button Style */
    .black-btn {
      background: #000000;
      color: #ffffff;
      border: 1px solid #333;
      padding: 14px 20px;
      border-radius: 12px;
      font-size: 0.95rem;
      font-weight: 600;
      margin-top: 15px;
      width: 100%;
      cursor: pointer;
      transition: background 0.2s;
    }
    .black-btn:active { background: #1a1a1a; }

    header { margin-bottom: 20px; display: flex; align-items: center; }

    .back-btn {
      background: none;
      border: none;
      color: var(--accent-blue);
      font-size: 1.1rem;
      font-weight: 600;
      padding: 0;
      margin-right: 15px;
      cursor: pointer;
    }

    .header-icon { height: 40px; width: 40px; margin-right: 15px; border: 1px solid #333; }

    h1 {
      margin: 0;
      font-weight: 800;
      font-size: 1.4rem;
      letter-spacing: -0.5px;
      line-height: 1.25;
      text-transform: uppercase;
    }
    h2 { margin: 0; font-weight: 800; }

    .logo-area {
      text-align: center;
      margin-bottom: 20px;
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .menu-icon { height: 80px; width: 80px; margin-bottom: 20px; border: 1px solid #333; }

    .title-sub {
      color: var(--text-secondary);
      margin-top: 12px;
      font-size: 0.85rem;
      line-height: 1.4;
      max-width: 320px;
      margin-left: auto;
      margin-right: auto;
    }

    .profile-select { display: flex; flex-direction: column; gap: 15px; margin-bottom: 30px; margin-top: 25px; }

    .card-btn {
      background: var(--card-bg);
      border: 1px solid #333;
      color: white;
      width: 100%;
      padding: 25px;
      border-radius: 16px;
      text-align: left;
      cursor: pointer;
      transition: transform 0.1s;
    }
    .card-btn:active { transform: scale(0.98); }
    .card-btn h2 { font-size: 1.2rem; margin-bottom: 4px; }
    .card-btn p { margin: 0; color: var(--text-secondary); font-size: 0.9rem; }

    details {
      background-color: var(--card-bg);
      border: 1px solid #333;
      border-radius: 16px;
      margin-top: 0;
      overflow: hidden;
      transition: all 0.3s ease;
      width: 100%;
    }
    details.lab-folder { border: 1px solid var(--lab-purple); margin-top: 20px; }

    summary {
      padding: 18px 15px;
      cursor: pointer;
      font-weight: 700;
      color: var(--accent-color);
      display: flex;
      align-items: center;
      list-style: none;
      font-size: 0.9rem;
    }
    details.lab-folder summary { color: var(--lab-purple); }
    summary::-webkit-details-marker { display: none; }

    summary::before {
      content: "üìÅ";
      margin-right: 12px;
      font-size: 1.2rem;
      filter: grayscale(100%);
      flex-shrink: 0;
    }
    details.lab-folder summary::before { content: "ü©∏"; filter: none; }

    summary::after {
      content: "+";
      margin-left: 10px;
      font-size: 1.2rem;
      color: #555;
      font-weight: 400;
      flex-shrink: 0;
    }
    details[open] summary::after { content: "‚àí"; }

    .summary-text { flex: 1; text-align: center; line-height: 1.35; white-space: normal; }

    .folder-content { padding: 0 15px 20px 15px; background-color: #222; border-top: 1px solid #333; }

    .report-link {
      display: flex;
      align-items: center;
      background: #2C2C2E;
      padding: 15px;
      border-radius: 12px;
      margin-top: 12px;
      text-decoration: none;
      color: white;
      font-weight: 600;
      font-size: 0.9rem;
      transition: background 0.2s;
    }
    .report-link:active { background: #3A3A3C; }
    .report-icon { margin-right: 12px; font-size: 1.2rem; }
    .report-sub { font-size: 0.75rem; color: #8E8E93; font-weight: 400; margin-top: 2px; }
    .report-link.secondary {
      background: rgba(44, 44, 46, 0.55);
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding: 12px 14px;
      margin-top: 8px;
      margin-left: 26px;
      font-size: 0.82rem;
      opacity: 0.9;
    }
    .report-link.secondary:active { background: rgba(58, 58, 60, 0.55); }
    .report-link.secondary .report-icon { font-size: 1.05rem; opacity: 0.9; }



    .card {
      background-color: var(--card-bg);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
    }

    input[type="text"], input[type="number"], input[type="date"], textarea, select {
      background: #2C2C2E;
      border: none;
      border-radius: 8px;
      color: white;
      padding: 12px;
      width: 100%;
      font-size: 16px;
      box-sizing: border-box;
      outline: none;
      font-family: var(--font-family);
    }
    input:focus, textarea:focus, select:focus { border: 1px solid var(--accent-color); }

    .input-row { display: flex; gap: 15px; }
    .input-group { flex: 1; }
    .input-group label { display: block; font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 5px; }

    .checkbox-row {
      display: flex;
      justify-content: space-between;
      padding: 14px 0;
      border-bottom: 1px solid #333;
      align-items: center;
    }
    .checkbox-row:last-child { border-bottom: none; }
    .checkbox-row span { font-weight: 500; }

    input[type="checkbox"] { accent-color: var(--accent-color); width: 24px; height: 24px; cursor: pointer; }

    input[type="range"] { width: 100%; margin: 10px 0; accent-color: var(--accent-blue); cursor: pointer; }
    .slider-header { display: flex; justify-content: space-between; margin-top: 15px; font-size: 0.9rem; }
    .slider-val { font-weight: bold; color: var(--accent-blue); }

    .save-btn {
      background-color: var(--accent-color);
      color: black;
      font-weight: 800;
      width: 100%;
      padding: 18px;
      border: none;
      border-radius: 16px;
      font-size: 1.1rem;
      margin-bottom: 40px;
      cursor: pointer;
      box-shadow: 0 0 15px rgba(48, 209, 88, 0.3);
    }

    .streak-badge {
      background: #333;
      padding: 5px 12px;
      border-radius: 12px;
      font-size: 0.9rem;
      color: var(--accent-color);
      margin-left: auto;
    }

    .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider.round { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #3a3a3c; transition: .4s; border-radius: 34px; }
    .slider.round:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--danger-red); }
    input:checked + .slider:before { transform: translateX(22px); }

    .lab-save-btn { background-color: var(--lab-purple); color: white; font-weight: 700; width: 100%; padding: 12px; border: none; border-radius: 12px; margin-top: 20px; cursor: pointer; }
    .safety-save-btn { background-color: var(--danger-red); color: white; font-weight: 700; width: 100%; padding: 12px; border: none; border-radius: 12px; margin-top: 20px; cursor: pointer; }

    .hidden-box { display: none; margin-top: 15px; border-top: 1px solid #333; padding-top: 15px; }
    .visible-box { display: block; animation: slideDown 0.3s ease; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

    .history-list { margin-top: 20px; border-top: 1px solid #444; padding-top: 10px; }
    .history-item { background: #2C2C2E; margin-bottom: 8px; border-radius: 8px; overflow: hidden; }
    .history-summary { padding: 12px; display: flex; justify-content: space-between; font-size: 0.9rem; font-weight: 600; cursor: pointer; color: #E0E0E0; }
    .history-details { padding: 10px 12px; background: #1c1c1e; font-size: 0.85rem; color: #AAA; border-top: 1px solid #444; line-height: 1.6; display: none; }
    .history-item.open .history-details { display: block; }

    .pill-row { display:flex; gap:10px; margin-top:10px; }
    .pill-btn {
      background:#2C2C2E;
      border:1px solid #333;
      color:white;
      padding:10px 12px;
      border-radius:12px;
      font-weight:700;
      cursor:pointer;
      text-align:center;
      font-size:0.9rem;
    }
    .pill-btn.active { border-color: var(--accent-blue); }

    .mini-btn {
      background: rgba(10, 132, 255, 0.14);
      border: 1px solid rgba(10, 132, 255, 0.35);
      color: var(--accent-blue);
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 800;
      letter-spacing: 0.2px;
      width: 100%;
      cursor: pointer;
      margin-top: 12px;
    }
    .mini-btn:active { transform: scale(0.99); }

    .event-list { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
    .event-item { border: 1px solid #2f2f32; border-radius: 14px; padding: 12px; background: rgba(255,255,255,0.02); }
    .event-item .row { display: flex; gap: 10px; }
    .event-item .row .input-group { flex: 1; }
    .event-item .remove-btn {
      background: transparent;
      border: 1px solid #444;
      color: var(--text-secondary);
      border-radius: 10px;
      padding: 8px 10px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
    }

    /* Standardized Modal Styles */
    .app-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 12000;
      padding: 18px;
      backdrop-filter: blur(4px);
    }
    .app-modal .modal-card {
      width: 100%;
      max-width: 720px;
      background: #101010;
      border: 1px solid #333;
      border-radius: 16px;
      padding: 18px;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 12px 40px rgba(0,0,0,0.8);
      display: flex;
      flex-direction: column;
    }
    .app-modal .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #222;
    }
    .app-modal .modal-title { font-size: 1.1rem; font-weight: 800; color: white; }
    .app-modal .modal-close {
      background: #333;
      border: none;
      color: white;
      border-radius: 8px;
      padding: 6px 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.85rem;
    }
    .app-modal .modal-body { color: #ccc; line-height: 1.6; font-size: 0.95rem; }
    .app-modal .modal-body p { margin-bottom: 12px; }

    .read-overview-btn {
      margin-top: 12px;
      background: transparent;
      color: rgba(255,255,255,0.85);
      border: 1px solid rgba(255,255,255,0.25);
      border-radius: 12px;
      padding: 10px 14px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      max-width: 320px;
    }

    .hidden { display: none !important; }
    .view { display: block; }
    .view:not(.active) { display: none; }

    .build-badge {
      position: fixed;
      right: 10px;
      bottom: 10px;
      font-size: 12px;
      opacity: 0.6;
      z-index: 9999;
    }
  
    #trends-charts-pane canvas{ width:100% !important; height:220px !important; display:block; }
  
/* Auth + build badge (added for reliable iOS visibility) */
#auth-overlay{
  position: fixed;
  inset: 0;
  z-index: 99999;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
  background: rgba(0,0,0,0.65);
}
#auth-overlay[hidden]{ display: none !important; }
#auth-card{
  width: min(520px, 100%);
  background: #121417;
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 16px;
  padding: 18px 18px 14px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.45);
  color: #fff;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
}
#auth-card h2{ margin: 0 0 6px; font-size: 18px; }
#auth-card p{ margin: 0 0 12px; opacity: 0.85; font-size: 13px; line-height: 1.35; }
#auth-card label{ display:block; font-size: 12px; margin: 10px 0 6px; opacity: 0.9; }
#auth-card input{
  width: 100%;
  padding: 10px 12px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.16);
  background: rgba(255,255,255,0.06);
  color: #fff;
  outline: none;
}
#auth-card .row{ display:flex; gap:10px; margin-top: 12px; }
#auth-card button{
  flex: 1;
  padding: 10px 12px;
  border-radius: 10px;
  border: 0;
  cursor: pointer;
  background: #2b6cb0;
  color: #fff;
  font-weight: 600;
}
#auth-card button.secondary{ background: rgba(255,255,255,0.10); }
#auth-error{ margin-top: 10px; font-size: 12px; color: #ffb3b3; min-height: 16px; }
#build-badge{
  position: fixed;
  bottom: 10px;
  left: 10px;
  z-index: 99998;
  padding: 6px 10px;
  border-radius: 999px;
  font-size: 12px;
  background: rgba(0,0,0,0.55);
  color: rgba(255,255,255,0.9);
  border: 1px solid rgba(255,255,255,0.12);
  backdrop-filter: blur(6px);
}

/* Mobile-only cue: slightly reduce modal content height so content visibly continues below the fold */
@media (max-width: 520px) {
  .modal-body {
    max-height: 72vh !important;
  }
}


/* Scroll hint (mobile + desktop): subtle side indicator inside modal */
.modal-body { position: relative; }
#dev-modal .scroll-hint-chevron {
  position: absolute;
  right: 14px;
  bottom: 14px;
  width: 28px;
  height: 28px;
  opacity: 0.75;
  pointer-events: none;
  animation: scrollHintBob 1.6s ease-in-out infinite;
  filter: drop-shadow(0 2px 6px rgba(0,0,0,0.45));
}
.scroll-hint-hidden .scroll-hint-bar,
.scroll-hint-hidden .scroll-hint-chevron {
  opacity: 0;
  animation: none;
}
@keyframes scrollHintBob {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(6px); }
}


/* Prevent background scroll when modal is open */
body.modal-open {
  overflow: hidden;
  height: 100vh;
  touch-action: none;
}


/* Scroll Chevron (refined, no vertical bar) */
.scroll-chevron {
  position: absolute;
  right: 22px;
  bottom: 20px;
  font-size: 26px;
  font-weight: 800;
  opacity: 0.85;
  pointer-events: none;
  transition: opacity 0.3s ease;
}

.scroll-chevron.hidden {
  opacity: 0;
}

.modal-content {
  position: relative;
  padding-bottom: 56px;
}

</style>

  <script>
    function byId(id){ return document.getElementById(id); }
    function safeAdd(el, cls){ if(el && cls) el.classList.add(cls); }
    function safeRemove(el, cls){ if(el && cls) el.classList.remove(cls); }

    window.setActiveView = function(viewId) {
      ['selection-view','patrick-view','nieve-view','trends-view'].forEach(id => {
        const el = byId(id);
        if (!el) return;
        safeRemove(el, 'active');
        safeAdd(el, 'hidden');
      });
      const target = byId(viewId);
      if (target) {
        safeAdd(target, 'active');
        safeRemove(target, 'hidden');
      }
      window.scrollTo(0,0);
    };

    window.enterApp = function() {
      const splash = byId('splash-overlay');
      if (splash) {
        safeAdd(splash, 'fade-out');
        setTimeout(() => { splash.style.display = 'none'; }, 700);
      }
      window.setActiveView('selection-view');
    };

    window.selectProfile = function(profile) {
      window.ACTIVE_PROFILE = profile;
      if (profile === 'patrick') {
        window.setActiveView('patrick-view');
        const dateP = byId('date-display-p');
        if (dateP) dateP.innerText = new Date().toDateString();
      } else if (profile === 'nieve') {
        window.setActiveView('nieve-view');
      }
    };

    window.goBack = function() {
      const trends = byId('trends-view');
      if (trends && trends.classList.contains('active')) {
        window.setActiveView('patrick-view');
        return;
      }
      window.setActiveView('selection-view');
    };

    window.openTrends = function() {
      window.setActiveView('trends-view');
      if (typeof window.renderTrends === "function") window.renderTrends();
    };

    window.closeAllModals = function() {
        ['overview-modal', 'export-modal', 'dev-modal'].forEach(id => {
            const m = byId(id);
            if(m) m.style.display = 'none';
        });
    };

    window.toggleOverview = function(show) {
      window.closeAllModals();
      const m = byId('overview-modal');
      if(m && show) m.style.display = 'flex';
    };

    window.openDevModal = function() {
        window.closeAllModals();
        const m = byId('dev-modal');
        if(m) m.style.display = 'flex';
    };

    // Export Helpers
    function toISODate(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }

    function normalizeDateInput(val){
      if(!val) return '';
      const s = String(val).trim();
      if(!s) return '';
      if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
      const m1 = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if(m1){
        const mm = String(m1[1]).padStart(2,'0');
        const dd = String(m1[2]).padStart(2,'0');
        const yyyy = m1[3];
        return `${yyyy}-${mm}-${dd}`;
      }
      const d = new Date(s);
      if(!isNaN(d.getTime())) return toISODate(d);
      return '';
    }

    window.openExportModal = function(target){
      window.closeAllModals();
      window.__EXPORT_TARGET = target;
      const modal = byId('export-modal');
      const title = byId('export-title');
      const start = byId('export-start');
      const end = byId('export-end');
      const order = byId('export-order');

      if(title) title.textContent = `Export ${target?.label || 'History'} (PDF)`;
      const today = new Date();
      const startD = new Date();
      startD.setDate(today.getDate() - 29); 
      if(start) start.value = toISODate(startD);
      if(end) end.value = toISODate(today);
      if(order && !order.value) order.value = 'desc';

      // Patient header fields (saved locally; does not affect tracking)
      const pn = byId('export-patient-name');
      const dob = byId('export-patient-dob');
      const lsNameKey = `patient_name_${target?.patientId || 'unknown'}`;
      const lsDobKey = `patient_dob_${target?.patientId || 'unknown'}`;
      const defaultName = (target?.patientId === 'patrick') ? 'Patrick Fuellebeck' : (target?.patientId === 'nieve' ? 'Nieve' : '');
      if (pn) pn.value = localStorage.getItem(lsNameKey) || defaultName;
      if (dob) dob.value = localStorage.getItem(lsDobKey) || '';

      if(modal) modal.style.display = 'flex';
    };

    window.closeExportModal = function(){
      const modal = byId('export-modal');
      if(modal) modal.style.display = 'none';
    };

    window.runExportFromModal = async function(){
      const target = window.__EXPORT_TARGET || { patientId: 'patrick', label: 'Pilot' };
      const startRaw = byId('export-start')?.value;
      const endRaw = byId('export-end')?.value;
      const dir = byId('export-order')?.value || 'desc';
      const start = normalizeDateInput(startRaw);
      const end = normalizeDateInput(endRaw);
      if(!start || !end){ alert('Please select a start and end date.'); return; }
      if(start > end){ alert('Start date must be on or before end date.'); return; }


      const patientName = byId('export-patient-name')?.value?.trim() || '';
      const dobEl = byId('export-patient-dob');
      let patientDob = dobEl?.value?.trim() || '';

      // DOB normalization + validation
      // iOS numeric keyboards often hide the dash key. Accept either:
      // - YYYY-MM-DD
      // - YYYYMMDD (8 digits)
      // Normalize to YYYY-MM-DD.
      if (patientDob) {
        const digits = String(patientDob).replace(/\D/g, '');
        if (digits.length === 8) {
          patientDob = `${digits.slice(0, 4)}-${digits.slice(4, 6)}-${digits.slice(6, 8)}`;
          if (dobEl) dobEl.value = patientDob;
        }
        if (!/^\d{4}-\d{2}-\d{2}$/.test(patientDob)) {
          alert('DOB must be in YYYY-MM-DD format.');
          return;
        }
      }
      try {
        const nameKey = `patient_name_${target.patientId}`;
        const dobKey = `patient_dob_${target.patientId}`;
        if (patientName) localStorage.setItem(nameKey, patientName);
        else localStorage.removeItem(nameKey);
        if (patientDob) localStorage.setItem(dobKey, patientDob);
        else localStorage.removeItem(dobKey);
      } catch(e) { /* ignore */ }

      if(typeof window.__EXPORT_RUN !== 'function'){
        alert('Export is not ready yet (export module not loaded).');
        return;
      }

      const btn = byId('export-run-btn');
      if(btn){ btn.disabled = true; btn.textContent = 'GENERATING...'; }
      try{
        await window.__EXPORT_RUN({ patientId: target.patientId, label: target.label, start, end, dir, patientName, patientDob });
        window.closeExportModal();
      } catch(e){
        console.error(e);
        alert('Export failed. Check console for details.');
      } finally {
        if(btn){ btn.disabled = false; btn.textContent = 'Generate PDF'; }
      }
    };

    // --- DOB helper: auto-insert dashes while typing (mobile-friendly) ---
    (function attachDobFormatter(){
      const el = byId('export-patient-dob');
      if (!el) return;

      const format = (raw) => {
        const digits = String(raw || '').replace(/\D/g, '').slice(0, 8);
        if (digits.length <= 4) return digits;
        if (digits.length <= 6) return `${digits.slice(0, 4)}-${digits.slice(4)}`;
        return `${digits.slice(0, 4)}-${digits.slice(4, 6)}-${digits.slice(6)}`;
      };

      const handler = () => {
        const before = el.value;
        const after = format(before);
        if (after === before) return;
        const atEnd = (el.selectionStart === before.length);
        el.value = after;
        if (atEnd) {
          const pos = after.length;
          try { el.setSelectionRange(pos, pos); } catch (_) {}
        }
      };

      el.addEventListener('input', handler);
      el.addEventListener('blur', handler);
    })();

    window.updateSlider = function(element) {
      try { element.previousElementSibling.querySelector('.slider-val').innerText = element.value; } catch(e) {}
      if (!element.max) return;
      var min = parseFloat(element.min || "0");
      var max = parseFloat(element.max || "100");
      var val = parseFloat(element.value || "0");
      var pct = ((val - min) / (max - min)) * 100;
      element.style.background = "linear-gradient(to right, var(--accent-blue) 0%, var(--accent-blue) " + pct + "%, #444 " + pct + "%, #444 100%)";
    };

    window.toggleSafetyBox = function() {
      const checkBox = byId("n-safety");
      const box = byId("n-safety-box");
      if (!checkBox || !box) return;
      if (checkBox.checked) {
        box.classList.add("visible-box");
        box.style.display = "block";
      } else {
        box.classList.remove("visible-box");
        box.style.display = "none";
      }
    };

    window.resetPilotForm = function() {
      const form = byId("patrick-form");
      if (!form) return;
      form.reset();
            try { window.setNeuromuscularTraining(0, "none"); } catch(e){}
const adv = document.getElementById('p-adverse-events'); if (adv) adv.innerHTML = '';
      const pos = document.getElementById('p-positive-events'); if (pos) pos.innerHTML = '';
      Array.from(form.querySelectorAll('input[type="range"]')).forEach(r => window.updateSlider(r));
      window.scrollTo(0,0);
    };
  </script>

  <!-- Firebase (compat) for iOS Safari reliability -->
  <!-- IMPORTANT: these must execute BEFORE the inline bootstrap script at the end of <body>.
       Using `defer` here can cause the inline script to run first, leaving buttons non-responsive.
       So we load them synchronously. -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>


<style id="overview-tightening">
#overview-modal .modal-body { 
  line-height: 1.42;
}
#overview-modal p { 
  margin: 0 0 12px 0;
}
</style>


<style id="dev-modal-scrollbar-hide">
#dev-modal .modal-body {
  scrollbar-width: none;
  -ms-overflow-style: none;
}
#dev-modal .modal-body::-webkit-scrollbar {
  display: none;
}
</style>

</head>
<body>
<div id="auth-overlay">
  <div id="auth-card">
    <h2>Sign in</h2>
    <p>Sign in once on this device to sync and protect your logs.</p>

    <label for="auth-email">Email</label>
    <input id="auth-email" type="email" autocomplete="email" inputmode="email" />

    <label for="auth-pass">Password</label>
    <input id="auth-pass" type="password" autocomplete="current-password" />

    <div class="row">
      <button id="auth-signin" type="button">Sign in</button>
      <button id="auth-signup" class="secondary" type="button">Create account</button>
    </div>
      <div class="row" style="margin-top:10px;">
        <button id="auth-demo" class="secondary" type="button" style="width:100%;">View demo (read-only)</button>
      </div>
    <div id="auth-error"></div>
  </div>
</div>


  <div id="splash-overlay">
    <img src="icon.png" alt="Pioneer Icon" class="hero-icon">
    <h1>THE AMN DUAL-MECHANISM<br>SUPPORT PROTOCOL</h1>
    <p class="title-sub">A Structured Approach to Redox Stabilization, Axonal Preservation,<br>and Exploratory Myelin Support</p>

    <button class="enter-btn" onclick="window.enterApp()">Enter Protocol</button>
    <button id="read-overview-btn" class="read-overview-btn" type="button" onclick="window.toggleOverview(true)">Why this protocol exists</button>
  </div>

  <div id="overview-modal" class="app-modal" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title">What this protocol is</div>
        <button type="button" class="modal-close" onclick="window.closeAllModals()">Close</button>
      </div>
      <div class="modal-body">
<p><strong>Purpose.</strong> This protocol is a structured framework for improving functional stability in adrenomyeloneuropathy by reducing biological stress on vulnerable neural pathways.</p>
        <p><strong>What it is not.</strong> It does not claim a cure, reversal of established damage, or forced regeneration. The working target is margin: preserving what remains and reducing secondary injury.</p>
        <p><strong>Why this is different.</strong> Many treatments reduce symptoms downstream without changing the underlying strain. This approach focuses on upstream environment optimization: oxidative load, metabolic reliability, and inflammatory pressure. The aim is to reduce background instability rather than temporarily suppress expression.</p>
        <p><strong>How we know whether it helps.</strong> The model relies on repeated, standardized checks compared against baseline. Functional test outputs are tracked alongside symptom domains such as pain, stiffness, fatigue, and sleep disruption. Changes are interpreted over weeks, not days, and are considered meaningful only when directionally consistent across more than one measure. Contextual variables such as stress, illness, GI upset, and medication adjustments are logged to reduce false attribution.</p>
      </div>
    </div>
  </div>

  <div id="export-modal" class="app-modal" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title" id="export-title">Export History (PDF)</div>
        <button type="button" class="modal-close" onclick="window.closeAllModals()">Close</button>
      </div>
      <div class="modal-body">
        <div class="row2" style="display:flex; gap:12px;">
          <div class="input-group">
            <label>Start date</label>
            <input type="date" id="export-start">
          </div>
          <div class="input-group">
            <label>End date</label>
            <input type="date" id="export-end">
          </div>
        </div>

        <div class="row2" style="display:flex; gap:12px; margin-top:12px;">
          <div class="input-group" style="flex:2;">
            <label>Patient name (for PDF header)</label>
            <input type="text" id="export-patient-name" placeholder="Patrick Fuellebeck">
          </div>
          <div class="input-group" style="flex:1;">
            <label>DOB (YYYY-MM-DD)</label>
            <input type="text" id="export-patient-dob" placeholder="YYYY-MM-DD" inputmode="numeric">
          </div>
        </div>

        <div class="input-group" style="margin-top:10px;">
          <label>Sort order</label>
          <select id="export-order">
            <option value="desc" selected>Newest first</option>
            <option value="asc">Oldest first</option>
          </select>
        </div>
        <div class="helper" style="margin-top:8px; font-size:0.85rem; color:#888;">Defaults to the last 30 days.</div>
        <button type="button" class="lab-save-btn" id="export-run-btn" onclick="window.runExportFromModal()">Generate PDF</button>
      </div>
    </div>
  </div>

  <div id="dev-modal" class="app-modal" role="dialog" aria-modal="true">
    <div class="modal-card">
        <div class="modal-header">
            <div class="modal-title">Protocol Development</div>
            <button type="button" class="modal-close" onclick="window.closeAllModals()">Close</button>
        </div>
        <div class="modal-body">
<div class="scroll-hint-chevron" aria-hidden="true">
  <svg viewBox="0 0 24 24" width="28" height="28" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M7 10l5 5 5-5" stroke="rgba(255,255,255,0.75)" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
</div>

            <h3 style="margin-top:0; color:#38bdf8; font-size:1.1rem; line-height:1.4;">PROTOCOL DEVELOPMENT, VALIDATION, AND STRUCTURAL FRAMEWORK</h3>
<h4 style="color:#22c55e; margin-top:10px; margin-bottom:14px; font-size:0.95rem; font-weight:600; letter-spacing:0.4px;">
Conceptual Foundation and Mechanistic Framework
</h4>

            
<p>This project was not assembled casually. It represents a structured, multi-layered effort conducted over an extended period of time to address a condition where large-scale translational research remains limited and long-term human trials are scarce.</p>

<p>This protocol is structured around a dual-mechanism model targeting two core drivers of pathology: redox instability and lipid dysregulation. The redox axis is supported through coordinated use of alpha-lipoic acid, N-acetylcysteine, and vitamin E to stabilize oxidative stress and preserve axonal integrity. In parallel, nervonic acid is incorporated as a lipid-modulating component to support membrane composition and potentially influence very long chain fatty acid dynamics. Together, these components define the mechanistic foundation of the protocol.</p>

<p>The following methodological steps were undertaken to construct this framework responsibly:</p>

<p style="color:#aaa; font-size:0.92rem; line-height:1.5;">Within this framework, the term "dual mechanism" reflects the recognition that oxidative destabilization and lipid compositional imbalance represent distinct but interacting pathological processes. Redox stabilization and lipid substrate modulation are therefore approached as parallel axes rather than sequential steps, acknowledging that meaningful system-level stability requires addressing both domains simultaneously.</p>
            <hr style="border-color:#333; margin: 20px 0;">
            <h4 style="color:var(--accent-color); margin-bottom:10px;">1. Independent Literature Review</h4>
            <ul style="padding-left: 20px; color:#ccc; list-style-type:disc;">
                <li style="margin-bottom:6px;">Analysis of peer-reviewed research related to axonal degeneration and myelin biology.</li>
                <li style="margin-bottom:6px;">Review of mechanistic research relevant to very long-chain fatty acid metabolism.</li>
                <li style="margin-bottom:6px;">Research into the biology of the adult nervous system, including its structural limitations, regenerative constraints, and the realistic potential for functional recovery or structural repair.</li>
                <li>Evaluation of translational limits between animal models and human data.</li>
            </ul>
            <hr style="border-color:#333; margin: 20px 0;">
            <h4 style="color:var(--accent-color); margin-bottom:10px;">2. Mechanism Mapping</h4>
            <ul style="padding-left: 20px; color:#ccc; list-style-type:disc;">
                <li style="margin-bottom:6px;">Identification of oxidative and mitochondrial stress pathways that reduce axonal safety margin and inhibit oligodendrocyte stability.</li>
                <li style="margin-bottom:6px;">Examination of lipid metabolism and VLCFA accumulation mechanisms affecting membrane integrity and myelin structure.</li>
                <li style="margin-bottom:6px;">Formal separation of the two intervention axes that define the dual-mechanism model: (1) redox and metabolic stabilization and (2) lipid substrate support and VLCFA modulation.</li>
                <li>Deliberate distinction between preservation strategies and exploratory structural support.</li>
            </ul>
            <hr style="border-color:#333; margin: 20px 0;">
            <h4 style="color:var(--accent-color); margin-bottom:10px;">3. Supplier Identification and Process Transparency Review</h4>
            <ul style="padding-left: 20px; color:#ccc; list-style-type:disc;">
                <li style="margin-bottom:6px;">Determination of botanical source material (Acer truncatum), a species cultivated extensively in parts of China and studied for over three decades for its naturally occurring nervonic acid content and characterized fatty acid profile.</li>
                <li style="margin-bottom:6px;">Research to identify a biotech supplier with documented production standards and process transparency.</li>
                <li style="margin-bottom:6px;">Direct communication with the manufacturer.</li>
                <li style="margin-bottom:6px;">Review of extraction methodology.</li>
                <li style="margin-bottom:6px;">Clarification of ethanol versus alternative solvent use.</li>
                <li>Review of available process documentation for internal consistency.</li>
            </ul>
            <hr style="border-color:#333; margin: 20px 0;">
            <h4 style="color:var(--accent-color); margin-bottom:10px;">4. Third-Party Laboratory Testing Plan</h4>
            <ul style="padding-left: 20px; color:#ccc; list-style-type:disc;">
                <li style="margin-bottom:6px;">Fatty acid profile confirmation.</li>
                <li style="margin-bottom:6px;">Purity testing.</li>
                <li style="margin-bottom:6px;">Heavy metal testing (ICP-MS).</li>
                <li style="margin-bottom:6px;">Residual solvent analysis.</li>
                <li>Independent third-party verification prior to use.</li>
            </ul>
            <hr style="border-color:#333; margin: 20px 0;">
            <h4 style="color:var(--accent-color); margin-bottom:10px;">5. Cost Modeling and Practical Feasibility</h4>
            <ul style="padding-left: 20px; color:#ccc; list-style-type:disc;">
                <li style="margin-bottom:6px;">Estimating the cost of each step required to conduct this project responsibly, including sourcing, logistics, and laboratory verification.</li>
                <li style="margin-bottom:6px;">Comparing retail versus direct sourcing pathways.</li>
                <li style="margin-bottom:6px;">Determining that direct sourcing of a near-pure form of nervonic acid from a biotech supplier was the most financially realistic approach.</li>
                <li>Concluding that even with independent lab validation and due diligence, this route provided significantly greater long-term feasibility.</li>
            </ul>
            <hr style="border-color:#333; margin: 20px 0;">
            <h4 style="color:var(--accent-color); margin-bottom:10px;">6. Legal and Regulatory Review</h4>
            <ul style="padding-left: 20px; color:#ccc; list-style-type:disc;">
                <li style="margin-bottom:6px;">Consultation regarding representation of company status.</li>
                <li style="margin-bottom:6px;">Clarification on import classification.</li>
                <li style="margin-bottom:6px;">Evaluation of potential border documentation issues.</li>
                <li>Review of labeling and disclosure practices.</li>
            </ul>
            <hr style="border-color:#333; margin: 20px 0;">
            <h4 style="color:var(--accent-color); margin-bottom:10px;">7. Data Infrastructure Development</h4>
            <ul style="padding-left: 20px; color:#ccc; list-style-type:disc;">
                <li style="margin-bottom:6px;">Custom protocol tracking interface.</li>
                <li style="margin-bottom:6px;">Pilot and Passenger separation logic within the tracking system.</li>
                <li style="margin-bottom:6px;">Structured PDF export system for documentation and longitudinal pattern analysis.</li>
                <li>Cloud storage independent of browser persistence.</li>
            </ul>
            <hr style="border-color:#333; margin: 20px 0;">
            <p>The Pilot is the primary subject (myself), who implements the full protocol first and confirms tolerability and safety metrics over time. The Passenger is my daughter, for whom any future use would be prophylactic and contingent on demonstrated safety in the Pilot phase. No crossover occurs without stability confirmation.</p>
            <p>This system exists to apply structured, translation-focused reasoning in an area where large-scale human research remains limited.</p>
            <p>It is structured, controlled, and documented.</p>
        </div>
    </div>
  </div>

  <div id="app-container">

    <section id="selection-view" class="view active">
      <div class="logo-area">
        <img src="icon.png" alt="Pioneer Icon" class="menu-icon">
        <h1>THE AMN DUAL-MECHANISM<br>SUPPORT PROTOCOL</h1>
        <p class="title-sub">A Structured Approach to Redox Stabilization, Axonal Preservation,<br>and Exploratory Myelin Support</p>
      </div>

      <details style="margin-bottom: 0;">
        <summary>
          <div class="summary-text">Protocol Context<br>& References</div>
        </summary>
        <div class="folder-content">
          <a href="docs/amn-family-overview.pdf" class="report-link" target="_blank" rel="noopener">
            <span class="report-icon">üßë‚Äçüë©‚Äçüëß‚Äçüë¶</span>
            <div>
              <div>AMN Protocol ‚Äì Family Overview</div>
              <div class="report-sub">Plain-language overview</div>
            </div>
          </a>
          <a href="docs/amn-clinical-reference.pdf" class="report-link" target="_blank" rel="noopener">
            <span class="report-icon">ü©∫</span>
            <div>
              <div>AMN Protocol ‚Äì Clinical Reference</div>
              <div class="report-sub">Technical reference</div>
            </div>
          </a>
          <a href="docs/functional-recovery-amn.pdf" class="report-link" target="_blank" rel="noopener">
            <span class="report-icon">üß†</span>
            <div>
              <div>A Phenotype-Specific Framework for Functional Change in AMN</div>
              <div class="report-sub">Case framework</div>
            </div>
          </a>
          <a href="docs/protocol-governance-and-escalation-framework.pdf" class="report-link" target="_blank" rel="noopener">
            <span class="report-icon">üõ°Ô∏è</span>
            <div>
              <div>Protocol Governance & Escalation</div>
              <div class="report-sub">Safety thresholds and decision logic</div>
            </div>
          </a>

          <a href="docs/full-governence-risk-containment-framework.pdf" target="_blank" rel="noopener" class="report-link secondary">
            <span class="report-icon">üìÑ</span>
            <div>
              <div>Full Governance Risk Containment Framework</div>
              <div class="report-sub">Companion document (expanded)</div>
            </div>
          </a>

          <a href="https://elastic-amn-diagrams.netlify.app/" class="report-link" target="_blank" rel="noopener">
            <span class="report-icon">üîç</span>
            <div>
              <div>Functional Outcome Interpretation</div>
              <div class="report-sub">Interactive logic tool</div>
            </div>
          </a>
        </div>
      </details>

      <button class="black-btn" onclick="window.openDevModal()">Protocol Development & Validation</button>

      <div class="profile-select">
        <button class="card-btn" onclick="window.selectProfile('patrick')">
          <h2>The Pilot</h2>
          <p>Patrick ‚Ä¢ Safety & Margin Protocol</p>
        </button>
        <button class="card-btn" onclick="window.selectProfile('nieve')">
          <h2>The Passenger</h2>
          <p>Nieve ‚Ä¢ Prophylactic Protocol</p>
        </button>
      </div>
    </section>

    <section id="patrick-view" class="view hidden">
      <header>
        <button class="back-btn" onclick="window.goBack()">‚Üê Back</button>
        <img src="icon.png" alt="Pioneer Icon" class="header-icon">
        <h2>The Pilot</h2>
      </header>

      <p style="color:var(--text-secondary); font-size:0.75rem; margin-top:4px; line-height:1.4;">
        Trends help with interpretation over time but do not prove causation or confirm underlying mechanisms.
      </p>

      <p style="color:var(--text-secondary); margin-bottom:20px; font-size:0.9rem;" id="date-display-p"></p>

      <form id="patrick-form">

        <details style="margin-bottom: 20px; margin-top: 0;">
          <summary>
            <div class="summary-text">Protocol Context<br>& References</div>
          </summary>
          <div class="folder-content">
            <a href="docs/amn-family-overview.pdf" class="report-link" target="_blank" rel="noopener">
              <span class="report-icon">üßë‚Äçüë©‚Äçüëß‚Äçüë¶</span><div><div>AMN Protocol ‚Äì Family Overview</div></div>
            </a>
            <a href="docs/amn-clinical-reference.pdf" class="report-link" target="_blank" rel="noopener">
              <span class="report-icon">ü©∫</span><div><div>AMN Protocol ‚Äì Clinical Reference</div></div>
            </a>
            <a href="docs/functional-recovery-amn.pdf" class="report-link" target="_blank" rel="noopener">
              <span class="report-icon">üß†</span><div><div>Functional Framework</div></div>
            </a>
            <a href="docs/protocol-governance-and-escalation-framework.pdf" class="report-link" target="_blank" rel="noopener">
                <span class="report-icon">üõ°Ô∏è</span>
                <div>
                  <div>Protocol Governance & Escalation</div>
                  <div class="report-sub">Safety thresholds and decision logic</div>
                </div>
              </a>

          <a href="docs/full-governence-risk-containment-framework.pdf" target="_blank" rel="noopener" class="report-link secondary">
            <span class="report-icon">üìÑ</span>
            <div>
              <div>Full Governance Risk Containment Framework</div>
              <div class="report-sub">Companion document (expanded)</div>
            </div>
          </a>

            <a href="https://elastic-amn-diagrams.netlify.app/" class="report-link" target="_blank" rel="noopener">
              <span class="report-icon">üîç</span>
              <div>
                <div>Functional Outcome Interpretation</div>
                <div class="report-sub">Interactive logic tool</div>
              </div>
            </a>
          </div>
        </details>

        <details class="lab-folder" style="margin-bottom: 20px; margin-top: 0;">
          <summary>
            <div class="summary-text" style="color:#BF5AF2;">Periodic Lab Results<br>(VLCFA & Liver)</div>
          </summary>
          <div class="folder-content">
            <div class="input-group" style="margin-bottom:15px;">
              <label>Date of Test</label>
              <input type="date" id="lab-date">
            </div>
            <div class="input-row">
              <div class="input-group">
                <label>VLCFA (C26:0)</label>
                <input type="text" id="lab-vlcfa" placeholder="e.g. 1.25">
              </div>
              <div class="input-group">
                <label>Liver (ALT/AST)</label>
                <input type="text" id="lab-liver" placeholder="e.g. 25 / 30">
              </div>
            </div>
            <div class="input-group" style="margin-top:15px;">
              <label>Notes</label>
              <textarea id="lab-notes" rows="2" placeholder="Specific details..."></textarea>
            </div>
            <button type="button" class="lab-save-btn" id="lab-save-results-btn" onclick="window.handleLabSave()">SAVE LAB RESULTS ONLY</button>
            <div id="lab-history-list" class="history-list"></div>
          </div>
        </details>

        <div class="card">
          <h3>Morning Vitals</h3>
          <div class="input-row">
            <div class="input-group">
              <label>BP (Sys/Dia)</label>
              <input type="text" id="p-morning-bp" placeholder="120/80">
            </div>
            <div class="input-group">
              <label>HR (bpm)</label>
              <input type="number" id="p-morning-hr" placeholder="60">
            </div>
          </div>
        </div>

        <div class="card">
          <h3>Daily Protocol</h3>
          <label class="checkbox-row"><span>Nervonic Acid (1g)</span><input type="checkbox" id="p-nervonic" checked></label>
          <label class="checkbox-row"><span>Missed NA dose today</span><input type="checkbox" id="p-na-missed"></label>
          <label class="checkbox-row"><span>NAC (2.4g)</span><input type="checkbox" id="p-nac"></label>
          <label class="checkbox-row"><span>R-ALA (425mg)</span><input type="checkbox" id="p-ala"></label>
          <label class="checkbox-row"><span>Vit E (Mixed - 400IU)</span><input type="checkbox" id="p-vite"></label>
        </div>

        
<div class="card">
          <h3>Global Baseline Rating</h3>
          <div style="font-size:13px;color:rgba(255,255,255,0.55);margin-top:8px;margin-bottom:10px;line-height:1.35">Overall comparison to your usual baseline for the day (big-picture).</div>
          <div class="two-col">
            <div>
              <div class="label">Compared to my usual baseline, today was</div>
              <select id="p-global-rating" class="select">
                <option value="">Select</option>
                <option value="much_worse">Much worse</option>
                <option value="worse">Worse</option>
                <option value="slightly_worse">Slightly worse</option>
                <option value="baseline">Baseline</option>
                <option value="slightly_better">Slightly better</option>
                <option value="better">Better</option>
                <option value="much_better">Much better</option>
              </select>
            </div>
            <div>
              <div class="label">Confidence</div>
              <select id="p-global-confidence" class="select">
                <option value="">Select</option>
                <option value="high">High</option>
                <option value="medium">Medium</option>
                <option value="low">Low</option>
              </select>
              <div style="font-size:13px;color:rgba(255,255,255,0.55);margin-top:8px;margin-bottom:10px;line-height:1.35">Confidence = how certain today‚Äôs rating reflects your underlying neurologic state (vs normal day-to-day noise).</div>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>Energy / Capacity</h3>
          <div style="font-size:13px;color:rgba(255,255,255,0.55);margin-top:8px;margin-bottom:10px;line-height:1.35">Energy/capacity = usable ‚Äúgas in the tank‚Äù. Neurologic fatigue is captured later under Symptom Drift.</div>
          <div class="row">
            <div>
              <div class="label">Usable energy / capacity (10 = best)</div>
              <input id="p-energy" type="range" min="0" max="10" step="1" value="5" class="slider">
            </div>
            <div class="value" id="p-energy-val">5/10</div>
          </div>
          <div class="row">
            <div>
              <div class="label">Confidence</div>
              <select id="p-energy-confidence" class="select">
                <option value="">Select</option>
                <option value="high">High</option>
                <option value="medium">Medium</option>
                <option value="low">Low</option>
              </select>
              <div style="font-size:13px;color:rgba(255,255,255,0.55);margin-top:8px;margin-bottom:10px;line-height:1.35">Confidence = how certain today‚Äôs rating reflects your underlying neurologic state (vs normal day-to-day noise).</div>
            </div>
          </div>
        </div>
<div class="card">
          <h3>Fast Markers</h3>
          <div style="font-size:13px;color:rgba(255,255,255,0.55);margin-top:8px;margin-bottom:10px;line-height:1.35">Quick yes/no events that are high-signal (easy to remember and strongly meaningful).</div>
          <label class="checkbox-row"><span>Near-fall or balance scare</span><input type="checkbox" id="p-fast-nearfall"></label>
          <label class="checkbox-row"><span>Electrolyte rescue required</span><input type="checkbox" id="p-fast-electrolyte"></label>
          <label class="checkbox-row"><span>Spasm or clonus episode</span><input type="checkbox" id="p-fast-spasm"></label>
          <label class="checkbox-row"><span>Night pain woke me</span><input type="checkbox" id="p-fast-nightpain"></label>
          <label class="checkbox-row"><span>Restless legs at night</span><input type="checkbox" id="p-fast-restless"></label>
        </div>

        <div class="card">
          <h3>Pain Impact</h3>
          <div class="slider-header"><label>Pain impact (10 = Dominated the day)</label><span class="slider-val">0</span></div>
          <input type="range" id="p-painimpact" min="0" max="10" value="0" oninput="window.updateSlider(this)">
          <div style="margin-top:10px; font-size:0.85rem; color:var(--text-secondary);">Interference</div>
          <label class="checkbox-row"><span>Interfered with sleep</span><input type="checkbox" id="p-pain-sleep"></label>
          <label class="checkbox-row"><span>Limited walking</span><input type="checkbox" id="p-pain-walk"></label>
          <label class="checkbox-row"><span>Forced extra rest breaks</span><input type="checkbox" id="p-pain-rest"></label>
          <label class="checkbox-row"><span>Required additional meds or rescue</span><input type="checkbox" id="p-pain-meds"></label>
          <label class="checkbox-row"><span>Changed gait mechanics</span><input type="checkbox" id="p-pain-gait"></label>
          <div class="input-group" style="margin-top:15px;">
            <label>Primary pain driver today</label>
            <select id="p-pain-location">
              <option value="">Select</option>
              <option value="piriformis_glute">Piriformis or glute</option>
              <option value="low_back">Low back</option>
              <option value="hip">Hip</option>
              <option value="thigh">Thigh</option>
              <option value="calf">Calf</option>
              <option value="foot">Foot</option>
              <option value="other">Other</option>
            </select>
          </div>
        </div>

        <div class="card">
          <h3>Confounders (what changed today?)</h3>
          <div style="font-size:13px;color:rgba(255,255,255,0.55);margin-top:8px;margin-bottom:10px;line-height:1.35">Log non-protocol changes that may distort symptom interpretation today.</div>
          <label class="checkbox-row"><span>Poor sleep last night</span><input type="checkbox" id="p-conf-sleep"></label>
          <label class="checkbox-row"><span>Unusual physical exertion</span><input type="checkbox" id="p-conf-exertion"></label>
          
          <label class="checkbox-row"><span>Pharmacologic changes</span><input type="checkbox" id="p-conf-pharm"></label>
          <div id="p-conf-pharm-panel" class="accordion-panel" style="display:none; margin:8px 0 4px 0; padding:10px 12px; border:1px solid rgba(255,255,255,0.08); border-radius:12px; background:rgba(255,255,255,0.03);">
            <label class="checkbox-row"><span>Medication timing change</span><input type="checkbox" id="p-conf-medtiming"></label>
            <label class="checkbox-row"><span>Dose change</span><input type="checkbox" id="p-conf-dosechange"></label>
            <label class="checkbox-row"><span>Missed dose</span><input type="checkbox" id="p-conf-misseddose"></label>
            <label class="checkbox-row"><span>New supplement added</span><input type="checkbox" id="p-conf-newsupp"></label>
            <label class="checkbox-row"><span>New medication added</span><input type="checkbox" id="p-conf-newmed"></label>
            <div class="input-group" style="margin-top:10px;">
              <label>Notes (optional)</label>
              <input type="text" id="p-conf-pharm-notes" placeholder="e.g., shifted hydrocortisone timing, added magnesium, missed NAC...">
            </div>
          </div>

          <label class="checkbox-row"><span>Travel or disrupted schedule</span><input type="checkbox" id="p-conf-travel"></label>
          <div class="input-group" style="padding:14px 0; border-bottom:1px solid #333;">
            <label>High stress (0‚Äì3)</label>
            <input type="number" id="p-conf-stress" min="0" max="3" placeholder="0 to 3">
          </div>
          <label class="checkbox-row"><span>Infection symptoms</span><input type="checkbox" id="p-conf-infection"></label>
          <label class="checkbox-row"><span>GI upset or dehydration risk</span><input type="checkbox" id="p-conf-gi"></label>
          <label class="checkbox-row"><span>Night pain likely electrolyte-related</span><input type="checkbox" id="p-conf-elec"></label>
          <div class="two-col" style="margin-top:8px;margin-bottom:6px">
            <div>
              <div class="label" style="margin:0 0 4px 0">Quick pick (optional)</div>
              <select id="p-conf-elec-type" class="select">
                <option value="">Select</option>
                <option value="na">Sodium</option>
                <option value="k">Potassium</option>
                <option value="mg">Magnesium</option>
                <option value="unsure">Not sure</option>
              </select>
            </div>
            <div>
              <div class="label" style="margin:0 0 4px 0">Helped within (optional)</div>
              <select id="p-conf-elec-window" class="select">
                <option value="">Select</option>
                <option value="15">15 min</option>
                <option value="30">30 min</option>
                <option value="60">60 min</option>
                <option value="120">2+ hours</option>
              </select>
            </div>
          </div>
          <label class="checkbox-row"><span>Nothing unusual</span><input type="checkbox" id="p-conf-none"></label>
        </div>

        <div class="card">
          <h3>Subjective daily summary</h3>
          <textarea id="p-wins" rows="3" placeholder="Example: Energy steadier overall. Walking felt smoother overall. Less volatile symptoms."></textarea>
        </div>

        <div class="card">
          <h3>Timestamped positive signals (optional)</h3>
          <p style="color:var(--text-secondary); margin-top:8px; font-size:0.9rem; line-height:1.5;">
            Use this if something clearly improved during a specific window. Use Trigger type to link to protocol doses when relevant.
          </p>
          <div id="p-positive-events" class="event-list"></div>
          <button type="button" class="mini-btn" id="p-add-positive-event" onclick="window.addPositiveEvent()">+ Add positive event</button>
        </div>

        <details style="margin-bottom: 20px; margin-top: 0;">
          <summary>
            <div class="summary-text">Functional Tests<br>(Weekly or Monthly Anchors)</div>
          </summary>
          <div class="folder-content">
            <p style="color:#9a9a9f; font-size:0.85rem; line-height:1.45; margin: 0 0 14px 0;">Optional objective anchors. Use the same setup each time for comparability.</p>
            <div class="input-group" style="margin-top:15px;">
              <label>Test Date</label>
              <input type="date" id="ft-date">
            </div>
            <div class="card" style="margin-top: 15px;">
              <h3>6-Minute Walk Test</h3>
              <div class="input-row">
                <div class="input-group">
                  <label>Distance (meters)</label>
                  <input type="number" id="ft-6m-distance" placeholder="e.g. 220">
                </div>
                <div class="input-group">
                  <label>Rest breaks (count)</label>
                  <input type="number" id="ft-6m-restbreaks" placeholder="e.g. 1">
                </div>
              </div>
              <div class="input-row" style="margin-top:12px;">
                <div class="input-group">
                  <label>Assistive device</label>
                  <select id="ft-6m-device">
                    <option value="">Select</option>
                    <option value="none">None</option>
                    <option value="cane">Cane</option>
                    <option value="walker">Walker</option>
                    <option value="crutches">Crutches</option>
                    <option value="other">Other</option>
                  </select>
                </div>
                <div class="input-group">
                  <label>Course length (meters)</label>
                  <input type="number" id="ft-6m-course" placeholder="e.g. 20">
                </div>
              </div>
              <div class="input-group" style="margin-top:12px;">
                <label>Perceived exertion (0-10)</label>
                <input type="number" id="ft-6m-rpe" min="0" max="10" placeholder="0 to 10">
              </div>
            </div>

            <div class="card">
              <h3>5x Sit-to-Stand</h3>
              <div class="input-row">
                <div class="input-group">
                  <label>Time (seconds)</label>
                  <input type="number" id="ft-5x-time" step="0.1" placeholder="e.g. 18.4">
                </div>
                <div class="input-group">
                  <label>Used arms?</label>
                  <select id="ft-5x-arms">
                    <option value="">Select</option>
                    <option value="no">No</option>
                    <option value="yes">Yes</option>
                  </select>
                </div>
              </div>
              <div class="input-group" style="margin-top:12px;">
                <label>Chair height (cm, optional)</label>
                <input type="number" id="ft-5x-chair" placeholder="e.g. 45">
              </div>
            </div>

            <div class="input-group" style="margin-top:12px;">
              <label>Notes</label>
              <textarea id="ft-notes" rows="2" placeholder="Anything notable about setup, pain, fatigue, or conditions"></textarea>
            </div>

            <button type="button" class="lab-save-btn" style="margin-top:14px;" onclick="window.saveFunctionalTest()">SAVE FUNCTIONAL TEST</button>
            <div id="ft-history-list" class="history-list"></div>
          </div>
        </details>

        <div class="card">
          <h3>Symptom Drift (0-10)</h3>
          <div style="font-size:13px;color:rgba(255,255,255,0.55);margin-top:8px;margin-bottom:10px;line-height:1.35">Rate relative to your usual baseline. 0 = best / none, 10 = worst / hardest. Keep your interpretation consistent over time.</div>
          <div class="slider-header"><label>Brain Fog (10 = Worst)</label><span class="slider-val">0</span></div>
          <input type="range" id="p-fog" min="0" max="10" value="0" oninput="window.updateSlider(this)">
          <div class="slider-header"><label>Step-by-step gait effort (10 = Hardest)</label><span class="slider-val">0</span></div>
          <input type="range" id="p-gait" min="0" max="10" value="0" oninput="window.updateSlider(this)">
          <div class="slider-header"><label>Gait initiation effort (10 = Hardest)</label><span class="slider-val">0</span></div>
          <input type="range" id="p-gait-init" min="0" max="10" value="0" oninput="window.updateSlider(this)">
          <div class="slider-header"><label>Sustained walking effort (10 = Hardest)</label><span class="slider-val">0</span></div>
          <input type="range" id="p-gait-sustain" min="0" max="10" value="0" oninput="window.updateSlider(this)">
          <div class="slider-header"><label>Neurologic fatigue (10 = Wiped out)</label><span class="slider-val">0</span></div>
          <input type="range" id="p-fatigue" min="0" max="10" value="0" oninput="window.updateSlider(this)">
          <div class="slider-header"><label>Sleep Quality (10 = Best)</label><span class="slider-val">5</span></div>
          <input type="range" id="p-sleep" min="0" max="10" value="5" oninput="window.updateSlider(this)">
          <div class="slider-header"><label>Leg Stiffness (10 = Rigid)</label><span class="slider-val">0</span></div>
          <input type="range" id="p-stiff" min="0" max="10" value="0" oninput="window.updateSlider(this)">
          <div class="slider-header"><label>Post-rest stiffness (10 = Severe)</label><span class="slider-val">0</span></div>
          <input type="range" id="p-postrest" min="0" max="10" value="0" oninput="window.updateSlider(this)">
          <div class="slider-header"><label>Symptom volatility (10 = Very up and down)</label><span class="slider-val">0</span></div>
          <input type="range" id="p-volatility" min="0" max="10" value="0" oninput="window.updateSlider(this)">
        </div>

        <div class="card">
          <h3>Evening Vitals</h3>
          <div class="input-row">
            <div class="input-group">
              <label>BP (Sys/Dia)</label>
              <input type="text" id="p-evening-bp" placeholder="120/80">
            </div>
            <div class="input-group">
              <label>HR (bpm)</label>
              <input type="number" id="p-evening-hr" placeholder="60">
            </div>
          </div>
        </div>

        <div class="card">
          <h3>Food (optional)</h3>
          <textarea id="p-food-notes" class="notes" placeholder="Brief notes..."></textarea>
        </div>

        <div class="card">
          <h3>Adverse events / notes</h3>
          <div id="p-adverse-events" class="event-list"></div>
          <button type="button" class="mini-btn" id="p-add-adverse-event" onclick="window.addAdverseEvent()">+ Add adverse event</button>
          <div class="input-group" style="margin-top:14px;">
            <label>Notes (optional)</label>
            <textarea id="p-notes" rows="3" placeholder="General notes..."></textarea>
          </div>
        </div>

        
        <div class="card">
          <h3>External Variables</h3>
          <p style="margin-top:8px; color:#D7D7D7; font-size:0.9rem; line-height:1.5;">
            Logged as an external confounder, not a core protocol component.
          </p>

          <div class="input-group" style="margin-top:12px;">
            <label>Neuromuscular Training (external)</label>
            <div class="pill-row" style="margin-top:8px;">
              <div class="pill-btn active" id="p-nmt-btn-0" onclick="window.setNeuromuscularTraining(0, 'none')">None</div>
              <div class="pill-btn" id="p-nmt-btn-1" onclick="window.setNeuromuscularTraining(1, 'light')">Light</div>
              <div class="pill-btn" id="p-nmt-btn-2" onclick="window.setNeuromuscularTraining(2, 'full')">Full</div>
            </div>
            <input type="hidden" id="p-nmt-level" value="0">
            <input type="hidden" id="p-nmt-label" value="none">
          </div>
        </div>

<button type="button" class="mini-btn" onclick="window.openTrends()" style="margin-bottom:20px;">VIEW TRENDS & EXPORT PDF</button>

        <button type="button" class="back-btn" style="width:100%; text-align:center; margin: 0 0 14px 0;" onclick="window.resetPilotForm()">Reset today's form</button>
        <button type="button" class="save-btn" id="p-save-log" onclick="window.handlePilotSave()">SAVE DAILY LOG</button>
      </form>
    </section>

    <section id="trends-view" class="view hidden">
      <header>
        <button class="back-btn" onclick="window.goBack()">‚Üê Back</button>
        <img src="icon.png" alt="Pioneer Icon" class="header-icon">
        <h2>Trends</h2>
      </header>

      <div class="card">
        <h3>Trends Mode</h3>
        <div class="pill-row">
          <div class="pill-btn active" id="tab-summary" onclick="window.showTrendsTab('summary')">Summary</div>
          <div class="pill-btn" id="tab-charts" onclick="window.showTrendsTab('charts')">Charts</div>
          <div class="pill-btn" id="tab-details" onclick="window.showTrendsTab('details')">Details</div>
        </div>
      </div>

      <div id="trends-summary-pane">
        <div class="card">
          <h3>Change Detection Summary</h3>
          <button type="button" class="lab-save-btn" id="clinician-export-btn" style="margin-top:12px;" onclick="window.openExportModal({patientId:'patrick', label:'Pilot'})">DOWNLOAD PILOT HISTORY (PDF)</button>
          <div id="change-summary" style="margin-top:12px; font-size:0.9rem; line-height:1.7; color:#E0E0E0;"></div>
        </div>
      </div>

      <div id="trends-charts-pane" style="display:none;">
        <div class="card">
          <h3>Global Baseline Rating</h3>
          <canvas id="chart-global" height="180"></canvas>
        </div>
        <div class="card">
          <h3>Energy / Capacity (0‚Äì10)</h3>
          <canvas id="chart-energy" height="180"></canvas>
        </div>
        <div class="card">
          <h3>Pain Impact (0‚Äì10)</h3>
          <canvas id="chart-pain" height="180"></canvas>
        </div>
        <div class="card">
          <h3>Sleep Quality (0‚Äì10)</h3>
          <canvas id="chart-sleep" height="180"></canvas>
        </div>
        <div class="card">
          <h3>Gait Effort (0‚Äì10)</h3>
          <canvas id="chart-gait-effort" height="180"></canvas>
        </div>
        <div class="card">
          <h3>Leg Stiffness (0‚Äì10)</h3>
          <canvas id="chart-leg-stiffness" height="180"></canvas>
        </div>
        <div class="card">
          <h3>Brain Fog (0‚Äì10)</h3>
          <canvas id="chart-brain-fog" height="180"></canvas>
        </div>
        <div class="card">
          <h3>Neurologic Fatigue (0‚Äì10)</h3>
          <canvas id="chart-neuro-fatigue" height="180"></canvas>
        </div>
      </div>

      <div id="trends-details-pane" style="display:none;">
        <div class="card">
          <div class="h2">Tracked Metrics (Details)</div>
          <div class="muted" style="margin-top:8px;">N = number of days with a recorded value.</div>
          <div id="trends-details-content" style="margin-top:12px;"></div>
        </div>
      </div>
    </section>

    <section id="nieve-view" class="view hidden">
      <header>
        <button class="back-btn" onclick="window.goBack()">‚Üê Back</button>
        <img src="icon.png" alt="Pioneer Icon" class="header-icon">
        <h2>The Passenger</h2>
        <div class="streak-badge"><span id="streak-count">0</span> Day Streak</div>
      </header>

      <form id="nieve-form">
        <div class="card">
          <h3>Daily Protocol</h3>
          <label class="checkbox-row"><span>Nervonic Acid (500mg)</span><input type="checkbox" id="n-nervonic"></label>
          <label class="checkbox-row"><span>NAC (600mg)</span><input type="checkbox" id="n-nac"></label>
          <label class="checkbox-row"><span>ALA (200mg)</span><input type="checkbox" id="n-ala"></label>
          <label class="checkbox-row"><span>Vit E (200IU)</span><input type="checkbox" id="n-vite"></label>
        </div>

        <div class="card">
          <h3>Safety Check</h3>
          <div class="toggle-row" style="display:flex; justify-content:space-between; align-items:center; padding:12px 0;">
            <span>Do you feel different today?</span>
            <label class="switch">
              <input type="checkbox" id="n-safety" onchange="window.toggleSafetyBox()">
              <span class="slider round"></span>
            </label>
          </div>

          <div id="n-safety-box" class="hidden-box">
            <div class="input-group">
              <label style="color:var(--danger-red);">Describe Symptoms</label>
              <textarea id="n-safety-notes" rows="3" placeholder="What feels different?"></textarea>
            </div>
            <button type="button" class="safety-save-btn" onclick="window.handlePassengerSafety()">SUBMIT SAFETY REPORT</button>
          </div>
        </div>

        <div class="card">
          <h3>Notes (optional)</h3>
          <textarea id="n-notes" class="notes" placeholder="Optional notes..."></textarea>
        </div>

        <button type="button" class="mini-btn" id="passenger-export-btn" style="margin-bottom:20px;" onclick="window.openExportModal({patientId:'nieve', label:'Passenger'})">DOWNLOAD HISTORY (PDF)</button>
        <button type="button" class="save-btn" id="n-save-log" onclick="window.handlePassengerSave()">SAVE DAILY LOG</button>
      </form>
    </section>

  </div>

  <script>
    // Firebase does NOT work reliably when this page is opened via file:// (origin becomes "null").
    // Use your Netlify URL or serve locally over http://localhost.
    // Even if Firebase fails to load, we still allow a read-only demo so you can show the UI.
    window.__AUTH_MODULE_LOADED__ = false;

    // Demo mode can be entered even if Firebase/Auth scripts fail to load.
window.__enterDemoMode = function __enterDemoMode() {
  try {
    window.__DEMO_MODE__ = true;
    const overlay = document.getElementById('auth-overlay');
    if (overlay) overlay.style.display = 'none';

    // Disable cloud write actions
    const disableIds = [
      'p-save-log',
      'n-save-log',
      'lab-save-results-btn',
      'clinician-export-btn'
    ];
    disableIds.forEach((id) => {
      const el = document.getElementById(id);
      if (!el) return;
      el.disabled = true;
      el.style.opacity = '0.5';
      el.style.cursor = 'not-allowed';
      el.title = 'Demo mode: cloud sync disabled';
    });

    let b = document.getElementById('demo-banner');
    if (!b) {
      b = document.createElement('div');
      b.id = 'demo-banner';
      b.style.position = 'fixed';
      b.style.left = '16px';
      b.style.right = '16px';
      b.style.bottom = '16px';
      b.style.zIndex = '9999';
      b.style.padding = '10px 12px';
      b.style.borderRadius = '12px';
      b.style.background = 'rgba(0,0,0,0.75)';
      b.style.backdropFilter = 'blur(8px)';
      b.style.webkitBackdropFilter = 'blur(8px)';
      b.style.color = '#fff';
      b.style.fontSize = '13px';
      b.style.lineHeight = '1.25';
      b.innerHTML = 'Viewing in demo mode (read-only)';
      document.body.appendChild(b);
    }
  } catch (e) {
    console.warn('Demo mode failed to start', e);
  }
};

function setAuthError(msg) {
      const el = document.getElementById('auth-error');
      if (!el) return;
      el.textContent = msg;
      el.style.display = 'block';
    }

    function hideAuthModal() {
      const overlay = document.getElementById('auth-overlay');
      if (overlay) overlay.setAttribute('hidden','hidden');
    }

    // Demo mode is always available (no cloud sync)
    window.enterDemoMode = function () {
      try { localStorage.setItem('amn_demo_mode', '1'); } catch (_) {}
      hideAuthModal();
    };

    if (location.protocol === 'file:') {
      setAuthError('You opened this page as a local file (file://). Cloud login will not work in file mode. Use the Netlify URL, or run a local server (e.g., ‚Äúpython3 -m http.server‚Äù) and open http://localhost:8000. You can still use ‚ÄúView demo (read-only)‚Äù.');
    }

    const firebaseConfig = {
      apiKey: "AIzaSyDrklblxcbR3TxTOMgsEB4ZgKNE2F1Au98",
      authDomain: "pioneer-program.firebaseapp.com",
      projectId: "pioneer-program",
      storageBucket: "pioneer-program.firebasestorage.app",
      messagingSenderId: "773361494367",
      appId: "1:773361494367:web:15aee1471b181413d1eeea"
    };

    let auth = null;
    let db = null;
    try {
      if (window.firebase && typeof firebase.initializeApp === 'function') {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        auth = firebase.auth();
        window.__AUTH_MODULE_LOADED__ = true;

        // Provide the API that the auth UI expects
        window.__authApi = {
          signIn: (email, pass) => auth.signInWithEmailAndPassword(email, pass),
          signUp: (email, pass) => auth.createUserWithEmailAndPassword(email, pass),
          signOut: () => auth.signOut()
        };

      }
    } catch (e) {
      console.error('Firebase bootstrap failed:', e);
      window.__AUTH_MODULE_LOADED__ = false;
      setAuthError('Cloud login failed to initialize. If you are on iPhone Safari, try disabling content blockers for this site and reloading. You can still use ‚ÄúView demo (read-only)‚Äù.');
    }

    // If Firebase didn't initialize, keep the page usable (demo still works).
    if (!window.__AUTH_MODULE_LOADED__ || !auth || !db) {
      // Make the auth overlay usable even when Firebase fails:
      // - Demo still works
      // - Sign in / Create account show a clear error instead of doing nothing
      const demoBtn = document.getElementById('auth-demo');
      const inBtn = document.getElementById('auth-signin');
      const upBtn = document.getElementById('auth-signup');
      if (demoBtn) demoBtn.addEventListener('click', () => window.enterDemoMode());
      const explain = () => setAuthError('Cloud login did not initialize on this device/browser. Try reloading, disabling content blockers, and ensure third-party scripts are allowed. You can still use ‚ÄúView demo (read-only)‚Äù.');
      if (inBtn) inBtn.addEventListener('click', explain);
      if (upBtn) upBtn.addEventListener('click', explain);
    } else {
    // Persist login on device/browser (one-time login per device).
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch((err) => {
      console.warn("Auth persistence not set:", err?.code || err);
    });

    let CURRENT_UID = null;

    function ensureAuthUI() {
      // Attach button handlers once the auth DOM exists.
      if (window.__authUIReady) return;

      const overlay = document.getElementById("auth-overlay");
      const emailEl = document.getElementById("auth-email");
      const passEl = document.getElementById("auth-pass");
      const btnIn  = document.getElementById("auth-signin");
      const btnUp  = document.getElementById("auth-signup");
      const btnDemo = document.getElementById("auth-demo");
      const errEl  = document.getElementById("auth-error");

      // If the elements aren't on the page yet (common when scripts run before body),
      // don't mark ready. We'll retry shortly / on DOMContentLoaded.
      if (!overlay || !emailEl || !passEl || !btnIn || !btnUp || !btnDemo || !errEl) {
        setTimeout(ensureAuthUI, 50);
        return;
      }

      const showErr = (msg) => {
        errEl.textContent = msg || "";
        errEl.style.display = msg ? "block" : "none";
      };

      btnIn.addEventListener("click", async () => {
        showErr("");
        const email = (emailEl.value || "").trim();
        const pass  = (passEl.value || "").trim();
        if (!email || !pass) return showErr("Enter email and password.");
        try {
          await window.__authApi.signIn(email, pass);
          showAuthOverlay(false);
          onAuthReady();
        } catch (e) {
          showErr(e?.message || String(e));
        }
      });

      btnUp.addEventListener("click", async () => {
        showErr("");
        const email = (emailEl.value || "").trim();
        const pass  = (passEl.value || "").trim();
        if (!email || !pass) return showErr("Enter email and password.");
        try {
          await window.__authApi.signUp(email, pass);
          showAuthOverlay(false);
          onAuthReady();
        } catch (e) {
          showErr(e?.message || String(e));
        }
      });

      btnDemo.addEventListener("click", () => {
        showErr("");
        enterDemoMode();
      });

      window.__authUIReady = true;
    }

    function showAuthOverlay(show) {
      ensureAuthUI();
      const o = document.getElementById("auth-overlay");
      if (!o) return;
      if (show) o.removeAttribute("hidden");
      else o.setAttribute("hidden", "hidden");
    }

    function enterDemoMode() {
      window.__DEMO_MODE__ = true;
      showAuthOverlay(false);
      // Disable cloud write actions
      const disableIds = [
        "p-save-log",
        "n-save-log",
        "lab-save-results-btn",
        "clinician-export-btn"
      ];
      disableIds.forEach((id) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.disabled = true;
        el.style.opacity = "0.5";
        el.style.cursor = "not-allowed";
        el.title = "Demo mode: cloud sync disabled";
      });

      // Small banner so it's obvious
      let b = document.getElementById("demo-banner");
      if (!b) {
        b = document.createElement("div");
        b.id = "demo-banner";
        b.style.position = "fixed";
        b.style.left = "16px";
        b.style.right = "16px";
        b.style.bottom = "16px";
        b.style.zIndex = "9999";
        b.style.padding = "10px 12px";
        b.style.borderRadius = "12px";
        b.style.background = "rgba(0,0,0,0.75)";
        b.style.backdropFilter = "blur(8px)";
        b.style.webkitBackdropFilter = "blur(8px)";
        b.style.color = "#fff";
        b.style.fontSize = "13px";
        b.style.lineHeight = "1.25";
        b.innerHTML = "Viewing in demo mode (read-only). Cloud sync and exports are disabled.";
        document.body.appendChild(b);
      }
    }

    // Optional: expose a manual sign-out (for testing)
    window.signOutProtocol = async function() {
      try { await auth.signOut(); } catch(e) { console.error(e); }
    };

    function requireUid() {
      if (window.__DEMO_MODE__) throw new Error("Demo mode: not signed in");
      if (!CURRENT_UID) throw new Error("Not signed in. Please sign in again.");
      return CURRENT_UID;
    }


    db.enablePersistence().catch((err) => {
      console.warn("Firestore persistence not enabled:", err?.code || err);
    });

    // Gate all Firestore reads/writes behind authentication.
    // If you are not signed in, the app will prompt once and then stay signed in on this device.
    auth.onAuthStateChanged((user) => {
      CURRENT_UID = user?.uid || null;
      showAuthOverlay(!CURRENT_UID);
    });

    // --- NO AUTH / NO DEVICE ID ---
    // Users are static profiles: "patrick" or "nieve".
    // Path structure: users/{profileName}/logs/{date}

    function userProfilePath(profile, ...rest) {
      // Secure path (requires Firebase Auth): users/{uid}/profiles/{profile}/...
      const uid = requireUid();
      const tail = rest.length ? "/" + rest.map(encodeURIComponent).join("/") : "";
      return `users/${uid}/profiles/${encodeURIComponent(profile)}${tail}`;
    }

    // ---------------------------
    // Helpers
    // ---------------------------
    function localDateStr(d = new Date()) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }
    function el(id) { return document.getElementById(id); }
    function val(id) { return el(id)?.value ?? ""; }
    function checked(id) { return !!el(id)?.checked; }
    function asNumber(v) {
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    }
    function trimText(s) { return String(s ?? "").replace(/\s+/g, " ").trim(); }
    function mustEnum(value, allowed, fallback = null) { return allowed.includes(value) ? value : fallback; }
    function parseBP(bpText) {
      const t = trimText(bpText);
      const m = t.match(/(\d{2,3})\s*\/\s*(\d{2,3})/);
      if (!m) return { bp_sys: null, bp_dia: null };
      return { bp_sys: asNumber(m[1]), bp_dia: asNumber(m[2]) };
    }

    // ---------------------------
    // Event list UI (Pilot)
    // ---------------------------
    
    function newTimestampedItem(mode) {
      const wrap = document.createElement("div");
      wrap.className = "event-item";

      const descLabel = (mode === "positive") ? "What improved" : "What happened";

      wrap.innerHTML = `
        <div class="input-group">
          <label>${descLabel}</label>
          <input type="text" class="evt-desc" placeholder="Short description">
        </div>
        <div class="row2">
          <div class="input-group">
            <label>When</label>
            <input type="datetime-local" class="evt-when">
          </div>
          <div class="input-group">
            <label>Duration (min)</label>
            <input type="number" min="0" step="1" class="evt-dur" placeholder="e.g. 30">
          </div>
        </div>
        <div class="row2">
          <div class="input-group">
            <label>Trigger type (optional)</label>
            <select class="evt-trigger-type">
              <option value="">Select</option>
              <option value="protocol_dose">Protocol dose</option>
              <option value="electrolyte_rescue">Electrolyte rescue</option>
              <option value="sleep">Sleep</option>
              <option value="exertion">Exertion</option>
              <option value="stress">Stress</option>
              <option value="food">Food</option>
              <option value="illness">Illness</option>
              <option value="routine_relief">Routine relief action</option>
              <option value="unknown">Unknown</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="input-group">
            <label>Trigger detail (optional)</label>
            <input type="text" class="evt-trigger-detail" placeholder="e.g., Nervonic Acid dose, potassium, stretching">
          </div>
        </div>
        <button type="button" class="remove-btn">Remove</button>
      `;
      wrap.querySelector(".remove-btn").addEventListener("click", () => wrap.remove());
      return wrap;
    }

    function timeOfDayFromWhen(whenLocal) {
      if (!whenLocal) return null;
      const m = whenLocal.match(/T(\d{2}):/);
      if (!m) return null;
      const hh = parseInt(m[1], 10);
      if (Number.isNaN(hh)) return null;
      if (hh < 12) return "morning";
      if (hh < 18) return "daytime";
      return "evening_night";
    }

    window.addAdverseEvent = function() {
      const container = el("p-adverse-events");
      if (!container) return;
      container.appendChild(newTimestampedItem("adverse"));
    };

    function readAdverseEvents() {
      const container = el("p-adverse-events");
      if (!container) return [];
      const items = Array.from(container.querySelectorAll(".event-item"));
      return items.map((it) => {
        const desc = trimText(it.querySelector(".evt-desc")?.value ?? "");
        const whenLocal = trimText(it.querySelector(".evt-when")?.value ?? "");
        const dur = asNumber(it.querySelector(".evt-dur")?.value ?? "");
        const trigType = trimText(it.querySelector(".evt-trigger-type")?.value ?? "");
        const trigDetail = trimText(it.querySelector(".evt-trigger-detail")?.value ?? "");

        if (!desc && !whenLocal && dur === null && !trigType && !trigDetail) return null;

        return {
          description: desc || null,
          occurred_at_local: whenLocal || null,
          time_of_day: timeOfDayFromWhen(whenLocal),
          duration_minutes: (dur === null ? null : dur),
          trigger_type: trigType || null,
          trigger_detail: trigDetail || null
        };
      }).filter(Boolean);
    }

    window.addPositiveEvent = function() {
      const container = el("p-positive-events");
      if (!container) return;
      container.appendChild(newTimestampedItem("positive"));
    };

    function readPositiveEvents() {
      const container = el("p-positive-events");
      if (!container) return [];
      const items = Array.from(container.querySelectorAll(".event-item"));
      return items.map((it) => {
        const desc = trimText(it.querySelector(".evt-desc")?.value ?? "");
        const whenLocal = trimText(it.querySelector(".evt-when")?.value ?? "");
        const dur = asNumber(it.querySelector(".evt-dur")?.value ?? "");
        const trigType = trimText(it.querySelector(".evt-trigger-type")?.value ?? "");
        const trigDetail = trimText(it.querySelector(".evt-trigger-detail")?.value ?? "");

        if (!desc && !whenLocal && dur === null && !trigType && !trigDetail) return null;

        return {
          description: desc || null,
          occurred_at_local: whenLocal || null,
          time_of_day: timeOfDayFromWhen(whenLocal),
          duration_minutes: (dur === null ? null : dur),
          trigger_type: trigType || null,
          trigger_detail: trigDetail || null
        };
      }).filter(Boolean);
    }


function collectPilotPayload() {
      const date = localDateStr();
      const morningBP = parseBP(val("p-morning-bp"));
      const eveningBP = parseBP(val("p-evening-bp"));

      return {
        date,
        baseline_rating: mustEnum(val("p-global-rating"), ["much_worse","worse","same","better","much_better"], null),
        baseline_confidence: mustEnum(val("p-global-confidence"), ["low","medium","high"], null),

        energy_capacity: asNumber(val("p-energy-capacity")),
        energy_confidence: mustEnum(val("p-energy-confidence"), ["low","medium","high"], null),

        symptom_drift: {
          brain_fog: asNumber(val("p-fog")),
          gait_effort: asNumber(val("p-gait")),
          gait_initiation: asNumber(val("p-gait-init")),
          sustained_walking: asNumber(val("p-gait-sustain")),
          neurologic_fatigue: asNumber(val("p-fatigue")),
          sleep_quality: asNumber(val("p-sleep")),
          leg_stiffness: asNumber(val("p-stiff")),
          post_rest_stiffness: asNumber(val("p-postrest")),
          symptom_volatility: asNumber(val("p-volatility"))
        },

        pain_impact: {
          severity: asNumber(val("p-painimpact")),
          interfered_with_sleep: checked("p-pain-sleep"),
          limited_walking: checked("p-pain-walk"),
          forced_extra_rest: checked("p-pain-rest"),
          required_rescue_meds: checked("p-pain-meds"),
          changed_gait_mechanics: checked("p-pain-gait"),
          primary_driver: mustEnum(val("p-pain-location"), ["piriformis_glute","low_back","hip","thigh","calf","foot","other"], null)
        },

        context_changes: {
          poor_sleep: checked("p-conf-sleep"),
          unusual_exertion: checked("p-conf-exertion"),
          medication_timing_change: checked("p-conf-medtiming"),
          dose_change: checked("p-conf-dosechange"),
          missed_dose: checked("p-conf-misseddose"),
          new_supplement: checked("p-conf-newsupp"),
          new_medication: checked("p-conf-newmed"),
          travel_or_schedule_change: checked("p-conf-travel"),
          high_stress: (asNumber(val("p-conf-stress")) ?? 0),
          infection_symptoms: checked("p-conf-infection"),
          gi_or_dehydration: checked("p-conf-gi"),
          nothing_unusual: checked("p-conf-none")
        },

        vitals: {
          morning: { ...morningBP, hr: asNumber(val("p-morning-hr")) },
          evening: { ...eveningBP, hr: asNumber(val("p-evening-hr")) }
        },

        protocol_adherence: {
          nervonic_acid_taken: checked("p-nervonic"),
          nervonic_acid_missed: checked("p-na-missed"),
          nac_taken: checked("p-nac"),
          r_ala_taken: checked("p-ala"),
          vitamin_e_taken: checked("p-vite")
        },

        
        external_neuromuscular_training: {
          level: (asNumber(val("p-nmt-level")) ?? 0),
          label: mustEnum(val("p-nmt-label"), ["none","light","full"], "none")
        },

fast_markers: {
          near_fall: checked("p-fast-nearfall"),
          leg_locking: checked("p-fast-electrolyte"),
          spasm_or_clonus: checked("p-fast-spasm"),
          night_pain_woke_me: checked("p-fast-nightpain"),
          restless_legs: checked("p-fast-restless")
        },

        positive_events: readPositiveEvents(),
        wins_today: trimText(val("p-wins")) || null,
        adverse_events: readAdverseEvents(),
        notes: trimText(val("p-notes")) || null,
        food_notes: trimText(val("p-food-notes")) || null
      };
    }

    function collectPassengerPayload() {
      return {
        date: localDateStr(),
        notes: trimText(val("n-notes")) || null,
        safety: { feels_different: checked("n-safety"), details: trimText(val("n-safety-notes")) || null },
        protocol_adherence: {
          nervonic_acid_taken: checked("n-nervonic"),
          nac_taken: checked("n-nac"),
          r_ala_taken: checked("n-ala"),
          vitamin_e_taken: checked("n-vite")
        }
      };
    }

    function collectLabPayload() {
      const date = trimText(val("lab-date"));
      return {
        date: date || localDateStr(),
        lab: {
          test_date: date || null,
          vlcfa_c26: trimText(val("lab-vlcfa")) || null,
          liver_alt_ast: trimText(val("lab-liver")) || null,
          notes: trimText(val("lab-notes")) || null
        }
      };
    }

    async function saveUserLog(profile, data) {
      // Path: users/{profile}/logs/{date}
      // doc() expects even segments: col, doc, col, doc.
      // We pass: "users", profile, "logs", data.date
      const ref = db.doc(userProfilePath(profile, "logs", data.date));
      const payload = {
        ...data,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        clientUpdatedAt: new Date().toISOString()
      };
      await ref.set(payload, { merge: true });
    }

    // --- PDF EXPORT (range + dense table + notes appendix) ---
    async function fetchPatientLogsInRange(patientId, startDate, endDate, dir = "desc") {
      const q = db
        .collection(userProfilePath(patientId, "logs"))
        .where("date", ">=", startDate)
        .where("date", "<=", endDate)
        .orderBy("date", dir);
      const snapshot = await q.get();
      return snapshot.docs.map((d) => d.data());
    }


    // Fetch last N logs (default 30), ordered by date desc.
    async function fetchPatientLogs(patientId, days = 30) {
      const q = db
        .collection(userProfilePath(patientId, "logs"))
        .orderBy("date", "desc")
        .limit(days);
      const snapshot = await q.get();
      return snapshot.docs.map((d) => d.data());
    }

    function _safeTxt(v) {
      const s = String(v ?? "");
      return s.replace(/\s+/g, " ").trim();
    }

    function _abbrBaseline(v) {
      switch (v) {
        case "much_worse": return "MW";
        case "worse": return "W";
        case "same": return "S";
        case "better": return "B";
        case "much_better": return "MB";
        default: return "-";
      }
    }

    function _ctxCodes(ctx) {
      if (!ctx) return "";
      const parts = [];
      if (ctx.poor_sleep) parts.push("SLP");
      if (ctx.unusual_exertion) parts.push("EX");
      if (ctx.medication_timing_change) parts.push("MEDT");
      if (ctx.dose_change) parts.push("DOSE");
      if (ctx.missed_dose) parts.push("MISS");
      if (ctx.new_supplement) parts.push("NEW");
      if (ctx.new_medication) parts.push("NEWMED");
      if (ctx.electrolyte_night_pain) {
        const t = ctx.electrolyte_type ? ctx.electrolyte_type.toUpperCase() : "";
        const w = ctx.electrolyte_helped_within ? ctx.electrolyte_helped_within : "";
        parts.push(`ELEC${t}${w ? "-" + w : ""}`);
      }
      if (ctx.travel_or_schedule_change) parts.push("TRV");
      if ((ctx.high_stress ?? 0) > 0) parts.push(`STR${ctx.high_stress}`);
      if (ctx.infection_symptoms) parts.push("INF");
      if (ctx.gi_or_dehydration) parts.push("GI");
      if (ctx.nothing_unusual) parts.push("NONE");
      return parts.join(" ");
    }

    function _protoPilot(p) {
      if (!p) return "";
      const yn = (b) => (b ? "Y" : "N");
      return `NA:${yn(p.nervonic_acid_taken)}${p.nervonic_acid_missed ? "(miss)" : ""}  NAC:${yn(p.nac_taken)}  ALA:${yn(p.r_ala_taken)}  E:${yn(p.vitamin_e_taken)}`;
    }

    function _protoPassenger(p) {
      if (!p) return "";
      const yn = (b) => (b ? "Y" : "N");
      return `NA:${yn(p.nervonic_acid_taken)}  NAC:${yn(p.nac_taken)}  ALA:${yn(p.r_ala_taken)}  E:${yn(p.vitamin_e_taken)}`;
    }

    function _vitalsLine(v) {
      const fmtBP = (o) => {
        if (!o) return "-";
        const s = o.bp_sys ?? null;
        const d = o.bp_dia ?? null;
        return (s && d) ? `${s}/${d}` : "-";
      };
      const fmtHR = (o) => {
        if (!o) return "-";
        return (o.hr || o.hr === 0) ? String(o.hr) : "-";
      };
      const am = v?.morning;
      const pm = v?.evening;
      return `AM ${fmtBP(am)} HR ${fmtHR(am)}   PM ${fmtBP(pm)} HR ${fmtHR(pm)}`;
    }

    function _appendWrapped(pdf, text, x, y, maxWidth, lineH) {
      const lines = pdf.splitTextToSize(text, maxWidth);
      for (const ln of lines) {
        pdf.text(ln, x, y);
        y += lineH;
      }
      return y;
    }

    async function generatePilotPDF(logs, label, startDate, endDate, dir, patientMeta = {}) {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ unit: "pt", format: "letter" });

      const pageW = pdf.internal.pageSize.getWidth();
      const margin = 36;
      const maxW = pageW - margin * 2;

      // Normalize order for reporting table
      const ordered = [...logs].sort((a,b) => String(a.date||"").localeCompare(String(b.date||"")));
      if (dir === "desc") ordered.reverse();

      // Header
      const pn = (patientMeta?.patientName || '').trim() || 'Patrick Fuellebeck';
      const pdob = (patientMeta?.patientDob || '').trim();
      pdf.setFont("helvetica", "bold");
      pdf.setFontSize(15);
      pdf.text(`AMN Protocol: ${label}`, margin, 48);
      pdf.setFont("helvetica", "normal");
      pdf.setFontSize(10);
      pdf.text(`Patient: ${pn}${pdob ? `   |   DOB: ${pdob}` : ""}`, margin, 64);
      pdf.text(`Range: ${startDate} to ${endDate}   |   Logs: ${ordered.length}   |   Generated: ${new Date().toLocaleDateString()}`, margin, 78);

      let y = 106;

      // Daily Summary header (trend scan)
      pdf.setFont("helvetica", "bold");
      pdf.setFontSize(12);
      pdf.text("Daily Summary (Trend Scan)", margin, y);
      y += 14;
      pdf.setFont("helvetica", "normal");
      pdf.setFontSize(9);
      pdf.text("Baseline status, key symptom scores (0‚Äì10), and contextual drivers for each logged day.", margin, y);
      y += 12;
      pdf.text("Baseline codes: MW W S B MB.  Context codes: SLP EX MEDT DOSE MISS NEW TRV STR1-3 INF GI NONE.", margin, y);
      y += 18;

      // Dense daily matrix header (plain English)
      pdf.setFont("helvetica", "bold");
      pdf.setFontSize(8);
      const xDate = margin;
      const xBase = margin + 56;
      const xEnergy = margin + 92;
      const xPain = margin + 132;
      const xSleep = margin + 168;
      const xGait = margin + 208;
      const xStiff = margin + 252;
      const xFog = margin + 308;
      const xFat = margin + 360;
      const xCtx = margin + 416;
      const xEvt = margin + 520;

      pdf.text("Date", xDate, y);
      pdf.text("Baseline", xBase, y);
      pdf.text("Energy", xEnergy, y);
      pdf.text("Pain", xPain, y);
      pdf.text("Sleep", xSleep, y);
      pdf.text("Gait", xGait, y);
      pdf.text("Stiff", xStiff, y);
      pdf.text("Fog", xFog, y);
      pdf.text("Fatigue", xFat, y);
      pdf.text("Context", xCtx, y);
      pdf.text("Events", xEvt, y);
      pdf.line(margin, y + 4, margin + maxW, y + 4);
      y += 16;

      pdf.setFont("helvetica", "normal");
      pdf.setFontSize(9);

      const appendix = [];

      for (const log of ordered) {
        if (y > 720) { pdf.addPage(); y = 54; }

        const sd = log.symptom_drift || {};
        const pi = log.pain_impact || {};
        const ctx = log.context_changes || {};

        const date = _safeTxt(log.date) || "-";
        const bl = _abbrBaseline(log.baseline_rating);
        const E = (log.energy_capacity ?? "-");
        const P = (pi.severity ?? "-");
        const SL = (sd.sleep_quality ?? "-");
        const G = (sd.gait_effort ?? "-");
        const ST = (sd.leg_stiffness ?? "-");
        const FG = (sd.brain_fog ?? "-");
        const FT = (sd.neurologic_fatigue ?? "-");
        const NMTL = (log.external_neuromuscular_training && typeof log.external_neuromuscular_training.level !== "undefined")
          ? log.external_neuromuscular_training.level
          : null;
        const NMT = (NMTL === 0 || NMTL === 1 || NMTL === 2) ? `NT${NMTL}` : "";
        const CTX = [_ctxCodes(ctx), NMT].filter(Boolean).join(" ");
        const EVT = Array.isArray(log.adverse_events) ? String(log.adverse_events.length) : "0";

        pdf.text(date, xDate, y);
        pdf.text(String(bl), xBase, y);
        pdf.text(String(E), xEnergy, y);
        pdf.text(String(P), xPain, y);
        pdf.text(String(SL), xSleep, y);
        pdf.text(String(G), xGait, y);
        pdf.text(String(ST), xStiff, y);
        pdf.text(String(FG), xFog, y);
        pdf.text(String(FT), xFat, y);
        pdf.text(_safeTxt(CTX).slice(0, 20), xCtx, y);
        pdf.text(EVT, xEvt, y);
        y += 14;

        // Appendix entry (full details)
        appendix.push({
          date,
          protocol: _protoPilot(log.protocol_adherence),
          vitals: _vitalsLine(log.vitals),
          baseline_rating: log.baseline_rating || null,
          baseline_confidence: log.baseline_confidence || null,
          energy_capacity: log.energy_capacity ?? null,
          energy_confidence: log.energy_confidence || null,
          symptom_drift: log.symptom_drift || null,
          pain_impact: log.pain_impact || null,
          context_changes: log.context_changes || null,
          neuromuscular_training_external: (log.external_neuromuscular_training ? {
            label: (log.external_neuromuscular_training.label ?? null),
            level: (typeof log.external_neuromuscular_training.level !== "undefined" ? log.external_neuromuscular_training.level : null)
          } : null),

          wins_today: log.wins_today || null,
          food_notes: log.food_notes || null,
          notes: log.notes || null,
          adverse_events: log.adverse_events || null,
          positive_events: log.positive_events || null,
          lab: (log.lab_date || log.lab_vlcfa || log.lab_liver || log.lab_notes) ? {
            lab_date: log.lab_date || null,
            vlcfa_c26_0: log.lab_vlcfa || null,
            liver_alt_ast: log.lab_liver || null,
            notes: log.lab_notes || null
          } : null
        });
      }

      // Appendix
      pdf.addPage();
      pdf.setFont("helvetica", "bold");
      pdf.setFontSize(13);
      pdf.text("Notes Appendix (Full Details)", margin, 54);
      pdf.setFont("helvetica", "normal");
      pdf.setFontSize(9);
      y = 78;

      for (const a of appendix) {
        if (y > 720) { pdf.addPage(); y = 54; }
        pdf.setFont("helvetica", "bold");
        pdf.text(a.date, margin, y);
        pdf.setFont("helvetica", "normal");
        y += 14;

        const blocks = [];
        if (a.protocol) blocks.push(`Protocol: ${a.protocol}`);
        if (a.vitals) blocks.push(`Vitals: ${a.vitals}`);
        if (a.baseline_rating || a.baseline_confidence) blocks.push(`Baseline: ${_safeTxt(a.baseline_rating)}  (conf: ${_safeTxt(a.baseline_confidence) || "-"})`);
        if (a.energy_capacity !== null || a.energy_confidence) blocks.push(`Energy: ${a.energy_capacity ?? "-"}/10  (conf: ${_safeTxt(a.energy_confidence) || "-"})`);
        if (a.symptom_drift) blocks.push(`Symptom drift: ${_safeTxt(JSON.stringify(a.symptom_drift))}`);
        if (a.pain_impact) blocks.push(`Pain impact: ${_safeTxt(JSON.stringify(a.pain_impact))}`);
        if (a.context_changes) blocks.push(`Context: ${_safeTxt(JSON.stringify(a.context_changes))}`);
        if (a.neuromuscular_training_external) blocks.push(`Neuromuscular training (external): ${_safeTxt(a.neuromuscular_training_external.label)} (level: ${a.neuromuscular_training_external.level ?? '-'})`);
        if (a.wins_today) blocks.push(`Wins: ${_safeTxt(a.wins_today)}`);
        if (a.food_notes) blocks.push(`Food: ${_safeTxt(a.food_notes)}`);
        if (a.notes) blocks.push(`Notes: ${_safeTxt(a.notes)}`);
        if (a.lab) blocks.push(`Lab: ${_safeTxt(JSON.stringify(a.lab))}`);

        // Events
        if (Array.isArray(a.adverse_events) && a.adverse_events.length) {
          const ev = a.adverse_events.map(e => `- ${_safeTxt(e?.description || "")} (${_safeTxt(e?.time_of_day || "")}${e?.duration_minutes ? `, ${e.duration_minutes}m` : ""}${e?.suspected_driver ? `, driver: ${_safeTxt(e.suspected_driver)}` : ""})`).join(" | ");
          blocks.push(`Adverse events: ${ev}`);
        }
        if (Array.isArray(a.positive_events) && a.positive_events.length) {
          const ev = a.positive_events.map(e => `- ${_safeTxt(e?.description || "")} (${_safeTxt(e?.time_of_day || "")}${e?.duration_minutes ? `, ${e.duration_minutes}m` : ""}${e?.suspected_driver ? `, driver: ${_safeTxt(e.suspected_driver)}` : ""})`).join(" | ");
          blocks.push(`Positive events: ${ev}`);
        }

        for (const b of blocks) {
          if (y > 720) { pdf.addPage(); y = 54; }
          y = _appendWrapped(pdf, b, margin, y, maxW, 12);
        }
        y += 10;
        pdf.setDrawColor(200);
        pdf.line(margin, y, margin + maxW, y);
        y += 14;
      }

      pdf.save(`Pilot_${startDate}_to_${endDate}.pdf`);
    }

    async function generatePassengerPDF(logs, label, startDate, endDate, dir, patientMeta = {}) {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ unit: "pt", format: "letter" });

      const pageW = pdf.internal.pageSize.getWidth();
      const margin = 36;
      const maxW = pageW - margin * 2;

      const ordered = [...logs].sort((a,b) => String(a.date||"").localeCompare(String(b.date||"")));
      if (dir === "desc") ordered.reverse();

      pdf.setFont("helvetica", "bold");
      pdf.setFontSize(15);
      pdf.text(`AMN Protocol: ${label}`, margin, 48);
      pdf.setFont("helvetica", "normal");
      pdf.setFontSize(10);
      const pn = (patientMeta?.patientName || '').trim() || (label === 'Passenger' ? 'Nieve' : '');
      const pdob = (patientMeta?.patientDob || '').trim();
      if (pn) pdf.text(`Patient: ${pn}${pdob ? `   |   DOB: ${pdob}` : ""}`, margin, 64);
      pdf.text(`Range: ${startDate} to ${endDate}   |   Logs: ${ordered.length}   |   Generated: ${new Date().toLocaleDateString()}`, margin, pn ? 78 : 64);

      let y = pn ? 106 : 92;
      pdf.setFont("helvetica", "bold");
      pdf.setFontSize(9);
      pdf.text("DATE", margin, y);
      pdf.text("PROTO", margin + 90, y);
      pdf.text("SAFETY", margin + 270, y);
      pdf.line(margin, y + 4, margin + maxW, y + 4);
      y += 18;

      pdf.setFont("helvetica", "normal");
      pdf.setFontSize(9);

      const appendix = [];

      for (const log of ordered) {
        if (y > 720) { pdf.addPage(); y = 54; }
        const date = _safeTxt(log.date) || "-";
        const proto = _protoPassenger(log.protocol_adherence);
        const safety = log.safety?.feels_different ? "FEELS DIFFERENT" : "Normal";
        pdf.text(date, margin, y);
        pdf.text(_safeTxt(proto).slice(0, 28), margin + 90, y);
        pdf.text(safety, margin + 270, y);
        y += 14;

        appendix.push({
          date,
          protocol: proto,
          safety: log.safety || null,
          notes: log.notes || null
        });
      }

      // Appendix
      pdf.addPage();
      pdf.setFont("helvetica", "bold");
      pdf.setFontSize(13);
      pdf.text("Notes Appendix (Full Details)", margin, 54);
      pdf.setFont("helvetica", "normal");
      pdf.setFontSize(9);
      y = 78;

      for (const a of appendix) {
        if (y > 720) { pdf.addPage(); y = 54; }
        pdf.setFont("helvetica", "bold");
        pdf.text(a.date, margin, y);
        pdf.setFont("helvetica", "normal");
        y += 14;
        if (a.protocol) y = _appendWrapped(pdf, `Protocol: ${a.protocol}`, margin, y, maxW, 12);
        if (a.safety) y = _appendWrapped(pdf, `Safety: ${_safeTxt(JSON.stringify(a.safety))}`, margin, y, maxW, 12);
        if (a.notes) y = _appendWrapped(pdf, `Notes: ${_safeTxt(a.notes)}`, margin, y, maxW, 12);
        y += 10;
        pdf.setDrawColor(200);
        pdf.line(margin, y, margin + maxW, y);
        y += 14;
      }

      pdf.save(`Passenger_${startDate}_to_${endDate}.pdf`);
    }

    // Expose a single export runner to the non-module modal UI
    window.__EXPORT_RUN = async function({ patientId, label, start, end, dir, patientName, patientDob }) {
      const logs = await fetchPatientLogsInRange(patientId, start, end, dir);
      if (patientId === "patrick") {
        await generatePilotPDF(logs, label || "Pilot", start, end, dir, { patientName, patientDob });
      } else {
        await generatePassengerPDF(logs, label || "Passenger", start, end, dir, { patientName, patientDob });
      }
    };

    function setBtn(btnId, busy, text) {
      const b = el(btnId);
      if (!b) return;
      b.disabled = !!busy;
      if (text) b.textContent = text;
    }

    // Inline onclick targets

    window.setNeuromuscularTraining = function(level, label) {
      const lvl = (typeof level === "number") ? level : parseInt(level, 10);
      const lab = String(label || "").toLowerCase();
      const allowed = { 0: "none", 1: "light", 2: "full" };
      const finalLevel = (lvl in allowed) ? lvl : 0;
      const finalLabel = allowed[finalLevel];

      const lvlEl = byId("p-nmt-level");
      const labEl = byId("p-nmt-label");
      if (lvlEl) lvlEl.value = String(finalLevel);
      if (labEl) labEl.value = finalLabel;

      [0,1,2].forEach(i => {
        const b = byId(`p-nmt-btn-${i}`);
        if (!b) return;
        if (i === finalLevel) b.classList.add("active");
        else b.classList.remove("active");
      });
    };


    window.handlePilotSave = async function() {
      setBtn("p-save-log", true, "SAVING...");
      try {
        await saveUserLog("patrick", collectPilotPayload());
        setBtn("p-save-log", false, "SAVED ‚úì");
        setTimeout(() => setBtn("p-save-log", false, "SAVE DAILY LOG"), 1200);
      } catch(e) {
        console.error(e);
        setBtn("p-save-log", false, "SAVE FAILED");
        // Improved error alert
        alert("Save failed: " + (e.message || e) + "\n\n(If this says 'Missing or insufficient permissions', your database rules block non-logged-in users.)");
      }
    };

    function collectFunctionalTestPayload() {
      const testDate = trimText(val("ft-date")) || localDateStr();
      return {
        test_date: testDate,
        six_minute_walk: {
          distance_m: asNumber(val("ft-6m-distance")),
          rest_breaks_count: asNumber(val("ft-6m-restbreaks")),
          assistive_device: trimText(val("ft-6m-device")) || null,
          course_length_m: asNumber(val("ft-6m-course")),
          perceived_exertion: asNumber(val("ft-6m-rpe"))
        },
        sit_to_stand_5x: {
          time_seconds: asNumber(val("ft-5x-time")),
          used_arms: mustEnum(val("ft-5x-arms"), ["yes","no"], null),
          chair_height_cm: asNumber(val("ft-5x-chair"))
        },
        notes: trimText(val("ft-notes")) || null
      };
    }

    window.saveFunctionalTest = async function() {
      const btns = document.querySelectorAll('[onclick="window.saveFunctionalTest()"]');
      btns.forEach(b => { try { b.disabled = true; b.textContent = "SAVING..."; } catch(e){} });

      try {
        const payload = collectFunctionalTestPayload();
        // Path: users/patrick/tests/{id}
        const id = `${payload.test_date}_${Date.now()}`;
        const ref = db.doc(userProfilePath("patrick", "tests", id));
        
        await ref.set({ ...payload, createdAt: firebase.firestore.FieldValue.serverTimestamp(), clientCreatedAt: new Date().toISOString() }, { merge: true });
        btns.forEach(b => { try { b.textContent = "SAVED ‚úì"; } catch(e){} });
        setTimeout(() => btns.forEach(b => { try { b.disabled = false; b.textContent = "SAVE FUNCTIONAL TEST"; } catch(e){} }), 1400);
      } catch (e) {
        console.error(e);
        btns.forEach(b => { try { b.disabled = false; b.textContent = "SAVE FUNCTIONAL TEST"; } catch(e){} });
        alert("Functional test save failed: " + (e.message || e));
      }
    };

    window.handlePassengerSave = async function() {
      setBtn("n-save-log", true, "SAVING...");
      try {
        await saveUserLog("nieve", collectPassengerPayload());
        setBtn("n-save-log", false, "SAVED ‚úì");
        setTimeout(() => setBtn("n-save-log", false, "SAVE DAILY LOG"), 1200);
      } catch(e) {
        console.error(e);
        setBtn("n-save-log", false, "SAVE FAILED");
        alert("Save failed: " + (e.message || e) + "\n\n(If this says 'Missing or insufficient permissions', your database rules block non-logged-in users.)");
      }
    };

    window.handlePassengerSafety = async function() {
      // Save safety report as part of the daily log (same doc)
      await window.handlePassengerSave();
    };

    window.handleLabSave = async function() {
      setBtn("lab-save-results-btn", true, "SAVING...");
      try {
        await saveUserLog("patrick", collectLabPayload());
        setBtn("lab-save-results-btn", false, "SAVED ‚úì");
        setTimeout(() => setBtn("lab-save-results-btn", false, "SAVE LAB RESULTS ONLY"), 1600);
      } catch(e) {
        console.error(e);
        setBtn("lab-save-results-btn", false, "SAVE LAB RESULTS ONLY");
        alert("Lab save failed: " + (e.message || e));
      }
    };

    window.showTrendsTab = function(which) {
      const sum = el("trends-summary-pane");
      const charts = el("trends-charts-pane");
      const details = el("trends-details-pane");

      const t1 = el("tab-summary");
      const t2 = el("tab-charts");
      const t3 = el("tab-details");

      if (!sum || !charts || !t1 || !t2) return;

      const hasDetails = !!details && !!t3;

      // hide panes
      sum.style.display = "none";
      charts.style.display = "none";
      if (hasDetails) details.style.display = "none";

      // reset active tabs
      t1.classList.remove("active");
      t2.classList.remove("active");
      if (hasDetails) t3.classList.remove("active");

      if (which === "charts") {
        charts.style.display = "block";
        t2.classList.add("active");
        if (typeof window.renderTrendsCharts === "function") window.renderTrendsCharts();
        return;
      }

      if (which === "details" && hasDetails) {
        details.style.display = "block";
        t3.classList.add("active");
        if (typeof window.renderTrendsDetails === "function") window.renderTrendsDetails();
        return;
      }

      // summary default
      sum.style.display = "block";
      t1.classList.add("active");
    };

    // Basic trends rendering (safe/no-crash)
    let _globalChart = null;

    window.renderTrends = async function() {
      // lightweight summary text only (avoid blocking UI)
      try {
        const logs = await fetchPatientLogs("patrick", 30);
        const elSum = el("change-summary");
        if (!elSum) return;

        const withRating = logs.filter(l => !!l.baseline_rating);
        const total = logs.length;
        const rated = withRating.length;

        // simple counts
        const counts = { much_worse:0, worse:0, same:0, better:0, much_better:0 };
        withRating.forEach(l => { if (counts[l.baseline_rating] !== undefined) counts[l.baseline_rating]++; });

        elSum.innerHTML = `
          <div>Last 30 days: <strong>${total}</strong> logs found. Baseline rating recorded on <strong>${rated}</strong> days.</div>
          <div style="margin-top:10px;">
            much better: ${counts.much_better} ‚Ä¢ better: ${counts.better} ‚Ä¢ same: ${counts.same} ‚Ä¢ worse: ${counts.worse} ‚Ä¢ much worse: ${counts.much_worse}
          </div>
          <div style="margin-top:10px; color: var(--text-secondary); font-size: 0.85rem;">
            Note: This is descriptive only. It does not adjust for confounders or missing data.
          </div>
        `;
      } catch(e) {
        console.error(e);
      }
    };

    window._trendCharts = window._trendCharts || {};

    function _destroyTrendChart(key){
      try{
        if(window._trendCharts[key]){
          window._trendCharts[key].destroy();
          delete window._trendCharts[key];
        }
      }catch(e){}
    }

    function _buildLineChart(canvasId, labels, data, yMin, yMax, seriesLabel){
      const canvas = document.getElementById(canvasId);
      if(!canvas) return;
      const ctx = canvas.getContext("2d");
      _destroyTrendChart(canvasId);

      // If there is no data at all, show an empty chart frame (Chart.js handles nulls)
      window._trendCharts[canvasId] = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: seriesLabel,
            data,
            tension: 0.25,
            spanGaps: false,
            pointRadius: 3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: true } },
          scales: {
            y: {
              min: yMin,
              max: yMax,
              ticks: { stepSize: 1 }
            },
            x: {
              ticks: { maxRotation: 0, autoSkip: true }
            }
          }
        }
      });
    }

    function _mapBaselineTo15(v){
      if(v == null) return null;
      if(typeof v === "number") return v; // already 1‚Äì5
      const s = String(v).toLowerCase();
      if(s === "much_worse") return 1;
      if(s === "worse") return 2;
      if(s === "same") return 3;
      if(s === "better") return 4;
      if(s === "much_better") return 5;
      // fallback for earlier variants
      if(s.includes("much") && s.includes("worse")) return 1;
      if(s.includes("worse")) return 2;
      if(s.includes("same")) return 3;
      if(s.includes("better") && s.includes("much")) return 5;
      if(s.includes("better")) return 4;
      return null;
    }

    function _num(v){
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    }

    function _getPainSeverity(log){
      // supports either pain_impact: {severity: ...} or painImpactSeverity or pain_severity
      if(log && log.pain_impact && log.pain_impact.severity != null) return _num(log.pain_impact.severity);
      if(log && log.painImpactSeverity != null) return _num(log.painImpactSeverity);
      if(log && log.pain_severity != null) return _num(log.pain_severity);
      return null;
    }

    function _getSymptom(log, key){
      // symptom_drift: {brain_fog:..., leg_stiffness:...} OR flat keys
      if(log && log.symptom_drift && log.symptom_drift[key] != null) return _num(log.symptom_drift[key]);
      if(log && log[key] != null) return _num(log[key]);
      return null;
    }

    window.renderTrendsCharts = async function() {
      try {
        const logs = await fetchPatientLogs("patrick", 30);
        const ordered = [...logs].sort((a,b) => String(a.date||"").localeCompare(String(b.date||"")));
        const labels = ordered.map(l => l.date || "");

        // Build datasets (use null for missing values so lines break rather than lie)
        const global = ordered.map(l => _mapBaselineTo15(l.baseline_rating));
        const energy = ordered.map(l => _num(l.energy_capacity));
        const pain = ordered.map(l => _getPainSeverity(l));
        const sleep = ordered.map(l => _getSymptom(l, "sleep_quality"));
        const gaitEffort = ordered.map(l => _getSymptom(l, "gait_effort"));
        const legStiffness = ordered.map(l => _getSymptom(l, "leg_stiffness"));
        const brainFog = ordered.map(l => _getSymptom(l, "brain_fog"));
        const neuroFatigue = ordered.map(l => _getSymptom(l, "neurologic_fatigue"));

        // Charts
        _buildLineChart("chart-global", labels, global, 1, 5, "Global baseline (1‚Äì5)");
        _buildLineChart("chart-energy", labels, energy, 0, 10, "Energy / Capacity (0‚Äì10)");
        _buildLineChart("chart-pain", labels, pain, 0, 10, "Pain impact (0‚Äì10)");
        _buildLineChart("chart-sleep", labels, sleep, 0, 10, "Sleep quality (0‚Äì10)");
        _buildLineChart("chart-gait-effort", labels, gaitEffort, 0, 10, "Gait effort (0‚Äì10)");
        _buildLineChart("chart-leg-stiffness", labels, legStiffness, 0, 10, "Leg stiffness (0‚Äì10)");
        _buildLineChart("chart-brain-fog", labels, brainFog, 0, 10, "Brain fog (0‚Äì10)");
        _buildLineChart("chart-neuro-fatigue", labels, neuroFatigue, 0, 10, "Neurologic fatigue (0‚Äì10)");

        // If the tab was opened while hidden, force a resize after layout settles.
        setTimeout(() => {
          Object.values(window._trendCharts).forEach(ch => { try{ ch.resize(); }catch(e){} });
        }, 50);
      } catch (err) {
        console.warn("renderTrendsCharts failed:", err);
      }
    };

    window.renderTrendsDetails = async function() {
      const host = el("trends-details-content");
      if (!host) return;

      const logs = await fetchPatientLogs("patrick", 365); // pilot history (same collection used in Trends)
      const rows = [];

      function pushMetric(key, label, getter) {
        const vals = [];
        for (const l of logs) {
          const v = getter(l);
          if (v === null || v === undefined || v === "") continue;
          const n = Number(v);
          if (!Number.isFinite(n)) continue;
          vals.push({ date: l.date, v: n });
        }
        if (vals.length === 0) return;
        vals.sort((a,b)=> String(a.date).localeCompare(String(b.date)));
        const ns = vals.map(x=>x.v);
        const sum = ns.reduce((a,b)=>a+b,0);
        const mean = sum / ns.length;
        const min = Math.min(...ns);
        const max = Math.max(...ns);
        const last = vals[vals.length-1];
        rows.push({ key, label, n: ns.length, mean, min, max, lastDate: last.date, last: last.v });
      }

      // These keys match the saved pilot log schema in this build (snake_case).
      pushMetric("baseline_rating", "Global Baseline Rating (1‚Äì5)", l => _mapBaselineTo15(l.baseline_rating));
      pushMetric("energy_capacity", "Energy / Capacity (0‚Äì10)", l => l.energy_capacity);
      pushMetric("pain_impact", "Pain Impact (0‚Äì10)", l => (l.pain_impact ? l.pain_impact.severity : null));
      pushMetric("sleep_quality", "Sleep Quality (0‚Äì10)", l => (l.symptom_drift ? l.symptom_drift.sleep_quality : null));

      // Symptom Drift sliders
      pushMetric("brain_fog", "Brain Fog (0‚Äì10)", l => (l.symptom_drift ? l.symptom_drift.brain_fog : null));
      pushMetric("gait_effort", "Gait Effort (0‚Äì10)", l => (l.symptom_drift ? l.symptom_drift.gait_effort : null));
      pushMetric("gait_initiation", "Gait initiation effort (0‚Äì10)", l => (l.symptom_drift ? l.symptom_drift.gait_initiation : null));
      pushMetric("sustained_walking", "Sustained walking effort (0‚Äì10)", l => (l.symptom_drift ? l.symptom_drift.sustained_walking : null));
      pushMetric("neurologic_fatigue", "Neurologic fatigue (0‚Äì10)", l => (l.symptom_drift ? l.symptom_drift.neurologic_fatigue : null));
      pushMetric("leg_stiffness", "Leg Stiffness (0‚Äì10)", l => (l.symptom_drift ? l.symptom_drift.leg_stiffness : null));
      pushMetric("post_rest_stiffness", "Post-rest stiffness (0‚Äì10)", l => (l.symptom_drift ? l.symptom_drift.post_rest_stiffness : null));
      pushMetric("symptom_volatility", "Symptom volatility (0‚Äì10)", l => (l.symptom_drift ? l.symptom_drift.symptom_volatility : null));

      if (rows.length === 0) {
        host.innerHTML = '<div class="muted">No numeric trend data found yet. Add a few daily logs first.</div>';
        return;
      }

      const html = rows.map(r => {
        const mean = (Math.round(r.mean*10)/10).toFixed(1);
        return `
          <div class="row" style="padding:10px 0; border-bottom:1px solid rgba(255,255,255,.08);">
            <div style="font-weight:700;">${r.label}</div>
            <div class="muted" style="margin-top:6px;">
              N=${r.n} ‚Ä¢ mean ${mean} ‚Ä¢ min ${r.min} ‚Ä¢ max ${r.max} ‚Ä¢ last ${r.last} (${r.lastDate})
            </div>
          </div>`;
      }).join("");

      host.innerHTML = `<div>${html}</div>`;
    };

    document.addEventListener("DOMContentLoaded", () => {
      // prime slider visuals
      Array.from(document.querySelectorAll('input[type="range"]')).forEach(r => window.updateSlider(r));
      // confounder accordion
      const pharm = document.getElementById('p-conf-pharm');
      const panel = document.getElementById('p-conf-pharm-panel');
      if (pharm && panel) {
        const sync = () => panel.style.display = pharm.checked ? 'block' : 'none';
        pharm.addEventListener('change', sync);
        sync();
      }

    });

    // Close the Firebase-available branch opened earlier.
    }
  </script>

<script>
</script>
<script>
</script>
<script>
// Scroll hint toggle: show hint at top, hide after user scrolls (dev-modal)
(function () {
  const modal = document.getElementById('dev-modal');
  if (!modal) return;

  const modalBody = modal.querySelector('.modal-body');
  if (!modalBody) return;

  const update = () => {
    const canScroll = modalBody.scrollHeight > modalBody.clientHeight + 8;
    const atTop = modalBody.scrollTop <= 2;

    if (!canScroll) {
      modalBody.classList.add('scroll-hint-hidden');
      return;
    }
    if (atTop) modalBody.classList.remove('scroll-hint-hidden');
    else modalBody.classList.add('scroll-hint-hidden');
  };

  update();
  modalBody.addEventListener('scroll', update, { passive: true });

  const obs = new MutationObserver(update);
  obs.observe(modal, { attributes: true, attributeFilter: ['style', 'class'] });
})();

</script>
<script>
// Lock background scroll when dev-modal is open
(function () {
  const modal = document.getElementById('dev-modal');
  if (!modal) return;

  const updateLock = () => {
    const display = window.getComputedStyle(modal).display;
    const isVisible = display !== 'none';
    if (isVisible) document.body.classList.add('modal-open');
    else document.body.classList.remove('modal-open');
  };

  const observer = new MutationObserver(updateLock);
  observer.observe(modal, { attributes: true, attributeFilter: ['style', 'class'] });

  updateLock();
})();

</script>
</body>
</html>
